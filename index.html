<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢†åœ°ç»è¥çŠ¶æ€é¢æ¿</title>
    
    <!-- ä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <style>
        /* é‡ç½®æ ·å¼ï¼Œç¡®ä¿é€‚åº” SillyTavern å®¹å™¨ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        /* ä¸»å®¹å™¨ - å…¨å±æ˜¾ç¤º */
        #app {
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* é¢†åœ°ä»ªè¡¨æ¿ - å›ºå®šé«˜åº¦å®¹å™¨ */
        .territory-dashboard {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            margin: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            max-height: calc(100vh - 20px);
        }
        
        /* å·¥å…·æ  */
        .dashboard-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toolbar-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .dashboard-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .update-time {
            font-size: 12px;
            opacity: 0.8;
            color: #bdc3c7;
        }
        
        .toolbar-right {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-refresh {
            background: #3498db;
            color: white;
        }
        
        .btn-refresh:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-settlement {
            background: #2ecc71;
            color: white;
        }
        
        .btn-settlement:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ - å¯æ»šåŠ¨ */
        .dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        /* ç§»é™¤åŸä»£ç ä¸­å¯èƒ½å†²çªçš„ max-width é™åˆ¶ */
        .territory-dashboard {
            max-width: none !important;
        }
        
        /* é”™è¯¯å’ŒåŠ è½½çŠ¶æ€ */
        .error-alert {
            margin: 15px;
            padding: 12px;
            background: #e74c3c;
            color: white;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 100;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æŒ‡æ ‡å¡ç‰‡ç½‘æ ¼ */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .data-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .data-card.size-large {
            grid-column: span 2;
        }
        
        .data-card.size-medium {
            grid-column: span 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .card-icon {
            font-size: 20px;
        }
        
        .card-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        
        .card-value .unit {
            font-size: 14px;
            font-weight: normal;
            color: #7f8c8d;
        }
        
        .card-value .trend {
            margin-left: 8px;
            font-size: 16px;
        }
        
        /* é¢æ¿å¸ƒå±€ - å“åº”å¼ */
        .panels-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 1200px) {
            .panels-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .panels-row {
                grid-template-columns: 1fr;
            }
            
            .metrics-row {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        
        .panel-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* å¯æŠ˜å é¢æ¿ */
        .collapsible-panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.3s;
            user-select: none;
        }
        
        .panel-header:hover {
            background: #e9ecef;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-icon {
            font-size: 16px;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 15px;
            color: #2c3e50;
        }
        
        .toggle-arrow {
            transition: transform 0.3s;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .toggle-arrow.open {
            transform: rotate(180deg);
        }
        
        .panel-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* ä¿¡æ¯ç½‘æ ¼ */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-label {
            font-weight: 500;
            color: #666;
            font-size: 13px;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 13px;
        }
        
        /* åº•éƒ¨çŠ¶æ€æ  */
        .dashboard-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #7f8c8d;
            flex-shrink: 0;
        }
        
        .footer-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .refresh-link {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .refresh-link:hover {
            color: #2980b9;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* èµ„æºç½‘æ ¼ */
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .resource-item {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        
        .resource-name {
            display: block;
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        
        .resource-amount {
            font-size: 16px;
            font-weight: bold;
            color: #3498db;
        }
        
        /* ç»æµç»Ÿè®¡ */
        .economy-stats {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }
        
        .stat-label {
            font-weight: 500;
            font-size: 13px;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 14px;
        }
        
        .stat-value.income {
            color: #27ae60;
        }
        
        .stat-value.expense {
            color: #e74c3c;
        }
        
        .stat-value.treasury {
            color: #f39c12;
        }
        
        /* å»ºç­‘ç½‘æ ¼ */
        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .building-item {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            background: #fafafa;
        }
        
        .building-item.normal {
            border-left: 3px solid #27ae60;
        }
        
        .building-item.constructing {
            border-left: 3px solid #f39c12;
        }
        
        .building-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .building-name {
            font-weight: 500;
            font-size: 13px;
        }
        
        .building-level {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        /* ç§æ—ç½‘æ ¼ */
        .races-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .race-item {
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #fafafa;
        }
        
        .race-name {
            font-weight: 500;
            font-size: 12px;
        }
        
        .race-count {
            font-size: 14px;
            color: #3498db;
        }
        
        .race-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            text-align: center;
        }
        
        .race-status.status-ä¸»å¯¼ {
            background: #d4edda;
            color: #155724;
        }
        
        .race-status.status-å¹³ç­‰ {
            background: #cce5ff;
            color: #004085;
        }
        
        .race-status.status-å—é™åˆ¶ {
            background: #fff3cd;
            color: #856404;
        }
        
        .race-status.status-å¥´éš¶ {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* å†›äº‹ç»Ÿè®¡ */
        .military-stats {
            display: grid;
            gap: 8px;
        }
        
        .military-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #e74c3c;
        }
        
        .military-label {
            font-weight: 500;
            font-size: 13px;
            color: #666;
        }
        
        .military-value {
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin: 8px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .progress-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // ç®€åŒ–ç‰ˆ Vue åº”ç”¨
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        
        const app = createApp({
            setup() {
                // çŠ¶æ€
                const loading = ref(true);
                const error = ref(null);
                const lastUpdate = ref(null);
                const territoryData = ref(null);
                
                // æ¨¡æ‹Ÿæ•°æ®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
                const mockData = {
                    åŸºæœ¬ä¿¡æ¯: {
                        åç§°: "åŒ—å¢ƒè¾¹å¢ƒé¢†",
                        é¢ç§¯: 85,
                        åœ°å½¢: "ä¸˜é™µä¸æ£®æ—",
                        å‘å±•é˜¶æ®µ: "åˆå»º"
                    },
                    äººå£: {
                        æ€»äººå£: 1250,
                        èŒä¸šåˆ†å¸ƒ: {
                            å†œæ°‘: { äººæ•°: 700 },
                            å·¥åŒ : { äººæ•°: 120 },
                            å•†äºº: { äººæ•°: 60 },
                            å®˜å‘˜: { äººæ•°: 15 },
                            å£«å…µ: { äººæ•°: 80 },
                            æ— ä¸š: { äººæ•°: 275 }
                        },
                        ç§æ—æ„æˆ: {
                            äººç±»: { æ•°é‡: 900, åœ°ä½: "ä¸»å¯¼" },
                            çŸ®äºº: { æ•°é‡: 150, åœ°ä½: "å¹³ç­‰" },
                            åŠç²¾çµ: { æ•°é‡: 100, åœ°ä½: "å¹³ç­‰" },
                            å“¥å¸ƒæ—: { æ•°é‡: 50, åœ°ä½: "å¥´éš¶" }
                        }
                    },
                    ç»æµ: {
                        è´¢æ”¿: {
                            åº“å­˜é‡‘å¸: 2500,
                            æœˆæ€»æ”¶å…¥: 1850,
                            æœˆæ€»æ”¯å‡º: 1670,
                            æœˆå‡€æ”¶å…¥: 180
                        },
                        å…¬å…±ç¨ç‡: {
                            å†œä¸šç¨: 0.10,
                            å•†ä¸šç¨: 0.15,
                            å·¥ä¸šç¨: 0.12
                        }
                    },
                    ä»“åº“: {
                        res_food_grain: {
                            åç§°: "ç²®é£Ÿ",
                            å½“å‰å‚¨é‡: 6500,
                            å®‰å…¨å‚¨é‡: 3750,
                            å•ä½: "æ‹…"
                        },
                        res_material_wood: {
                            åç§°: "æœ¨æ",
                            å½“å‰å‚¨é‡: 900,
                            å®‰å…¨å‚¨é‡: 300,
                            å•ä½: "æ–¹"
                        },
                        res_material_stone: {
                            åç§°: "çŸ³æ",
                            å½“å‰å‚¨é‡: 500,
                            å®‰å…¨å‚¨é‡: 200,
                            å•ä½: "æ–¹"
                        },
                        res_material_iron: {
                            åç§°: "é“çŸ¿",
                            å½“å‰å‚¨é‡: 300,
                            å®‰å…¨å‚¨é‡: 100,
                            å•ä½: "æ–¤"
                        }
                    },
                    å†›äº‹: {
                        å…µåŠ›: {
                            å¸¸å¤‡å†›: 80,
                            æ°‘å…µ: 200,
                            ç²¾é”éƒ¨é˜Ÿ: 0
                        },
                        æˆ˜åŠ›è¯„çº§: {
                            æ€»è¯„çº§: "D"
                        },
                        é˜²å¾¡è®¾æ–½: {
                            åŸå¢™å®Œæ•´åº¦: 0.7,
                            ç­æœ›å¡”æ•°é‡: 2
                        }
                    },
                    çŠ¶æ€: {
                        å±…æ°‘çŠ¶æ€: {
                            ç”Ÿæ´»æ°´å¹³: "æ¸©é¥±",
                            æ²»å®‰çŠ¶å†µ: 65,
                            æ°‘å¿ƒæŒ‡æ•°: 70,
                            å½“å‰äº‹ä»¶: "æš‚æ— ",
                            å¨èƒç­‰çº§: "è­¦æˆ’"
                        }
                    },
                    ç§‘æŠ€: {
                        tech_basic_agriculture: {
                            åç§°: "åŸºç¡€å†œä¸šæŠ€æœ¯",
                            ç ”å‘çŠ¶æ€: ["å·²ç ”å‘"],
                            å½“å‰è¿›åº¦: 100
                        },
                        tech_iron_smelting: {
                            åç§°: "é“å™¨å†¶ç‚¼æŠ€æœ¯",
                            ç ”å‘çŠ¶æ€: ["ç ”å‘ä¸­"],
                            å½“å‰è¿›åº¦: 45
                        },
                        tech_basic_military_tactics: {
                            åç§°: "åŸºç¡€å†›äº‹æˆ˜æœ¯",
                            ç ”å‘çŠ¶æ€: ["æœªç ”å‘"],
                            å½“å‰è¿›åº¦: 0
                        }
                    },
                    å»ºç­‘: {
                        building_residential: {
                            åç§°: "å±…æ°‘åŒº",
                            ç­‰çº§: 2,
                            çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                            å²—ä½: { å½“å‰äººæ•°: 0, æœ€å¤§äººæ•°: 0 }
                        },
                        building_market: {
                            åç§°: "å¸‚åœº",
                            ç­‰çº§: 2,
                            çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                            å²—ä½: { å½“å‰äººæ•°: 25, æœ€å¤§äººæ•°: 40 },
                            äº§æƒ: "lord"
                        },
                        building_blacksmith: {
                            åç§°: "é“åŒ é“º",
                            ç­‰çº§: 1,
                            çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                            å²—ä½: { å½“å‰äººæ•°: 4, æœ€å¤§äººæ•°: 8 },
                            äº§æƒ: "private"
                        },
                        building_watchtower: {
                            åç§°: "åŒ—å¢ƒç­æœ›å¡”",
                            ç­‰çº§: 1,
                            çŠ¶æ€: ["å»ºè®¾ä¸­"],
                            å²—ä½: { å½“å‰äººæ•°: 0, æœ€å¤§äººæ•°: 5 },
                            äº§æƒ: "lord"
                        }
                    }
                };
                
                // è®¡ç®—å±æ€§
                const basicInfo = computed(() => territoryData.value?.åŸºæœ¬ä¿¡æ¯ || {});
                const population = computed(() => territoryData.value?.äººå£ || {});
                const economy = computed(() => territoryData.value?.ç»æµ || {});
                const warehouse = computed(() => territoryData.value?.ä»“åº“ || {});
                const military = computed(() => territoryData.value?.å†›äº‹ || {});
                const residents = computed(() => territoryData.value?.çŠ¶æ€?.å±…æ°‘çŠ¶æ€ || {});
                const tech = computed(() => territoryData.value?.ç§‘æŠ€ || {});
                const buildings = computed(() => territoryData.value?.å»ºç­‘ || {});
                
                const totalPopulation = computed(() => population.value?.æ€»äººå£ || 0);
                const races = computed(() => population.value?.ç§æ—æ„æˆ || {});
                
                // è®¡ç®—æ”¶æ”¯çŠ¶æ€
                const balanceStatus = computed(() => {
                    const income = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ || 0;
                    const expense = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¯å‡º || 0;
                    const net = income - expense;
                    
                    if (net > 0) return { text: 'ç›ˆä½™', icon: 'ğŸ“ˆ', color: '#27ae60' };
                    if (net < 0) return { text: 'äºæŸ', icon: 'ğŸ“‰', color: '#e74c3c' };
                    return { text: 'å¹³è¡¡', icon: 'âš–ï¸', color: '#f39c12' };
                });
                
                // è®¡ç®—å¨èƒç­‰çº§é¢œè‰²
                const threatColor = computed(() => {
                    const threat = residents.value?.å¨èƒç­‰çº§;
                    switch(threat) {
                        case 'å®‰å…¨': return '#27ae60';
                        case 'è­¦æˆ’': return '#f39c12';
                        case 'å±é™©': return '#e74c3c';
                        case 'æå±é™©': return '#9b59b6';
                        default: return '#7f8c8d';
                    }
                });
                
                // è·å–æ•°æ®
                async function fetchData() {
                    try {
                        loading.value = true;
                        
                        // å°è¯•ä» SillyTavern è·å–æ•°æ®
                        // æ–¹æ³•1: æ£€æŸ¥å…¨å±€å˜é‡
                        if (window.territoryData) {
                            territoryData.value = window.territoryData;
                        }
                        // æ–¹æ³•2: æ£€æŸ¥ localStorage
                        else if (localStorage.getItem('territoryData')) {
                            territoryData.value = JSON.parse(localStorage.getItem('territoryData'));
                        }
                        // æ–¹æ³•3: æ£€æŸ¥ URL å‚æ•°
                        else if (window.location.search.includes('territoryData')) {
                            const params = new URLSearchParams(window.location.search);
                            const dataStr = params.get('territoryData');
                            if (dataStr) {
                                territoryData.value = JSON.parse(decodeURIComponent(dataStr));
                            }
                        }
                        // æ–¹æ³•4: ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        else {
                            console.log('æœªæ‰¾åˆ°çœŸå®æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                            territoryData.value = mockData;
                        }
                        
                        lastUpdate.value = new Date();
                        error.value = null;
                        
                        // æ›´æ–°åé‡æ–°è®¡ç®—å¸ƒå±€
                        await nextTick();
                        updateLayout();
                        
                    } catch (err) {
                        console.error('è·å–æ•°æ®å¤±è´¥:', err);
                        error.value = err.message;
                        territoryData.value = mockData;
                    } finally {
                        loading.value = false;
                    }
                }
                
                // åˆ·æ–°æ•°æ®
                function refreshData() {
                    fetchData();
                }
                
                // æœˆåº¦ç»“ç®—
                function runMonthlySettlement() {
                    if (window.parent && window.parent.postMessage) {
                        // å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£ï¼ˆSillyTavernï¼‰
                        window.parent.postMessage({
                            type: 'territory_action',
                            action: 'monthly_settlement'
                        }, '*');
                    } else {
                        alert('æœˆåº¦ç»“ç®—åŠŸèƒ½éœ€è¦ä¸SillyTaverné›†æˆ');
                    }
                }
                
                // æ›´æ–°å¸ƒå±€ä»¥é€‚åº”å®¹å™¨
                function updateLayout() {
                    // ç¡®ä¿å†…å®¹åŒºåŸŸæ­£ç¡®æ˜¾ç¤º
                    const content = document.querySelector('.dashboard-content');
                    if (content) {
                        content.style.maxHeight = 'none';
                    }
                }
                
                // é¢æ¿åˆ‡æ¢
                function togglePanel(panelId) {
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.toggle('open');
                    }
                }
                
                // åˆå§‹åŒ–
                onMounted(() => {
                    fetchData();
                    
                    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                    window.addEventListener('resize', updateLayout);
                    
                    // ç›‘å¬æ¥è‡ª SillyTavern çš„æ¶ˆæ¯
                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'update_territory_data') {
                            territoryData.value = event.data.data;
                            lastUpdate.value = new Date();
                            updateLayout();
                        }
                    });
                    
                    // åˆå§‹å¸ƒå±€è°ƒæ•´
                    setTimeout(updateLayout, 100);
                });
                
                return {
                    // çŠ¶æ€
                    loading,
                    error,
                    lastUpdate,
                    
                    // æ•°æ®
                    territoryData,
                    basicInfo,
                    population,
                    economy,
                    warehouse,
                    military,
                    residents,
                    tech,
                    buildings,
                    totalPopulation,
                    races,
                    
                    // è®¡ç®—å±æ€§
                    balanceStatus,
                    threatColor,
                    
                    // æ–¹æ³•
                    refreshData,
                    runMonthlySettlement,
                    togglePanel
                };
            },
            template: `
                <div class="territory-dashboard">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="dashboard-toolbar">
                        <div class="toolbar-left">
                            <h1 class="dashboard-title">ğŸ° {{ basicInfo.åç§° || 'é¢†åœ°çŠ¶æ€é¢æ¿' }}</h1>
                            <span class="update-time">æœ€åæ›´æ–°: {{ lastUpdate ? lastUpdate.toLocaleTimeString() : 'ä»æœªæ›´æ–°' }}</span>
                        </div>
                        <div class="toolbar-right">
                            <button @click="refreshData" class="btn btn-refresh" :disabled="loading">
                                <span v-if="loading">ğŸ”„ åˆ·æ–°ä¸­...</span>
                                <span v-else>ğŸ”„ åˆ·æ–°</span>
                            </button>
                            <button @click="runMonthlySettlement" class="btn btn-settlement">
                                ğŸ“… æœˆåº¦ç»“ç®—
                            </button>
                        </div>
                    </div>
                    
                    <!-- é”™è¯¯æ˜¾ç¤º -->
                    <div v-if="error" class="error-alert">
                        âŒ é”™è¯¯: {{ error }}
                    </div>
                    
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div v-if="loading && !territoryData" class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½é¢†åœ°æ•°æ®...</p>
                    </div>
                    
                    <!-- ä¸»è¦å†…å®¹ -->
                    <div v-if="territoryData" class="dashboard-content">
                        
                        <!-- å…³é”®æŒ‡æ ‡ -->
                        <div class="metrics-row">
                            <div class="data-card size-large">
                                <div class="card-header">
                                    <span class="card-icon">ğŸ‘¥</span>
                                    <span class="card-title">æ€»äººå£</span>
                                </div>
                                <div class="card-value" style="color: #3498db;">
                                    {{ totalPopulation.toLocaleString() }}<span class="unit">äºº</span>
                                </div>
                            </div>
                            
                            <div class="data-card size-large">
                                <div class="card-header">
                                    <span class="card-icon">ğŸ’°</span>
                                    <span class="card-title">å›½åº“èµ„é‡‘</span>
                                </div>
                                <div class="card-value" style="color: #f39c12;">
                                    {{ economy.è´¢æ”¿?.åº“å­˜é‡‘å¸?.toLocaleString() || 0 }}<span class="unit">é‡‘å¸</span>
                                </div>
                            </div>
                            
                            <div class="data-card size-large">
                                <div class="card-header">
                                    <span class="card-icon">ğŸ’¸</span>
                                    <span class="card-title">æœˆåº¦æ”¶æ”¯</span>
                                </div>
                                <div class="card-value" :style="{ color: balanceStatus.color }">
                                    {{ economy.è´¢æ”¿?.æœˆå‡€æ”¶å…¥?.toLocaleString() || 0 }}<span class="unit">é‡‘å¸</span>
                                    <span class="trend">{{ balanceStatus.icon }}</span>
                                </div>
                            </div>
                            
                            <div class="data-card size-medium">
                                <div class="card-header">
                                    <span class="card-icon">âš ï¸</span>
                                    <span class="card-title">å¨èƒç­‰çº§</span>
                                </div>
                                <div class="card-value" :style="{ color: threatColor }">
                                    {{ residents.å¨èƒç­‰çº§ || 'æœªçŸ¥' }}
                                </div>
                            </div>
                            
                            <div class="data-card size-medium">
                                <div class="card-header">
                                    <span class="card-icon">â¤ï¸</span>
                                    <span class="card-title">æ°‘å¿ƒæŒ‡æ•°</span>
                                </div>
                                <div class="card-value" :style="{ color: residents.æ°‘å¿ƒæŒ‡æ•° > 70 ? '#27ae60' : residents.æ°‘å¿ƒæŒ‡æ•° > 40 ? '#f39c12' : '#e74c3c' }">
                                    {{ residents.æ°‘å¿ƒæŒ‡æ•° || 0 }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¯¦ç»†é¢æ¿ -->
                        <div class="panels-row">
                            
                            <!-- å·¦ä¾§åˆ— -->
                            <div class="panel-column">
                                <div class="collapsible-panel" id="basic-info">
                                    <div class="panel-header" @click="togglePanel('basic-info')">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ°</span>
                                            <span class="panel-title">é¢†åœ°ä¿¡æ¯</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <span class="info-label">åç§°:</span>
                                                <span class="info-value">{{ basicInfo.åç§° }}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">é¢ç§¯:</span>
                                                <span class="info-value">{{ basicInfo.é¢ç§¯ }} å¹³æ–¹é‡Œ</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">åœ°å½¢:</span>
                                                <span class="info-value">{{ basicInfo.åœ°å½¢ }}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">é˜¶æ®µ:</span>
                                                <span class="info-value">{{ basicInfo.å‘å±•é˜¶æ®µ }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="collapsible-panel" id="economy">
                                    <div class="panel-header" @click="togglePanel('economy')">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ’°</span>
                                            <span class="panel-title">ç»æµè´¢æ”¿</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="economy-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">æœˆæ”¶å…¥:</span>
                                                <span class="stat-value income">{{ economy.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ || 0 }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">æœˆæ”¯å‡º:</span>
                                                <span class="stat-value expense">{{ economy.è´¢æ”¿?.æœˆæ€»æ”¯å‡º || 0 }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">å‡€æ”¶å…¥:</span>
                                                <span class="stat-value" :style="{ color: balanceStatus.color }">{{ economy.è´¢æ”¿?.æœˆå‡€æ”¶å…¥ || 0 }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">å›½åº“èµ„é‡‘:</span>
                                                <span class="stat-value treasury">{{ economy.è´¢æ”¿?.åº“å­˜é‡‘å¸ || 0 }} é‡‘å¸</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸­é—´åˆ— -->
                            <div class="panel-column">
                                <div class="collapsible-panel" id="population">
                                    <div class="panel-header" @click="togglePanel('population')">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ‘¥</span>
                                            <span class="panel-title">äººå£ç§æ—</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="population-section">
                                            <h4 style="margin-bottom: 10px; color: #2c3e50;">æ€»äººå£: {{ totalPopulation }} äºº</h4>
                                            <div v-if="races && Object.keys(races).length > 0" class="races-section">
                                                <h4 style="margin: 15px 0 8px 0; color: #2c3e50;">ç§æ—æ„æˆ</h4>
                                                <div class="races-grid">
                                                    <div v-for="(race, raceName) in races" :key="raceName" class="race-item">
                                                        <span class="race-name">{{ raceName }}</span>
                                                        <span class="race-count">{{ race.æ•°é‡ }}äºº</span>
                                                        <span class="race-status" :class="'status-' + race.åœ°ä½">{{ race.åœ°ä½ }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="collapsible-panel" id="military">
                                    <div class="panel-header" @click="togglePanel('military')">
                                        <div class="header-left">
                                            <span class="panel-icon">âš”ï¸</span>
                                            <span class="panel-title">å†›äº‹é˜²å¾¡</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="military-stats">
                                            <div class="military-item">
                                                <span class="military-label">å¸¸å¤‡å†›:</span>
                                                <span class="military-value">{{ military.å…µåŠ›?.å¸¸å¤‡å†› || 0 }} äºº</span>
                                            </div>
                                            <div class="military-item">
                                                <span class="military-label">æ°‘å…µ:</span>
                                                <span class="military-value">{{ military.å…µåŠ›?.æ°‘å…µ || 0 }} äºº</span>
                                            </div>
                                            <div class="military-item">
                                                <span class="military-label">ç²¾é”éƒ¨é˜Ÿ:</span>
                                                <span class="military-value">{{ military.å…µåŠ›?.ç²¾é”éƒ¨é˜Ÿ || 0 }} äºº</span>
                                            </div>
                                            <div class="military-item">
                                                <span class="military-label">æ€»æˆ˜åŠ›è¯„çº§:</span>
                                                <span class="military-value">{{ military.æˆ˜åŠ›è¯„çº§?.æ€»è¯„çº§ || 'æœªçŸ¥' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å³ä¾§åˆ— -->
                            <div class="panel-column">
                                <div class="collapsible-panel" id="warehouse">
                                    <div class="panel-header" @click="togglePanel('warehouse')">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸª</span>
                                            <span class="panel-title">ä»“åº“ç‰©èµ„</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="warehouse-section">
                                            <div class="resources-grid">
                                                <div v-for="(item, key) in warehouse" :key="key" class="resource-item">
                                                    <span class="resource-name">{{ item.åç§° }}</span>
                                                    <span class="resource-amount">{{ item.å½“å‰å‚¨é‡ }}{{ item.å•ä½ }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="collapsible-panel" id="buildings">
                                    <div class="panel-header" @click="togglePanel('buildings')">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ›ï¸</span>
                                            <span class="panel-title">å»ºç­‘è®¾æ–½</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="buildings-section">
                                            <div class="buildings-grid">
                                                <div v-for="(building, id) in buildings" :key="id" class="building-item normal">
                                                    <div class="building-header">
                                                        <span class="building-name">{{ building.åç§° }}</span>
                                                        <span class="building-level">Lv.{{ building.ç­‰çº§ }}</span>
                                                    </div>
                                                    <div class="building-info">
                                                        <span style="font-size: 12px; color: #666;">{{ building.çŠ¶æ€?.[0] }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åº•éƒ¨çŠ¶æ€æ  -->
                    <div class="dashboard-footer">
                        <div class="footer-left">
                            <span>é¢†åœ°ç»è¥ç³»ç»Ÿ v1.1 | é€‚é…SillyTavern</span>
                        </div>
                        <div class="footer-right">
                            <span>æ•°æ®: {{ territoryData ? 'å·²åŠ è½½' : 'æœªåŠ è½½' }}</span>
                            <span style="margin: 0 5px;">|</span>
                            <span @click="refreshData" class="refresh-link">ç‚¹å‡»åˆ·æ–°</span>
                        </div>
                    </div>
                </div>
            `
        });
        
        // æŒ‚è½½åº”ç”¨
        app.mount('#app');
        
        // æ‰‹åŠ¨å¤„ç†é¢æ¿åˆ‡æ¢
        document.addEventListener('click', function(e) {
            if (e.target.closest('.panel-header')) {
                const header = e.target.closest('.panel-header');
                const panel = header.parentElement;
                const content = panel.querySelector('.panel-content');
                const arrow = panel.querySelector('.toggle-arrow');
                
                if (panel.classList.contains('open')) {
                    content.style.maxHeight = '0px';
                    arrow.style.transform = 'rotate(0deg)';
                    panel.classList.remove('open');
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    arrow.style.transform = 'rotate(180deg)';
                    panel.classList.add('open');
                }
            }
        });
        
        // åˆå§‹åŒ–æ‰€æœ‰é¢æ¿ä¸ºæ‰“å¼€çŠ¶æ€
        setTimeout(() => {
            document.querySelectorAll('.collapsible-panel').forEach(panel => {
                const content = panel.querySelector('.panel-content');
                const arrow = panel.querySelector('.toggle-arrow');
                if (content) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    arrow.style.transform = 'rotate(180deg)';
                    panel.classList.add('open');
                }
            });
        }, 100);
        
        // æä¾›å…¨å±€APIä¾›SillyTavernè°ƒç”¨
        window.TerritoryPanel = {
            updateData: function(data) {
                const appElement = document.querySelector('#app');
                if (appElement && appElement.__vue_app__) {
                    const instance = appElement.__vue_app__._instance;
                    if (instance && instance.setupState) {
                        instance.setupState.territoryData = data;
                        instance.setupState.lastUpdate = new Date();
                        instance.setupState.error = null;
                        
                        // è§¦å‘UIæ›´æ–°
                        setTimeout(() => {
                            document.querySelectorAll('.collapsible-panel.open').forEach(panel => {
                                const content = panel.querySelector('.panel-content');
                                if (content) {
                                    content.style.maxHeight = content.scrollHeight + 'px';
                                }
                            });
                        }, 50);
                    }
                }
            },
            
            clearData: function() {
                const appElement = document.querySelector('#app');
                if (appElement && appElement.__vue_app__) {
                    const instance = appElement.__vue_app__._instance;
                    if (instance && instance.setupState) {
                        instance.setupState.territoryData = null;
                        instance.setupState.lastUpdate = null;
                    }
                }
            }
        };
        
        console.log('é¢†åœ°ç®¡ç†é¢æ¿å·²åŠ è½½å®Œæˆ - é€‚é…SillyTavernç‰ˆæœ¬');
    </script>
</body>
</html>
