<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢†åœ°ç»è¥çŠ¶æ€é¢æ¿</title>
    
    <!-- ä½¿ç”¨æ›´ç¨³å®šçš„CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
    
    <style>
        /* æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œä»æ‚¨çš„åŸä»£ç å¤åˆ¶å³å¯ */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .territory-dashboard {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        /* ... å…¶ä½™CSSæ ·å¼ï¼ˆä»æ‚¨åŸä»£ç å¤åˆ¶å®Œæ•´çš„æ ·å¼ï¼‰ ... */
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        // ç®€åŒ–çš„ä¸»åº”ç”¨ - ä¸ä½¿ç”¨Piniaä»¥ç®€åŒ–
        const { createApp, ref, computed, onMounted } = Vue;
        
        const app = createApp({
            setup() {
                // çŠ¶æ€ç®¡ç†
                const loading = ref(true);
                const error = ref(null);
                const lastUpdate = ref(null);
                const territoryData = ref(null);
                
                // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºçœŸå®æ•°æ®ï¼‰
                const mockData = {
                    åŸºæœ¬ä¿¡æ¯: {
                        åç§°: "åŒ—å¢ƒè¾¹å¢ƒé¢†",
                        é¢ç§¯: 85,
                        åœ°å½¢: "ä¸˜é™µä¸æ£®æ—",
                        å‘å±•é˜¶æ®µ: "åˆå»º"
                    },
                    äººå£: {
                        æ€»äººå£: 1250,
                        èŒä¸šåˆ†å¸ƒ: {
                            å†œæ°‘: { äººæ•°: 700 },
                            å·¥åŒ : { äººæ•°: 120 },
                            å•†äºº: { äººæ•°: 60 },
                            å®˜å‘˜: { äººæ•°: 15 },
                            å£«å…µ: { äººæ•°: 80 },
                            æ— ä¸š: { äººæ•°: 275 }
                        },
                        ç§æ—æ„æˆ: {
                            äººç±»: { æ•°é‡: 900, åœ°ä½: "ä¸»å¯¼" },
                            çŸ®äºº: { æ•°é‡: 150, åœ°ä½: "å¹³ç­‰" },
                            åŠç²¾çµ: { æ•°é‡: 100, åœ°ä½: "å¹³ç­‰" },
                            å“¥å¸ƒæ—: { æ•°é‡: 50, åœ°ä½: "å¥´éš¶" }
                        }
                    },
                    ç»æµ: {
                        è´¢æ”¿: {
                            åº“å­˜é‡‘å¸: 2500,
                            æœˆæ€»æ”¶å…¥: 1850,
                            æœˆæ€»æ”¯å‡º: 1670,
                            æœˆå‡€æ”¶å…¥: 180
                        },
                        å…¬å…±ç¨ç‡: {
                            å†œä¸šç¨: 0.10,
                            å•†ä¸šç¨: 0.15,
                            å·¥ä¸šç¨: 0.12
                        }
                    },
                    ä»“åº“: {
                        res_food_grain: {
                            åç§°: "ç²®é£Ÿ",
                            å½“å‰å‚¨é‡: 6500,
                            å®‰å…¨å‚¨é‡: 3750,
                            å•ä½: "æ‹…"
                        },
                        res_material_wood: {
                            åç§°: "æœ¨æ",
                            å½“å‰å‚¨é‡: 900,
                            å®‰å…¨å‚¨é‡: 300,
                            å•ä½: "æ–¹"
                        },
                        res_material_stone: {
                            åç§°: "çŸ³æ",
                            å½“å‰å‚¨é‡: 500,
                            å®‰å…¨å‚¨é‡: 200,
                            å•ä½: "æ–¹"
                        },
                        res_material_iron: {
                            åç§°: "é“çŸ¿",
                            å½“å‰å‚¨é‡: 300,
                            å®‰å…¨å‚¨é‡: 100,
                            å•ä½: "æ–¤"
                        }
                    },
                    å†›äº‹: {
                        å…µåŠ›: {
                            å¸¸å¤‡å†›: 80,
                            æ°‘å…µ: 200,
                            ç²¾é”éƒ¨é˜Ÿ: 0
                        },
                        æˆ˜åŠ›è¯„çº§: {
                            æ€»è¯„çº§: "D"
                        },
                        é˜²å¾¡è®¾æ–½: {
                            åŸå¢™å®Œæ•´åº¦: 0.7,
                            ç­æœ›å¡”æ•°é‡: 2
                        }
                    },
                    çŠ¶æ€: {
                        å±…æ°‘çŠ¶æ€: {
                            ç”Ÿæ´»æ°´å¹³: "æ¸©é¥±",
                            æ²»å®‰çŠ¶å†µ: 65,
                            æ°‘å¿ƒæŒ‡æ•°: 70,
                            å½“å‰äº‹ä»¶: "æš‚æ— ",
                            å¨èƒç­‰çº§: "è­¦æˆ’"
                        }
                    },
                    ç§‘æŠ€: {
                        tech_basic_agriculture: {
                            åç§°: "åŸºç¡€å†œä¸šæŠ€æœ¯",
                            ç ”å‘çŠ¶æ€: ["å·²ç ”å‘"],
                            å½“å‰è¿›åº¦: 100
                        },
                        tech_iron_smelting: {
                            åç§°: "é“å™¨å†¶ç‚¼æŠ€æœ¯",
                            ç ”å‘çŠ¶æ€: ["ç ”å‘ä¸­"],
                            å½“å‰è¿›åº¦: 45
                        },
                        tech_basic_military_tactics: {
                            åç§°: "åŸºç¡€å†›äº‹æˆ˜æœ¯",
                            ç ”å‘çŠ¶æ€: ["æœªç ”å‘"],
                            å½“å‰è¿›åº¦: 0
                        }
                    },
                    å»ºç­‘: {
                        building_residential: {
                            åç§°: "å±…æ°‘åŒº",
                            ç­‰çº§: 2,
                            çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                            å²—ä½: { å½“å‰äººæ•°: 0, æœ€å¤§äººæ•°: 0 }
                        },
                        building_market: {
                            åç§°: "å¸‚åœº",
                            ç­‰çº§: 2,
                            çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                            å²—ä½: { å½“å‰äººæ•°: 25, æœ€å¤§äººæ•°: 40 },
                            äº§æƒ: "lord"
                        },
                        building_blacksmith: {
                            åç§°: "é“åŒ é“º",
                            ç­‰çº§: 1,
                            çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                            å²—ä½: { å½“å‰äººæ•°: 4, æœ€å¤§äººæ•°: 8 },
                            äº§æƒ: "private",
                            ç”Ÿäº§é…æ–¹: {
                                æŠ•å…¥èµ„æº: { res_material_iron: 2, res_material_wood: 1 },
                                äº§å‡ºèµ„æº: { item_weapon_spear: 3, item_tool_hammer: 5 },
                                ç”Ÿäº§æ•ˆç‡: 0.8
                            }
                        },
                        building_watchtower: {
                            åç§°: "åŒ—å¢ƒç­æœ›å¡”",
                            ç­‰çº§: 1,
                            çŠ¶æ€: ["å»ºè®¾ä¸­"],
                            å²—ä½: { å½“å‰äººæ•°: 0, æœ€å¤§äººæ•°: 5 },
                            äº§æƒ: "lord"
                        }
                    },
                    èµ„æº: {
                        æ£®æ—èµ„æº: { å†ç”Ÿé€Ÿç‡: 100, å¼€é‡‡é€Ÿç‡: 150 },
                        çŸ¿è„‰èµ„æº: { å¼€é‡‡é€Ÿç‡: 50 }
                    },
                    é¡¹ç›®: {
                        å½“å‰å»ºè®¾é¡¹ç›®: "åŒ—å¢ƒç­æœ›å¡”",
                        é¡¹ç›®è¿›åº¦: 30
                    },
                    æ³•ä»¤: {
                        decree_basic_tax: {
                            åç§°: "åŸºç¡€ç¨æ³•",
                            ç”Ÿæ•ˆçŠ¶æ€: [true]
                        }
                    }
                };
                
                // å°è¯•ä»SillyTavernè·å–æ•°æ®
                async function fetchData() {
                    try {
                        loading.value = true;
                        
                        // æ–¹æ³•1: æ£€æŸ¥å…¨å±€å˜é‡ï¼ˆSillyTavernå¯èƒ½ä¼šå°†æ•°æ®æ³¨å…¥windowï¼‰
                        if (window.territoryData) {
                            territoryData.value = window.territoryData;
                        }
                        // æ–¹æ³•2: å°è¯•ä»localStorageè·å–ï¼ˆå¦‚æœMVUæ’ä»¶å­˜å‚¨åœ¨é‚£é‡Œï¼‰
                        else if (localStorage.getItem('territoryData')) {
                            territoryData.value = JSON.parse(localStorage.getItem('territoryData'));
                        }
                        // æ–¹æ³•3: å¦‚æœä»¥ä¸Šéƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        else {
                            console.log('æœªæ‰¾åˆ°çœŸå®æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                            territoryData.value = mockData;
                        }
                        
                        lastUpdate.value = new Date();
                        error.value = null;
                    } catch (err) {
                        console.error('è·å–æ•°æ®å¤±è´¥:', err);
                        error.value = err.message;
                        territoryData.value = mockData; // å‡ºé”™æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    } finally {
                        loading.value = false;
                    }
                }
                
                // åˆ·æ–°æ•°æ®
                const refreshData = () => {
                    fetchData();
                };
                
                // æœˆåº¦ç»“ç®—ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                const runMonthlySettlement = () => {
                    alert('æœˆåº¦ç»“ç®—åŠŸèƒ½éœ€è¦ä¸SillyTavern MVUæ’ä»¶é›†æˆ');
                    // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸AIçš„äº¤äº’é€»è¾‘
                    if (window.sendMessageToAI) {
                        window.sendMessageToAI('æ‰§è¡Œé¢†åœ°æœˆåº¦ç»“ç®—');
                    }
                };
                
                // è®¡ç®—å±æ€§
                const basicInfo = computed(() => territoryData.value?.åŸºæœ¬ä¿¡æ¯ || {});
                const population = computed(() => territoryData.value?.äººå£ || {});
                const economy = computed(() => territoryData.value?.ç»æµ || {});
                const warehouse = computed(() => territoryData.value?.ä»“åº“ || {});
                const military = computed(() => territoryData.value?.å†›äº‹ || {});
                const residents = computed(() => territoryData.value?.çŠ¶æ€?.å±…æ°‘çŠ¶æ€ || {});
                const tech = computed(() => territoryData.value?.ç§‘æŠ€ || {});
                const buildings = computed(() => territoryData.value?.å»ºç­‘ || {});
                
                const totalPopulation = computed(() => population.value?.æ€»äººå£ || 0);
                const races = computed(() => population.value?.ç§æ—æ„æˆ || {});
                
                // è®¡ç®—æ”¶æ”¯çŠ¶æ€
                const balanceStatus = computed(() => {
                    const income = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ || 0;
                    const expense = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¯å‡º || 0;
                    const net = income - expense;
                    
                    if (net > 0) return { text: 'ç›ˆä½™', icon: 'ğŸ“ˆ', color: '#4caf50' };
                    if (net < 0) return { text: 'äºæŸ', icon: 'ğŸ“‰', color: '#f44336' };
                    return { text: 'å¹³è¡¡', icon: 'âš–ï¸', color: '#ff9800' };
                });
                
                // è®¡ç®—å¨èƒç­‰çº§é¢œè‰²
                const threatColor = computed(() => {
                    const threat = residents.value?.å¨èƒç­‰çº§;
                    switch(threat) {
                        case 'å®‰å…¨': return '#4caf50';
                        case 'è­¦æˆ’': return '#ff9800';
                        case 'å±é™©': return '#f44336';
                        case 'æå±é™©': return '#9c27b0';
                        default: return '#757575';
                    }
                });
                
                // åˆå§‹åŒ–
                onMounted(() => {
                    fetchData();
                });
                
                return {
                    // çŠ¶æ€
                    loading,
                    error,
                    lastUpdate,
                    
                    // æ•°æ®
                    territoryData,
                    basicInfo,
                    population,
                    economy,
                    warehouse,
                    military,
                    residents,
                    tech,
                    buildings,
                    totalPopulation,
                    races,
                    
                    // è®¡ç®—å±æ€§
                    balanceStatus,
                    threatColor,
                    
                    // æ–¹æ³•
                    refreshData,
                    runMonthlySettlement
                };
            },
            template: `
                <div class="territory-dashboard">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="dashboard-toolbar">
                        <div class="toolbar-left">
                            <h1 class="dashboard-title">ğŸ° {{ basicInfo.åç§° || 'é¢†åœ°çŠ¶æ€é¢æ¿' }}</h1>
                            <span class="update-time">æœ€åæ›´æ–°: {{ lastUpdate ? lastUpdate.toLocaleTimeString() : 'ä»æœªæ›´æ–°' }}</span>
                        </div>
                        <div class="toolbar-right">
                            <button @click="refreshData" class="btn btn-refresh" :disabled="loading">
                                <span v-if="loading">åˆ·æ–°ä¸­...</span>
                                <span v-else>ğŸ”„ åˆ·æ–°æ•°æ®</span>
                            </button>
                            <button @click="runMonthlySettlement" class="btn btn-settlement">
                                ğŸ“… æœˆåº¦ç»“ç®—
                            </button>
                        </div>
                    </div>
                    
                    <!-- é”™è¯¯æ˜¾ç¤º -->
                    <div v-if="error" class="error-alert">
                        âŒ é”™è¯¯: {{ error }}
                    </div>
                    
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div v-if="loading && !territoryData" class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½é¢†åœ°æ•°æ®...</p>
                    </div>
                    
                    <!-- ä¸»è¦å†…å®¹ -->
                    <div v-if="territoryData" class="dashboard-content">
                        
                        <!-- ç¬¬ä¸€è¡Œ: å…³é”®æŒ‡æ ‡ -->
                        <div class="metrics-row">
                            <div class="data-card size-large">
                                <div class="card-header">
                                    <span class="card-icon">ğŸ‘¥</span>
                                    <span class="card-title">æ€»äººå£</span>
                                </div>
                                <div class="card-value" style="color: #2196f3;">
                                    {{ totalPopulation.toLocaleString() }}<span class="unit">äºº</span>
                                </div>
                            </div>
                            
                            <div class="data-card size-large">
                                <div class="card-header">
                                    <span class="card-icon">ğŸ’°</span>
                                    <span class="card-title">å›½åº“èµ„é‡‘</span>
                                </div>
                                <div class="card-value" style="color: #ffc107;">
                                    {{ economy.è´¢æ”¿?.åº“å­˜é‡‘å¸?.toLocaleString() || 0 }}<span class="unit">é‡‘å¸</span>
                                </div>
                            </div>
                            
                            <div class="data-card size-large">
                                <div class="card-header">
                                    <span class="card-icon">ğŸ’¸</span>
                                    <span class="card-title">æœˆåº¦æ”¶æ”¯</span>
                                </div>
                                <div class="card-value" :style="{ color: balanceStatus.color }">
                                    {{ economy.è´¢æ”¿?.æœˆå‡€æ”¶å…¥?.toLocaleString() || 0 }}<span class="unit">é‡‘å¸</span>
                                    <span class="trend">{{ balanceStatus.icon }}</span>
                                </div>
                            </div>
                            
                            <div class="data-card size-medium">
                                <div class="card-header">
                                    <span class="card-icon">âš ï¸</span>
                                    <span class="card-title">å¨èƒç­‰çº§</span>
                                </div>
                                <div class="card-value" :style="{ color: threatColor }">
                                    {{ residents.å¨èƒç­‰çº§ || 'æœªçŸ¥' }}
                                </div>
                            </div>
                            
                            <div class="data-card size-medium">
                                <div class="card-header">
                                    <span class="card-icon">â¤ï¸</span>
                                    <span class="card-title">æ°‘å¿ƒæŒ‡æ•°</span>
                                </div>
                                <div class="card-value" :style="{ color: residents.æ°‘å¿ƒæŒ‡æ•° > 70 ? '#4caf50' : residents.æ°‘å¿ƒæŒ‡æ•° > 40 ? '#ff9800' : '#f44336' }">
                                    {{ residents.æ°‘å¿ƒæŒ‡æ•° || 0 }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç¬¬äºŒè¡Œ: è¯¦ç»†é¢æ¿ -->
                        <div class="panels-row">
                            
                            <!-- å·¦ä¾§åˆ— -->
                            <div class="panel-column">
                                <!-- åŸºç¡€ä¿¡æ¯ -->
                                <div class="collapsible-panel panel-default">
                                    <div class="panel-header" @click="togglePanel('basicInfo')">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ°</span>
                                            <span class="panel-title">ğŸ“‹ é¢†åœ°åŸºç¡€ä¿¡æ¯</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <span class="info-label">é¢†åœ°åç§°:</span>
                                                <span class="info-value">{{ basicInfo.åç§° }}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">é¢†åœ°é¢ç§¯:</span>
                                                <span class="info-value">{{ basicInfo.é¢ç§¯ }} å¹³æ–¹é‡Œ</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">åœ°å½¢ç‰¹å¾:</span>
                                                <span class="info-value">{{ basicInfo.åœ°å½¢ }}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">å‘å±•é˜¶æ®µ:</span>
                                                <span class="info-value">{{ basicInfo.å‘å±•é˜¶æ®µ }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ç»æµçŠ¶å†µ -->
                                <div class="collapsible-panel panel-default">
                                    <div class="panel-header">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ’°</span>
                                            <span class="panel-title">ğŸ’ ç»æµä¸è´¢æ”¿</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="economy-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">æœˆæ”¶å…¥:</span>
                                                <span class="stat-value income">{{ economy.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ || 0 }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">æœˆæ”¯å‡º:</span>
                                                <span class="stat-value expense">{{ economy.è´¢æ”¿?.æœˆæ€»æ”¯å‡º || 0 }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">å‡€æ”¶å…¥:</span>
                                                <span class="stat-value" :class="balanceStatus.text">{{ economy.è´¢æ”¿?.æœˆå‡€æ”¶å…¥ || 0 }} é‡‘å¸ {{ balanceStatus.icon }}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">å›½åº“èµ„é‡‘:</span>
                                                <span class="stat-value treasury">{{ economy.è´¢æ”¿?.åº“å­˜é‡‘å¸ || 0 }} é‡‘å¸</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸­é—´åˆ— -->
                            <div class="panel-column">
                                <!-- äººå£ä¸ç§æ— -->
                                <div class="collapsible-panel panel-default">
                                    <div class="panel-header">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ‘¥</span>
                                            <span class="panel-title">ğŸŒ äººå£ä¸ç§æ—æ„æˆ</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="population-section">
                                            <h4>æ€»äººå£: {{ totalPopulation }} äºº</h4>
                                            <div v-if="races && Object.keys(races).length > 0" class="races-section">
                                                <h4>ç§æ—æ„æˆ</h4>
                                                <div class="races-grid">
                                                    <div v-for="(race, raceName) in races" :key="raceName" class="race-item">
                                                        <span class="race-name">{{ raceName }}</span>
                                                        <span class="race-count">{{ race.æ•°é‡ }}äºº</span>
                                                        <span class="race-status" :class="'status-' + race.åœ°ä½">{{ race.åœ°ä½ }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å†›äº‹ä¸é˜²å¾¡ -->
                                <div class="collapsible-panel panel-default">
                                    <div class="panel-header">
                                        <div class="header-left">
                                            <span class="panel-icon">âš”ï¸</span>
                                            <span class="panel-title">ğŸ›¡ï¸ å†›äº‹ä¸é˜²å¾¡</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="military-section">
                                            <div class="military-stats">
                                                <div class="military-item">
                                                    <span class="military-label">å¸¸å¤‡å†›:</span>
                                                    <span class="military-value">{{ military.å…µåŠ›?.å¸¸å¤‡å†› || 0 }} äºº</span>
                                                </div>
                                                <div class="military-item">
                                                    <span class="military-label">æ°‘å…µ:</span>
                                                    <span class="military-value">{{ military.å…µåŠ›?.æ°‘å…µ || 0 }} äºº</span>
                                                </div>
                                                <div class="military-item">
                                                    <span class="military-label">æ€»æˆ˜åŠ›è¯„çº§:</span>
                                                    <span class="military-value rating">{{ military.æˆ˜åŠ›è¯„çº§?.æ€»è¯„çº§ || 'æœªçŸ¥' }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å³ä¾§åˆ— -->
                            <div class="panel-column">
                                <!-- ä»“åº“ç‰©èµ„å‚¨å¤‡ -->
                                <div class="collapsible-panel panel-default">
                                    <div class="panel-header">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸª</span>
                                            <span class="panel-title">ğŸ“¦ ä»“åº“ç‰©èµ„å‚¨å¤‡</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="warehouse-section">
                                            <div class="resources-grid">
                                                <div v-for="(item, key) in warehouse" :key="key" class="resource-item">
                                                    <span class="resource-name">{{ item.åç§° }}</span>
                                                    <span class="resource-amount">{{ item.å½“å‰å‚¨é‡ }}{{ item.å•ä½ }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å»ºç­‘è®¾æ–½ -->
                                <div class="collapsible-panel panel-default">
                                    <div class="panel-header">
                                        <div class="header-left">
                                            <span class="panel-icon">ğŸ›ï¸</span>
                                            <span class="panel-title">ğŸ—ï¸ å»ºç­‘è®¾æ–½</span>
                                        </div>
                                        <span class="toggle-arrow">â–¼</span>
                                    </div>
                                    <div class="panel-content">
                                        <div class="buildings-section">
                                            <div class="buildings-grid">
                                                <div v-for="(building, id) in buildings" :key="id" class="building-item normal">
                                                    <div class="building-header">
                                                        <span class="building-name">{{ building.åç§° }}</span>
                                                        <span class="building-level">Lv.{{ building.ç­‰çº§ }}</span>
                                                    </div>
                                                    <div class="building-info">
                                                        <span>çŠ¶æ€: {{ building.çŠ¶æ€?.[0] }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åº•éƒ¨çŠ¶æ€æ  -->
                    <div class="dashboard-footer">
                        <div class="footer-left">
                            <span>é¢†åœ°ç»è¥ç³»ç»Ÿ v1.0 | ç®€åŒ–ç‰ˆ</span>
                        </div>
                        <div class="footer-right">
                            <span>æ•°æ®: {{ territoryData ? 'å·²åŠ è½½' : 'æœªåŠ è½½' }}</span>
                            <span class="footer-separator">|</span>
                            <span @click="refreshData" class="refresh-link">ç‚¹å‡»åˆ·æ–°</span>
                        </div>
                    </div>
                </div>
            `
        });
        
        // æ·»åŠ ä¸€äº›ç®€å•çš„äº¤äº’é€»è¾‘
        app.directive('click-outside', {
            mounted(el, binding) {
                el.clickOutsideEvent = function(event) {
                    if (!(el === event.target || el.contains(event.target))) {
                        binding.value(event, el);
                    }
                };
                document.body.addEventListener('click', el.clickOutsideEvent);
            },
            unmounted(el) {
                document.body.removeEventListener('click', el.clickOutsideEvent);
            }
        });
        
        // æŒ‚è½½åº”ç”¨
        app.mount('#app');
        
        // ç®€å•çš„é¢æ¿åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.closest('.panel-header')) {
                const panel = e.target.closest('.collapsible-panel');
                const content = panel.querySelector('.panel-content');
                const arrow = panel.querySelector('.toggle-arrow');
                
                if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = '0px';
                    arrow.style.transform = 'rotate(0deg)';
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    arrow.style.transform = 'rotate(180deg)';
                }
            }
        });
        
        // åˆå§‹åŒ–é¢æ¿çŠ¶æ€
        setTimeout(() => {
            document.querySelectorAll('.collapsible-panel').forEach(panel => {
                const content = panel.querySelector('.panel-content');
                const arrow = panel.querySelector('.toggle-arrow');
                content.style.maxHeight = content.scrollHeight + 'px';
                arrow.style.transform = 'rotate(180deg)';
            });
        }, 100);
        
        // æä¾›å…¨å±€APIä¾›SillyTavernè°ƒç”¨
        window.updateTerritoryData = function(data) {
            const appElement = document.querySelector('#app');
            if (appElement && appElement.__vue_app__) {
                const instance = appElement.__vue_app__._instance;
                if (instance && instance.setupState) {
                    instance.setupState.territoryData = data;
                    instance.setupState.lastUpdate = new Date();
                }
            }
        };
        
        console.log('é¢†åœ°ç®¡ç†é¢æ¿å·²åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
