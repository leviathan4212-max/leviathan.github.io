<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢†åœ°çŠ¶æ€é¢æ¿</title>
    <!-- åŠ è½½lodashï¼Œç”¨äºå®‰å…¨çš„å˜é‡è®¿é—® -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <style>
        /* å®Œå…¨é‡ç½®ï¼Œåªä½¿ç”¨æœ€åŸºæœ¬æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100% !important;
            background: #F5E6C8 !important;
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif !important;
            color: #2C1810 !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            overflow-x: hidden !important;
        }
        
        /* ä¸»å®¹å™¨ */
        .territory-panel {
            width: 100% !important;
            max-width: 100% !important;
            padding: 10px !important;
            background: #F5E6C8 !important;
        }
        
        /* æ ‡é¢˜ */
        .panel-header {
            text-align: center;
            padding: 15px 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #8B6914;
        }
        
        .panel-title {
            font-size: 20px;
            color: #2C1810;
            margin-bottom: 5px;
        }
        
        .panel-subtitle {
            color: #8B6914;
            font-size: 12px;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .control-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(232, 212, 168, 0.5);
            border-radius: 5px;
            border: 1px solid #8B6914;
        }
        
        .control-btn {
            padding: 6px 12px;
            background: #8B6914;
            color: #F5E6C8;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #725811;
        }
        
        /* å¿«é€ŸçŠ¶æ€æ  */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #8B6914;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2C1810;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            color: #4A3728;
        }
        
        /* ç« èŠ‚æ ·å¼ */
        .section {
            margin-bottom: 15px;
            border: 1px solid #8B6914;
            border-radius: 5px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .section-header {
            background: #E8D4A8;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #8B6914;
        }
        
        .section-title {
            font-weight: bold;
            color: #2C1810;
        }
        
        .section-toggle {
            font-size: 12px;
            color: #8B6914;
        }
        
        .section-content {
            padding: 10px;
            display: block; /* é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ */
        }
        
        /* æ•°æ®è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .data-table th {
            background: #E8D4A8;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #8B6914;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .data-table tr:hover {
            background: rgba(245, 230, 200, 0.5);
        }
        
        /* é€‰é¡¹å¡å¯¼èˆª */
        .tab-nav {
            display: flex;
            overflow-x: auto;
            margin-bottom: 10px;
            border-bottom: 1px solid #8B6914;
            background: rgba(232, 212, 168, 0.3);
        }
        
        .tab-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            color: #4A3728;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: #2C1810;
            font-weight: bold;
            border-bottom: 2px solid #8B6914;
            background: rgba(139, 105, 20, 0.1);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-btn {
                min-width: 100px;
            }
        }
        
        @media (max-width: 480px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                text-align: center;
            }
        }
        
        /* è¿›åº¦æ¡ */
        .progress {
            height: 6px;
            background: rgba(139, 105, 20, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 4px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #8B6914;
            border-radius: 3px;
        }
        
        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .tag-success {
            background: #d4edda;
            color: #155724;
        }
        
        .tag-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .tag-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* è­¦å‘Šæ¡† */
        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        /* åº•éƒ¨ä¿¡æ¯ */
        .footer {
            margin-top: 20px;
            padding: 10px;
            text-align: center;
            color: #4A3728;
            font-size: 11px;
            border-top: 1px solid rgba(139, 105, 20, 0.3);
        }

        /* è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-item {
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        
        .debug-key {
            font-weight: bold;
            color: #2C1810;
        }
        
        .debug-value {
            color: #6c757d;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8B6914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="territory-panel">
        <!-- æ ‡é¢˜ -->
        <div class="panel-header">
            <h1 class="panel-title">ğŸ° é¢†åœ°çŠ¶æ€é¢æ¿</h1>
            <div class="panel-subtitle">ç‰ˆæœ¬: 3.0 | æœ€åæ›´æ–°: <span id="last-update">åˆšåˆš</span></div>
        </div>
        
        <!-- æ§åˆ¶æ  -->
        <div class="control-bar">
            <button class="control-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="control-btn" onclick="monthlySettlement()">ğŸ“… æœˆåº¦ç»“ç®—</button>
            <button class="control-btn" onclick="toggleAutoRefresh()" id="auto-refresh-btn">â–¶ï¸ è‡ªåŠ¨åˆ·æ–°</button>
            <button class="control-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
            <button class="control-btn" onclick="showDebugPanel()">ğŸ› è°ƒè¯•ä¿¡æ¯</button>
        </div>
        
        <!-- å¿«é€ŸçŠ¶æ€ -->
        <div class="quick-stats" id="quick-stats">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- é€‰é¡¹å¡å¯¼èˆª -->
        <div class="tab-nav" id="tab-nav">
            <button class="tab-btn active" onclick="switchTab('overview')">æ¦‚è§ˆ</button>
            <button class="tab-btn" onclick="switchTab('population')">äººå£</button>
            <button class="tab-btn" onclick="switchTab('economy')">ç»æµ</button>
            <button class="tab-btn" onclick="switchTab('resources')">èµ„æº</button>
            <button class="tab-btn" onclick="switchTab('military')">å†›äº‹</button>
            <button class="tab-btn" onclick="switchTab('buildings')">å»ºç­‘</button>
            <button class="tab-btn" onclick="switchTab('system')">ç³»ç»Ÿ</button>
        </div>
        
        <!-- æ¦‚è§ˆé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-overview" style="display: block;">
            <!-- åŸºç¡€ä¿¡æ¯ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ° é¢†åœ°åŸºç¡€ä¿¡æ¯</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="basic-info">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç»æµæ¦‚å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ’° ç»æµæ¦‚å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="economy-overview">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- äººå£æ¦‚å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ‘¥ äººå£æ¦‚å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="population-overview">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å¨èƒä¸å®‰å…¨ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">âš ï¸ å¨èƒä¸å®‰å…¨</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="threat-overview">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- äººå£é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-population" style="display: none;">
            <!-- è¯¦ç»†äººå£æ•°æ® -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ“Š è¯¦ç»†äººå£æ•°æ®</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="population-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç§æ—æ„æˆ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸŒ ç§æ—æ„æˆ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="race-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- èŒä¸šåˆ†å¸ƒ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ¢ èŒä¸šåˆ†å¸ƒ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="occupation-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ç»æµé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-economy" style="display: none;">
            <!-- è´¢æ”¿çŠ¶å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ’° è´¢æ”¿çŠ¶å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="finance-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç¨æ”¶ä½“ç³» -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ›ï¸ ç¨æ”¶ä½“ç³»</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="tax-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç»æµæŒ‡æ ‡ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ“ˆ ç»æµæŒ‡æ ‡</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="economy-indicators">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- èµ„æºé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-resources" style="display: none;">
            <!-- ä»“åº“ç‰©èµ„ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸª ä»“åº“ç‰©èµ„</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="resource-warnings"></div>
                    <table class="data-table" id="warehouse-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è‡ªç„¶èµ„æº -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸŒ³ è‡ªç„¶èµ„æº</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="natural-resources">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç¯å¢ƒçŠ¶å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸŒ¤ï¸ ç¯å¢ƒçŠ¶å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="environment-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å†›äº‹é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-military" style="display: none;">
            <!-- å…µåŠ›çŠ¶å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">âš”ï¸ å…µåŠ›çŠ¶å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="military-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è£…å¤‡çŠ¶æ€ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ–ï¸ è£…å¤‡çŠ¶æ€</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="equipment-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- é˜²å¾¡è®¾æ–½ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ° é˜²å¾¡è®¾æ–½</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="defense-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å»ºç­‘é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-buildings" style="display: none;">
            <!-- å»ºç­‘åˆ—è¡¨ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ›ï¸ å»ºç­‘è®¾æ–½</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="buildings-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- ç§‘æŠ€ç ”å‘ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ”¬ ç§‘æŠ€ç ”å‘</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="technology-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-system" style="display: none;">
            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="system-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- é¢†ä¸»ä¿¡æ¯ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ‘‘ é¢†ä¸»ä¿¡æ¯</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="lord-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div class="section" id="debug-section" style="display: none;">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ› è°ƒè¯•ä¿¡æ¯</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="debug-info"></div>
                </div>
            </div>
            
            <!-- æ•°æ®ç®¡ç† -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ”„ æ•°æ®ç®¡ç†</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div style="padding: 15px; text-align: center;">
                        <button class="control-btn" onclick="refreshData()" style="margin-bottom: 10px; width: 100%;">
                            ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ•°æ®
                        </button>
                        <button class="control-btn" onclick="exportData()" style="margin-bottom: 10px; width: 100%;">
                            ğŸ“¤ å¯¼å‡ºå½“å‰æ•°æ®
                        </button>
                        <button class="control-btn" onclick="monthlySettlement()" style="margin-bottom: 10px; width: 100%;">
                            ğŸ“… æ‰§è¡Œæœˆåº¦ç»“ç®—
                        </button>
                        <button class="control-btn" onclick="clearData()" style="margin-bottom: 10px; width: 100%; background: #dc3545;">
                            ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°æ•°æ®
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div class="footer">
            é¢†åœ°ç»è¥ç³»ç»Ÿ v3.0 | MVUå˜é‡é©±åŠ¨ | 
            <span onclick="refreshData()" style="color: #8B6914; cursor: pointer; text-decoration: underline;">
                ç‚¹å‡»åˆ·æ–°æ•°æ®
            </span>
        </div>
    </div>

    <script>
        // é¢†åœ°æ•°æ®å­˜å‚¨
        let territoryData = null;
        let lastUpdate = null;
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let debugMode = false;
        
        // å¢å¼ºçš„æ•°æ®è½¬æ¢å‡½æ•° - ä¿®å¤ç‰ˆ
        function extractValueFromMVUArray(value) {
            if (value === undefined || value === null) return null;
            
            // å¦‚æœæ˜¯æ•°ç»„ï¼Œæ£€æŸ¥å¯èƒ½çš„æ ¼å¼
            if (Array.isArray(value)) {
                console.log('å¤„ç†æ•°ç»„æ•°æ®:', value);
                
                // æ ¼å¼1: [å€¼, "æè¿°"] - MVUå¸¸è§æ ¼å¼
                if (value.length === 2 && typeof value[1] === 'string') {
                    console.log('æ ¼å¼1: [å€¼, "æè¿°"]ï¼Œè¿”å›:', value[0]);
                    return value[0];
                }
                // æ ¼å¼2: åµŒå¥—çš„å¯¹è±¡æ•°ç»„ï¼ˆå¦‚ç§æ—æ•°æ®ï¼‰
                else if (value.length > 0 && typeof value[0] === 'object') {
                    console.log('æ ¼å¼2: å¯¹è±¡æ•°ç»„');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç§æ—æ•°ç»„: [{ç§æ—: "äººç±»", æ•°é‡: 900, ...}, ...]
                    const firstItem = value[0];
                    
                    if (firstItem.ç§æ—) {
                        console.log('æ£€æµ‹åˆ°ç§æ—æ•°ç»„æ ¼å¼');
                        const result = {};
                        value.forEach((item, index) => {
                            if (item && item.ç§æ—) {
                                const raceName = item.ç§æ—;
                                const raceData = {};
                                Object.keys(item).forEach(key => {
                                    if (key !== 'ç§æ—') {
                                        // é€’å½’å¤„ç†åµŒå¥—çš„æ•°ç»„
                                        raceData[key] = extractValueFromMVUArray(item[key]);
                                    }
                                });
                                result[raceName] = raceData;
                                console.log(`æ·»åŠ ç§æ— ${raceName}:`, raceData);
                            }
                        });
                        return result;
                    }
                    // æ£€æŸ¥æ˜¯å¦æ˜¯èŒä¸šæ•°ç»„
                    else if (firstItem.èŒä¸š) {
                        console.log('æ£€æµ‹åˆ°èŒä¸šæ•°ç»„æ ¼å¼');
                        const result = {};
                        value.forEach(item => {
                            if (item && item.èŒä¸š) {
                                const jobName = item.èŒä¸š;
                                const jobData = {};
                                Object.keys(item).forEach(key => {
                                    if (key !== 'èŒä¸š') {
                                        jobData[key] = extractValueFromMVUArray(item[key]);
                                    }
                                });
                                result[jobName] = jobData;
                            }
                        });
                        return result;
                    }
                    // å…¶ä»–å¯¹è±¡æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ª
                    else {
                        console.log('å…¶ä»–å¯¹è±¡æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ª');
                        return extractValueFromMVUArray(value[0]);
                    }
                }
                // æ ¼å¼3: ç®€å•å€¼æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ª
                else if (value.length > 0) {
                    console.log('æ ¼å¼3: ç®€å•å€¼æ•°ç»„ï¼Œè¿”å›:', value[0]);
                    return value[0];
                }
                // ç©ºæ•°ç»„
                else {
                    console.log('ç©ºæ•°ç»„ï¼Œè¿”å›null');
                    return null;
                }
            }
            // å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€’å½’å¤„ç†
            else if (typeof value === 'object') {
                console.log('å¤„ç†å¯¹è±¡æ•°æ®:', value);
                
                // å¤„ç†MVUæ¨¡æ¿å¯¹è±¡
                if (value.$meta && value.$meta.extensible === true) {
                    console.log('å¤„ç†MVUæ¨¡æ¿å¯¹è±¡');
                    const result = {};
                    Object.keys(value).forEach(key => {
                        if (key !== '$meta') {
                            result[key] = extractValueFromMVUArray(value[key]);
                        }
                    });
                    return result;
                }
                // æ™®é€šå¯¹è±¡
                else {
                    const result = {};
                    Object.keys(value).forEach(key => {
                        result[key] = extractValueFromMVUArray(value[key]);
                    });
                    return result;
                }
            }
            // åŸºæœ¬ç±»å‹ï¼Œç›´æ¥è¿”å›
            else {
                console.log('åŸºæœ¬ç±»å‹:', value);
                return value;
            }
        }
        
        // ä»MVUè·å–æ•°æ® - ä¿®å¤ç‰ˆ
        async function fetchFromMVU() {
            try {
                showLoading(true);
                console.log('å¼€å§‹ä»MVUè·å–æ•°æ®...');
                
                let mvuData = null;
                
                // æ–¹æ³•1ï¼šä½¿ç”¨getVariables
                if (typeof getVariables === 'function') {
                    console.log('ä½¿ç”¨ getVariables()');
                    try {
                        mvuData = getVariables({
                            type: 'message',
                            message_id: getCurrentMessageId?.() || 'current'
                        });
                        console.log('getVariables è¿”å›:', mvuData);
                    } catch (e) {
                        console.error('getVariables é”™è¯¯:', e);
                    }
                }
                
                // æ–¹æ³•2ï¼šå°è¯•window.getVariables
                if (!mvuData && typeof window.getVariables === 'function') {
                    console.log('ä½¿ç”¨ window.getVariables()');
                    try {
                        mvuData = await window.getVariables({
                            type: 'message',
                            message_id: window.getCurrentMessageId?.() || 'current'
                        });
                    } catch (e) {
                        console.error('window.getVariables é”™è¯¯:', e);
                    }
                }
                
                // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºè°ƒè¯•
                window.rawMVUData = mvuData;
                
                if (mvuData) {
                    console.log('åŸå§‹MVUæ•°æ®ç»“æ„:', mvuData);
                    
                    // æ£€æŸ¥å¸¸è§çš„æ•°æ®ç»“æ„
                    let territoryRawData = null;
                    
                    // æƒ…å†µ1: æ•°æ®åœ¨ stat_data.Territory
                    if (mvuData.stat_data && mvuData.stat_data.Territory) {
                        console.log('æ‰¾åˆ°æ•°æ®è·¯å¾„: stat_data.Territory');
                        territoryRawData = mvuData.stat_data.Territory;
                    }
                    // æƒ…å†µ2: æ•°æ®ç›´æ¥åœ¨ Territory
                    else if (mvuData.Territory) {
                        console.log('æ‰¾åˆ°æ•°æ®è·¯å¾„: Territory');
                        territoryRawData = mvuData.Territory;
                    }
                    // æƒ…å†µ3: æ•°æ®åœ¨ stat_data ä½†æ²¡æœ‰ Territory é”®
                    else if (mvuData.stat_data) {
                        console.log('æ‰¾åˆ°æ•°æ®è·¯å¾„: stat_data (ç›´æ¥)');
                        territoryRawData = mvuData.stat_data;
                    }
                    // æƒ…å†µ4: æ•°æ®å¯èƒ½åœ¨é¡¶å±‚
                    else if (mvuData.äººå£ || mvuData.ç»æµ) {
                        console.log('æ•°æ®åœ¨é¡¶å±‚');
                        territoryRawData = mvuData;
                    }
                    
                    if (territoryRawData) {
                        console.log('æ‰¾åˆ°é¢†åœ°åŸå§‹æ•°æ®:', territoryRawData);
                        
                        // ä½¿ç”¨æ–°çš„æå–å‡½æ•°å¤„ç†æ•°æ®
                        territoryData = extractValueFromMVUArray(territoryRawData);
                        
                        console.log('è½¬æ¢åçš„é¢†åœ°æ•°æ®:', territoryData);
                        
                        // éªŒè¯æ•°æ®æå–
                        console.log('æ•°æ®éªŒè¯:');
                        console.log('  - æ€»äººå£:', territoryData.äººå£?.æ€»äººå£);
                        console.log('  - é‡‘é’±:', territoryData.ç»æµ?.è´¢æ”¿?.åº“å­˜é‡‘å¸);
                        console.log('  - ç§æ—æ„æˆ:', territoryData.äººå£?.ç§æ—æ„æˆ);
                        console.log('  - äººç±»æ•°é‡:', territoryData.äººå£?.ç§æ—æ„æˆ?.äººç±»?.æ•°é‡);
                        
                        // å¦‚æœç§æ—æ•°æ®æ˜¯æ•°ç»„æ ¼å¼ï¼Œè¿›è¡Œé¢å¤–å¤„ç†
                        if (Array.isArray(territoryData.äººå£?.ç§æ—æ„æˆ)) {
                            console.log('ç§æ—æ„æˆæ˜¯æ•°ç»„æ ¼å¼ï¼Œæ­£åœ¨è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼...');
                            const raceArray = territoryData.äººå£.ç§æ—æ„æˆ;
                            const raceObj = {};
                            
                            raceArray.forEach((race, index) => {
                                if (race && race.ç§æ—) {
                                    raceObj[race.ç§æ—] = {
                                        æ•°é‡: extractValue(race.æ•°é‡, 0),
                                        åœ°ä½: extractValue(race.åœ°ä½, ''),
                                        ç‰¹æ®Šèƒ½åŠ›: extractValue(race.ç‰¹æ®Šèƒ½åŠ›, '')
                                    };
                                }
                            });
                            
                            territoryData.äººå£.ç§æ—æ„æˆ = raceObj;
                            console.log('è½¬æ¢åçš„ç§æ—æ„æˆ:', raceObj);
                        }
                    } else {
                        console.warn('æœªæ‰¾åˆ°é¢†åœ°æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤æ•°æ®');
                        useFallbackData();
                    }
                } else {
                    console.log('æ— æ³•ä»MVUè·å–æ•°æ®');
                    useFallbackData();
                }
                
                lastUpdate = new Date();
                document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
                
                // æ›´æ–°UI
                updateUI();
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('territoryData', JSON.stringify(territoryData));
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                useFallbackData();
                updateUI();
            } finally {
                showLoading(false);
                adjustIframeHeight();
            }
        }
        
        // ä½¿ç”¨å›é€€æ•°æ®
        function useFallbackData() {
            const storedData = localStorage.getItem('territoryData');
            if (storedData) {
                territoryData = JSON.parse(storedData);
                console.log('ä½¿ç”¨localStorageç¼“å­˜æ•°æ®');
            } else {
                territoryData = getDefaultData();
                console.log('ä½¿ç”¨é»˜è®¤æ•°æ®');
            }
        }
        
        // è·å–é»˜è®¤æ•°æ®
        function getDefaultData() {
            return {
                åŸºæœ¬ä¿¡æ¯: {
                    åç§°: "åŒ—å¢ƒè¾¹å¢ƒé¢†",
                    é¢ç§¯: 85,
                    åœ°å½¢: "ä¸˜é™µä¸æ£®æ—",
                    å‘å±•é˜¶æ®µ: "åˆå»º"
                },
                äººå£: {
                    æ€»äººå£: 1250,
                    ç§æ—æ„æˆ: {
                        äººç±»: { æ•°é‡: 900, åœ°ä½: "ä¸»å¯¼", ç‰¹æ®Šèƒ½åŠ›: "é€‚åº”æ€§å¼ºï¼Œå­¦ä¹ èƒ½åŠ›å¿«" },
                        çŸ®äºº: { æ•°é‡: 150, åœ°ä½: "å¹³ç­‰", ç‰¹æ®Šèƒ½åŠ›: "åœ°ä¸‹è§†è§‰ï¼Œé”»é€ ä¸çŸ³å·¥ä¸“ç²¾" },
                        åŠç²¾çµ: { æ•°é‡: 100, åœ°ä½: "å¹³ç­‰", ç‰¹æ®Šèƒ½åŠ›: "è‡ªç„¶äº²å’Œï¼Œå¼“ç®­ä¸è¿½è¸ªä¸“ç²¾" },
                        å“¥å¸ƒæ—: { æ•°é‡: 50, åœ°ä½: "å¥´éš¶", ç‰¹æ®Šèƒ½åŠ›: "å¤œè§†ï¼Œæ•æ·ï¼Œå°å‹å·¥ç¨‹" }
                    },
                    èŒä¸šåˆ†å¸ƒ: {
                        å†œæ°‘: { äººæ•°: 700, æœˆè´¡çŒ®: 15, å¹³å‡è–ªèµ„: 2, æ»¡æ„åº¦: 65 },
                        å·¥åŒ : { äººæ•°: 120, æœˆè´¡çŒ®: 25, å¹³å‡è–ªèµ„: 5, æ»¡æ„åº¦: 70 },
                        å•†äºº: { äººæ•°: 60, æœˆè´¡çŒ®: 30, å¹³å‡è–ªèµ„: 8, æ»¡æ„åº¦: 75 },
                        å®˜å‘˜: { äººæ•°: 15, æœˆè´¡çŒ®: -10, å¹³å‡è–ªèµ„: 10, æ»¡æ„åº¦: 80 },
                        å£«å…µ: { äººæ•°: 80, æœˆè´¡çŒ®: -20, å¹³å‡è–ªèµ„: 6, æ»¡æ„åº¦: 70 },
                        å­¦è€…: { äººæ•°: 10, æœˆè´¡çŒ®: 5, å¹³å‡è–ªèµ„: 7, æ»¡æ„åº¦: 85 },
                        æ— ä¸š: { äººæ•°: 265, æœˆè´¡çŒ®: 0, å¹³å‡è–ªèµ„: 0, æ»¡æ„åº¦: 40 }
                    },
                    äººå£å¢é•¿ç‡: 0.008,
                    ç§»æ°‘ç‡: 0.002
                },
                ç»æµ: {
                    è´¢æ”¿: {
                        åº“å­˜é‡‘å¸: 2500,
                        æœˆæ€»æ”¶å…¥: 1850,
                        æœˆæ€»æ”¯å‡º: 1670,
                        æœˆå‡€æ”¶å…¥: 180,
                        æ”¶æ”¯çŠ¶æ€: "ğŸ“ˆç›ˆä½™"
                    }
                },
                çŠ¶æ€: {
                    å±…æ°‘çŠ¶æ€: {
                        ç”Ÿæ´»æ°´å¹³: "æ¸©é¥±",
                        æ²»å®‰çŠ¶å†µ: 65,
                        æ°‘å¿ƒæŒ‡æ•°: 70,
                        å½“å‰äº‹ä»¶: "æš‚æ— "
                    },
                    å¨èƒçŠ¶æ€: {
                        å¨èƒç­‰çº§: "è­¦æˆ’",
                        ä¸»è¦é­”ç‰©: "å“¥å¸ƒæ—å›¢ä¼™",
                        é¢„è®¡ä¸‹æ¬¡è¢­å‡»: "1-3ä¸ªæœˆå†…"
                    }
                }
            };
        }
        
        // æå–å€¼çš„è¾…åŠ©å‡½æ•°
        function extractValue(value, defaultValue = null) {
            if (value === undefined || value === null) return defaultValue;
            
            // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
            if (Array.isArray(value)) {
                return value.length > 0 ? value[0] : defaultValue;
            }
            
            return value;
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const refreshBtn = document.querySelector('.control-btn[onclick="refreshData()"]');
            if (refreshBtn) {
                if (show) {
                    refreshBtn.innerHTML = '<div class="loading"></div>åˆ·æ–°ä¸­...';
                    refreshBtn.disabled = true;
                } else {
                    refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                    refreshBtn.disabled = false;
                }
            }
        }
        
        // æ›´æ–°UI
        function updateUI() {
            if (!territoryData) {
                console.warn('æ²¡æœ‰æ•°æ®å¯æ›´æ–°');
                return;
            }
            
            console.log('æ›´æ–°UIï¼Œå½“å‰æ•°æ®:', territoryData);
            
            updateQuickStats();
            updateBasicInfo();
            updateEconomyOverview();
            updatePopulationOverview();
            updateThreatOverview();
            
            // å¦‚æœå½“å‰åœ¨æŸä¸ªé€‰é¡¹å¡ï¼Œæ›´æ–°è¯¥é€‰é¡¹å¡å†…å®¹
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.textContent.trim();
                switch(tabName) {
                    case 'äººå£':
                        loadTabData('population');
                        break;
                    case 'ç»æµ':
                        loadTabData('economy');
                        break;
                    case 'èµ„æº':
                        loadTabData('resources');
                        break;
                    case 'å†›äº‹':
                        loadTabData('military');
                        break;
                    case 'å»ºç­‘':
                        loadTabData('buildings');
                        break;
                    case 'ç³»ç»Ÿ':
                        loadTabData('system');
                        break;
                }
            }
        }
        
        // æ›´æ–°å¿«é€ŸçŠ¶æ€
        function updateQuickStats() {
            const container = document.getElementById('quick-stats');
            if (!container) return;
            
            // ä½¿ç”¨extractValueå‡½æ•°è·å–æ•°æ®
            const totalPopulation = extractValue(territoryData.äººå£?.æ€»äººå£, 1250);
            const treasury = extractValue(territoryData.ç»æµ?.è´¢æ”¿?.åº“å­˜é‡‘å¸, 2500);
            const netIncome = extractValue(territoryData.ç»æµ?.è´¢æ”¿?.æœˆå‡€æ”¶å…¥, 180);
            const threatLevel = extractValue(territoryData.çŠ¶æ€?.å¨èƒçŠ¶æ€?.å¨èƒç­‰çº§, 'è­¦æˆ’');
            const morale = extractValue(territoryData.çŠ¶æ€?.å±…æ°‘çŠ¶æ€?.æ°‘å¿ƒæŒ‡æ•°, 70);
            const area = extractValue(territoryData.åŸºæœ¬ä¿¡æ¯?.é¢ç§¯, 85);
            
            const stats = [
                { 
                    label: 'æ€»äººå£', 
                    value: formatNumber(totalPopulation), 
                    unit: 'äºº',
                    color: '#2C1810'
                },
                { 
                    label: 'å›½åº“èµ„é‡‘', 
                    value: formatCurrency(treasury),
                    color: '#ffc107'
                },
                { 
                    label: 'æœˆåº¦å‡€æ”¶å…¥', 
                    value: formatCurrency(netIncome, true),
                    color: netIncome >= 0 ? '#28a745' : '#dc3545'
                },
                { 
                    label: 'å¨èƒç­‰çº§', 
                    value: threatLevel,
                    color: getThreatColor(threatLevel)
                },
                { 
                    label: 'æ°‘å¿ƒæŒ‡æ•°', 
                    value: formatNumber(morale),
                    unit: '/100',
                    color: getMoraleColor(morale)
                },
                { 
                    label: 'é¢†åœ°é¢ç§¯', 
                    value: formatNumber(area),
                    unit: 'å¹³æ–¹é‡Œ',
                    color: '#2C1810'
                }
            ];
            
            let html = '';
            stats.forEach(stat => {
                const colorStyle = stat.color ? `style="color: ${stat.color};"` : '';
                html += `
                    <div class="stat-card">
                        <div class="stat-value" ${colorStyle}>${stat.value}${stat.unit || ''}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°åŸºç¡€ä¿¡æ¯
        function updateBasicInfo() {
            const container = document.getElementById('basic-info');
            if (!container) return;
            
            const rows = [
                ['é¢†åœ°åç§°', extractValue(territoryData.åŸºæœ¬ä¿¡æ¯?.åç§°, 'åŒ—å¢ƒè¾¹å¢ƒé¢†')],
                ['é¢†åœ°é¢ç§¯', `${extractValue(territoryData.åŸºæœ¬ä¿¡æ¯?.é¢ç§¯, 85)} å¹³æ–¹é‡Œ`],
                ['åœ°å½¢ç‰¹å¾', extractValue(territoryData.åŸºæœ¬ä¿¡æ¯?.åœ°å½¢, 'ä¸˜é™µä¸æ£®æ—')],
                ['å‘å±•é˜¶æ®µ', extractValue(territoryData.åŸºæœ¬ä¿¡æ¯?.å‘å±•é˜¶æ®µ, 'åˆå»º')],
                ['æ¸¸æˆæ—¶é—´', extractValue(territoryData.System?.å½“å‰æ¸¸æˆæ—¶é—´, 'ç¬¬1å¹´ 1æœˆ')],
                ['å½“å‰å­£èŠ‚', extractValue(territoryData.System?.å½“å‰å­£èŠ‚, 'æ˜¥å­£')]
            ];
            
            let html = '';
            rows.forEach(row => {
                html += `
                    <tr>
                        <td style="width: 100px;">${row[0]}</td>
                        <td>${row[1]}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°ç»æµæ¦‚å†µ
        function updateEconomyOverview() {
            const container = document.getElementById('economy-overview');
            if (!container) return;
            
            const income = extractValue(territoryData.ç»æµ?.è´¢æ”¿?.æœˆæ€»æ”¶å…¥, 1850);
            const expense = extractValue(territoryData.ç»æµ?.è´¢æ”¿?.æœˆæ€»æ”¯å‡º, 1670);
            const net = extractValue(territoryData.ç»æµ?.è´¢æ”¿?.æœˆå‡€æ”¶å…¥, 180);
            const balanceStatus = extractValue(territoryData.ç»æµ?.è´¢æ”¿?.æ”¶æ”¯çŠ¶æ€, 'ğŸ“ˆç›ˆä½™');
            
            const incomeColor = income >= expense ? '#28a745' : '#dc3545';
            const netColor = net >= 0 ? '#28a745' : '#dc3545';
            
            let html = `
                <table class="data-table">
                    <tr>
                        <td style="width: 100px;">æœˆæ€»æ”¶å…¥</td>
                        <td style="color: ${incomeColor}; font-weight: bold;">${formatCurrency(income)}</td>
                    </tr>
                    <tr>
                        <td>æœˆæ€»æ”¯å‡º</td>
                        <td style="color: #dc3545;">${formatCurrency(expense)}</td>
                    </tr>
                    <tr>
                        <td>æœˆå‡€æ”¶å…¥</td>
                        <td style="color: ${netColor}; font-weight: bold;">${formatCurrency(net, true)}</td>
                    </tr>
                    <tr>
                        <td>æ”¶æ”¯çŠ¶æ€</td>
                        <td>${balanceStatus}</td>
                    </tr>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°äººå£æ¦‚å†µ - ä¿®å¤ç‰ˆ
        function updatePopulationOverview() {
            const container = document.getElementById('population-overview');
            if (!container) return;
            
            const total = extractValue(territoryData.äººå£?.æ€»äººå£, 1250);
            const growth = extractValue(territoryData.äººå£?.äººå£å¢é•¿ç‡, 0.008);
            const migration = extractValue(territoryData.äººå£?.ç§»æ°‘ç‡, 0.002);
            
            // è·å–ç§æ—æ•°æ®ï¼Œå¤„ç†å„ç§å¯èƒ½çš„æ ¼å¼
            let races = territoryData.äººå£?.ç§æ—æ„æˆ || {};
            
            console.log('åŸå§‹ç§æ—æ•°æ®:', races);
            
            // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºå¯¹è±¡
            if (Array.isArray(races)) {
                const raceObj = {};
                races.forEach(race => {
                    if (race && race.ç§æ—) {
                        raceObj[race.ç§æ—] = {
                            æ•°é‡: extractValue(race.æ•°é‡, 0),
                            åœ°ä½: extractValue(race.åœ°ä½, ''),
                            ç‰¹æ®Šèƒ½åŠ›: extractValue(race.ç‰¹æ®Šèƒ½åŠ›, '')
                        };
                    }
                });
                races = raceObj;
                console.log('è½¬æ¢åçš„ç§æ—æ•°æ®:', raceObj);
            }
            
            // è®¡ç®—ç§æ—åˆ†å¸ƒ
            let raceHtml = '<div style="margin-top: 10px;">';
            
            // å¦‚æœæ˜¯å¯¹è±¡æ ¼å¼ï¼Œéå†æ˜¾ç¤º
            if (typeof races === 'object' && races !== null) {
                Object.entries(races).forEach(([raceName, raceData]) => {
                    // å¤„ç†åµŒå¥—çš„æ•°ç»„æ ¼å¼
                    const count = extractValue(raceData?.æ•°é‡, 0);
                    const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const status = extractValue(raceData?.åœ°ä½, '');
                    
                    raceHtml += `
                        <div style="margin-bottom: 5px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <span>${raceName}</span>
                                <span>${count}äºº (${percentage}%)</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div style="font-size: 11px; color: #4A3728;">åœ°ä½: ${status}</div>
                        </div>
                    `;
                });
            } else {
                raceHtml += '<div style="color: #dc3545;">æ— æ³•åŠ è½½ç§æ—æ•°æ®</div>';
            }
            
            raceHtml += '</div>';
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">æ€»äººå£: ${formatNumber(total)} äºº</div>
                    <div style="font-size: 12px; color: #4A3728;">
                        å¢é•¿ç‡: ${(growth * 100).toFixed(2)}% | 
                        ç§»æ°‘ç‡: ${(migration * 100).toFixed(2)}%
                    </div>
                </div>
                ${raceHtml}
            `;
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°å¨èƒæ¦‚å†µ
        function updateThreatOverview() {
            const container = document.getElementById('threat-overview');
            if (!container) return;
            
            const threatLevel = extractValue(territoryData.çŠ¶æ€?.å¨èƒçŠ¶æ€?.å¨èƒç­‰çº§, 'è­¦æˆ’');
            const threatColor = getThreatColor(threatLevel);
            const morale = extractValue(territoryData.çŠ¶æ€?.å±…æ°‘çŠ¶æ€?.æ°‘å¿ƒæŒ‡æ•°, 70);
            const moraleColor = getMoraleColor(morale);
            
            let html = `
                <table class="data-table">
                    <tr>
                        <td style="width: 100px;">å¨èƒç­‰çº§</td>
                        <td style="color: ${threatColor}; font-weight: bold;">${threatLevel}</td>
                    </tr>
                    <tr>
                        <td>ä¸»è¦å¨èƒ</td>
                        <td>${extractValue(territoryData.çŠ¶æ€?.å¨èƒçŠ¶æ€?.ä¸»è¦é­”ç‰©, 'å“¥å¸ƒæ—å›¢ä¼™')}</td>
                    </tr>
                    <tr>
                        <td>é¢„ä¼°ä¸‹æ¬¡è¢­å‡»</td>
                        <td>${extractValue(territoryData.çŠ¶æ€?.å¨èƒçŠ¶æ€?.é¢„è®¡ä¸‹æ¬¡è¢­å‡», '1-3ä¸ªæœˆå†…')}</td>
                    </tr>
                    <tr>
                        <td>ç”Ÿæ´»æ°´å¹³</td>
                        <td>${extractValue(territoryData.çŠ¶æ€?.å±…æ°‘çŠ¶æ€?.ç”Ÿæ´»æ°´å¹³, 'æ¸©é¥±')}</td>
                    </tr>
                    <tr>
                        <td>æ²»å®‰çŠ¶å†µ</td>
                        <td>${extractValue(territoryData.çŠ¶æ€?.å±…æ°‘çŠ¶æ€?.æ²»å®‰çŠ¶å†µ, 65)}/100</td>
                    </tr>
                    <tr>
                        <td>æ°‘å¿ƒæŒ‡æ•°</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${moraleColor}; font-weight: bold;">${morale}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${morale}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // åŠ è½½äººå£è¯¦æƒ…
        function loadPopulationDetails() {
            const container = document.getElementById('population-details');
            if (!container) return;
            
            const total = extractValue(territoryData.äººå£?.æ€»äººå£, 1250);
            const growth = extractValue(territoryData.äººå£?.äººå£å¢é•¿ç‡, 0.008);
            const migration = extractValue(territoryData.äººå£?.ç§»æ°‘ç‡, 0.002);
            
            let html = `
                <tr>
                    <th>æŒ‡æ ‡</th>
                    <th>æ•°å€¼</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td>æ€»äººå£</td>
                    <td>${formatNumber(total)} äºº</td>
                    <td></td>
                </tr>
                <tr>
                    <td>äººå£å¢é•¿ç‡</td>
                    <td>${(growth * 100).toFixed(2)}%</td>
                    <td>æ¯æœˆè‡ªç„¶å¢é•¿ç‡</td>
                </tr>
                <tr>
                    <td>ç§»æ°‘ç‡</td>
                    <td>${(migration * 100).toFixed(2)}%</td>
                    <td>æ¯æœˆå‡€ç§»æ°‘ç‡</td>
                </tr>
            `;
            
            container.innerHTML = html;
            
            // åŠ è½½ç§æ—è¯¦æƒ…
            loadRaceDetails();
            // åŠ è½½èŒä¸šè¯¦æƒ…
            loadOccupationDetails();
        }
        
        // åŠ è½½ç§æ—è¯¦æƒ…
        function loadRaceDetails() {
            const container = document.getElementById('race-details');
            if (!container) return;
            
            const total = extractValue(territoryData.äººå£?.æ€»äººå£, 1250);
            let races = territoryData.äººå£?.ç§æ—æ„æˆ || {};
            
            // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºå¯¹è±¡
            if (Array.isArray(races)) {
                const raceObj = {};
                races.forEach(race => {
                    if (race && race.ç§æ—) {
                        raceObj[race.ç§æ—] = {
                            æ•°é‡: extractValue(race.æ•°é‡, 0),
                            åœ°ä½: extractValue(race.åœ°ä½, ''),
                            ç‰¹æ®Šèƒ½åŠ›: extractValue(race.ç‰¹æ®Šèƒ½åŠ›, '')
                        };
                    }
                });
                races = raceObj;
            }
            
            let html = `
                <tr>
                    <th>ç§æ—</th>
                    <th>æ•°é‡</th>
                    <th>å æ¯”</th>
                    <th>åœ°ä½</th>
                    <th>ç‰¹æ®Šèƒ½åŠ›</th>
                </tr>
            `;
            
            if (typeof races === 'object' && races !== null) {
                Object.entries(races).forEach(([raceName, raceData]) => {
                    const count = extractValue(raceData?.æ•°é‡, 0);
                    const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const status = extractValue(raceData?.åœ°ä½, '');
                    const ability = extractValue(raceData?.ç‰¹æ®Šèƒ½åŠ›, '');
                    
                    let statusClass = 'tag';
                    switch(status) {
                        case 'ä¸»å¯¼': statusClass += ' tag-success'; break;
                        case 'å¹³ç­‰': statusClass += ' tag-warning'; break;
                        case 'å¥´éš¶': statusClass += ' tag-danger'; break;
                        default: statusClass += ' tag-warning';
                    }
                    
                    html += `
                        <tr>
                            <td>${raceName}</td>
                            <td>${formatNumber(count)}äºº</td>
                            <td>${percentage}%</td>
                            <td><span class="${statusClass}">${status}</span></td>
                            <td style="font-size: 11px;">${ability}</td>
                        </tr>
                    `;
                });
            } else {
                html += '<tr><td colspan="5" style="text-align: center; color: #dc3545;">æ— æ³•åŠ è½½ç§æ—æ•°æ®</td></tr>';
            }
            
            container.innerHTML = html;
        }
        
        // åŠ è½½èŒä¸šè¯¦æƒ…
        function loadOccupationDetails() {
            const container = document.getElementById('occupation-details');
            if (!container) return;
            
            const jobs = territoryData.äººå£?.èŒä¸šåˆ†å¸ƒ || {};
            const total = extractValue(territoryData.äººå£?.æ€»äººå£, 1250);
            
            let html = `
                <tr>
                    <th>èŒä¸š</th>
                    <th>äººæ•°</th>
                    <th>å æ¯”</th>
                    <th>æœˆè´¡çŒ®</th>
                    <th>æ»¡æ„åº¦</th>
                </tr>
            `;
            
            if (typeof jobs === 'object' && jobs !== null) {
                Object.entries(jobs).forEach(([name, data]) => {
                    if (typeof data === 'object' && data !== null) {
                        const count = extractValue(data.äººæ•°, 0);
                        const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                        const contribution = extractValue(data.æœˆè´¡çŒ®, 0);
                        const satisfaction = extractValue(data.æ»¡æ„åº¦, 0);
                        
                        const contributionColor = contribution >= 0 ? '#28a745' : '#dc3545';
                        const satisfactionColor = getMoraleColor(satisfaction);
                        
                        html += `
                            <tr>
                                <td>${name}</td>
                                <td>${formatNumber(count)}äºº</td>
                                <td>${percentage}%</td>
                                <td style="color: ${contributionColor}; font-weight: bold;">
                                    ${contribution >= 0 ? '+' : ''}${contribution}é‡‘å¸
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: ${satisfactionColor};">${satisfaction}/100</span>
                                        <div class="progress" style="flex: 1;">
                                            <div class="progress-bar" style="width: ${satisfaction}%"></div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
            }
            
            container.innerHTML = html;
        }
        
        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            await fetchFromMVU();
        }
        
        // æ˜¾ç¤ºè°ƒè¯•é¢æ¿
        function showDebugPanel() {
            debugMode = !debugMode;
            const debugSection = document.getElementById('debug-section');
            const debugInfo = document.getElementById('debug-info');
            
            if (debugMode) {
                debugSection.style.display = 'block';
                
                let debugHtml = '<div class="debug-panel">';
                
                // æ˜¾ç¤ºå½“å‰æ•°æ®çŠ¶æ€
                debugHtml += '<div class="debug-item"><span class="debug-key">æ•°æ®çŠ¶æ€:</span> <span class="debug-value">' + (territoryData ? 'å·²åŠ è½½' : 'æœªåŠ è½½') + '</span></div>';
                
                if (territoryData) {
                    // æ˜¾ç¤ºå…³é”®æ•°æ®
                    debugHtml += '<div class="debug-item"><span class="debug-key">æ€»äººå£:</span> <span class="debug-value">' + extractValue(territoryData.äººå£?.æ€»äººå£, 'N/A') + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">å›½åº“èµ„é‡‘:</span> <span class="debug-value">' + extractValue(territoryData.ç»æµ?.è´¢æ”¿?.åº“å­˜é‡‘å¸, 'N/A') + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">äººç±»æ•°é‡:</span> <span class="debug-value">' + (territoryData.äººå£?.ç§æ—æ„æˆ?.äººç±» ? extractValue(territoryData.äººå£.ç§æ—æ„æˆ.äººç±».æ•°é‡, 'N/A') : 'N/A') + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">ç§æ—æ„æˆç±»å‹:</span> <span class="debug-value">' + (Array.isArray(territoryData.äººå£?.ç§æ—æ„æˆ) ? 'æ•°ç»„' : typeof territoryData.äººå£?.ç§æ—æ„æˆ) + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">æœ€åæ›´æ–°:</span> <span class="debug-value">' + (lastUpdate ? lastUpdate.toLocaleTimeString() : 'N/A') + '</span></div>';
                }
                
                debugHtml += '</div>';
                
                debugInfo.innerHTML = debugHtml;
            } else {
                debugSection.style.display = 'none';
            }
            
            adjustIframeHeight();
        }
        
        // å·¥å…·å‡½æ•°
        function formatNumber(num) {
            const number = typeof num === 'number' ? num : 0;
            return number.toLocaleString();
        }
        
        function formatCurrency(amount, showSign = false) {
            const num = typeof amount === 'number' ? amount : 0;
            let formatted = num.toLocaleString() + ' é‡‘å¸';
            if (showSign) {
                formatted = (num >= 0 ? '+' : '') + formatted;
            }
            return formatted;
        }
        
        function getThreatColor(threat) {
            if (!threat) return '#6c757d';
            switch(threat) {
                case 'å®‰å…¨': return '#28a745';
                case 'è­¦æˆ’': return '#ffc107';
                case 'å±é™©': return '#dc3545';
                case 'æå±é™©': return '#721c24';
                default: return '#6c757d';
            }
        }
        
        function getMoraleColor(morale) {
            const num = typeof morale === 'number' ? morale : 0;
            if (num > 70) return '#28a745';
            if (num > 40) return '#ffc107';
            return '#dc3545';
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('é¢†åœ°çŠ¶æ€é¢æ¿åˆå§‹åŒ–...');
            fetchFromMVU();
        });
    </script>
</body>
</html>
