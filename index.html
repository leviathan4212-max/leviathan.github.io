<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢†åœ°ç»è¥çŠ¶æ€é¢æ¿</title>
    
    <!-- Vue 3 å’Œ Pinia -->
    <script type="module">
        import { createApp, ref, computed, watch, onMounted, defineComponent } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { createPinia, defineStore, storeToRefs } from 'https://unpkg.com/pinia@2/dist/pinia.esm-browser.js';
        
        // ========== Pinia å­˜å‚¨å®šä¹‰ ==========
        const pinia = createPinia();
        
        // é¢†åœ°æ•°æ®å­˜å‚¨
        const useTerritoryStore = defineStore('territory', () => {
            const data = ref(null);
            const loading = ref(true);
            const error = ref(null);
            const lastUpdate = ref(null);
            
            // ä»MVUè·å–é¢†åœ°æ•°æ®
            async function fetchData() {
                try {
                    loading.value = true;
                    
                    // å‡è®¾MVUæ’ä»¶æä¾›å…¨å±€çš„getVariableså‡½æ•°
                    const mvuData = await getVariables({ type: 'message', message_id: getCurrentMessageId() });
                    
                    // ä»MVUæ•°æ®ä¸­æå–é¢†åœ°ä¿¡æ¯
                    // æ ¹æ®æ‚¨çš„å˜é‡ç»“æ„3.0ï¼Œæ•°æ®è·¯å¾„ä¸º root.Territory
                    const territoryData = mvuData?.Territory || null;
                    
                    if (!territoryData) {
                        throw new Error('æ— æ³•è·å–é¢†åœ°æ•°æ®ï¼šMVUå˜é‡ä¸­æœªæ‰¾åˆ°Territoryå¯¹è±¡');
                    }
                    
                    data.value = territoryData;
                    error.value = null;
                    lastUpdate.value = new Date();
                    
                    console.log('[é¢†åœ°å­˜å‚¨] æ•°æ®å·²æ›´æ–°:', territoryData);
                } catch (err) {
                    console.error('[é¢†åœ°å­˜å‚¨] è·å–æ•°æ®å¤±è´¥:', err);
                    error.value = err.message || 'æœªçŸ¥é”™è¯¯';
                } finally {
                    loading.value = false;
                }
            }
            
            // æ›´æ–°ç‰¹å®šå˜é‡
            async function updateVariable(path, value) {
                try {
                    // é€šè¿‡MVU APIä¿®æ”¹å˜é‡
                    const mvuData = await getVariables({ type: 'message', message_id: getCurrentMessageId() });
                    
                    // ä½¿ç”¨lodashçš„setæ–¹æ³•æˆ–è‡ªå®šä¹‰å®ç°
                    _.set(mvuData, `Territory.${path}`, value);
                    
                    // ä¿å­˜å›MVU
                    await replaceMvuData(mvuData, { type: 'message', message_id: getCurrentMessageId() });
                    
                    // é‡æ–°è·å–æ•°æ®
                    await fetchData();
                    
                    return true;
                } catch (err) {
                    console.error('[é¢†åœ°å­˜å‚¨] æ›´æ–°å˜é‡å¤±è´¥:', err);
                    return false;
                }
            }
            
            // è§¦å‘æœˆåº¦ç»“ç®—
            async function triggerMonthlySettlement() {
                try {
                    // è°ƒç”¨MVUä¸­çš„ç»“ç®—å‡½æ•°
                    await executeMvuCode('Territory.monthlySettlement()');
                    await fetchData();
                    return true;
                } catch (err) {
                    console.error('[é¢†åœ°å­˜å‚¨] æœˆåº¦ç»“ç®—å¤±è´¥:', err);
                    return false;
                }
            }
            
            // è®¡ç®—å±æ€§ï¼šå¿«é€Ÿè®¿é—®å¸¸ç”¨æ•°æ®
            const basicInfo = computed(() => data.value?.åŸºæœ¬ä¿¡æ¯ || {});
            const population = computed(() => data.value?.äººå£ || {});
            const economy = computed(() => data.value?.ç»æµ || {});
            const warehouse = computed(() => data.value?.ä»“åº“ || {});
            const military = computed(() => data.value?.å†›äº‹ || {});
            const residents = computed(() => data.value?.çŠ¶æ€?.å±…æ°‘çŠ¶æ€ || {});
            const resources = computed(() => data.value?.èµ„æº || {});
            const buildings = computed(() => data.value?.å»ºç­‘ || {});
            const tech = computed(() => data.value?.ç§‘æŠ€ || {});
            const races = computed(() => data.value?.äººå£?.ç§æ—æ„æˆ || {});
            const projects = computed(() => data.value?.é¡¹ç›® || {});
            const decrees = computed(() => data.value?.æ³•ä»¤ || {});
            
            // è®¡ç®—æ€»äººå£
            const totalPopulation = computed(() => population.value?.æ€»äººå£ || 0);
            
            // è®¡ç®—è´¢æ”¿å¥åº·åº¦
            const financialHealth = computed(() => {
                const income = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ || 0;
                const expense = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¯å‡º || 0;
                if (income > expense * 1.2) return 'excellent';
                if (income > expense) return 'good';
                if (income === expense) return 'balanced';
                if (income < expense * 0.8) return 'critical';
                return 'warning';
            });
            
            // è®¡ç®—ç‰©èµ„é¢„è­¦
            const resourceWarnings = computed(() => {
                const warnings = [];
                const warehouseData = warehouse.value;
                
                // æ£€æŸ¥æ¯ç§ç‰©èµ„æ˜¯å¦ä½äºå®‰å…¨å‚¨é‡
                for (const [key, item] of Object.entries(warehouseData)) {
                    if (item.å½“å‰å‚¨é‡ < item.å®‰å…¨å‚¨é‡) {
                        warnings.push({
                            name: item.åç§°,
                            current: item.å½“å‰å‚¨é‡,
                            safe: item.å®‰å…¨å‚¨é‡,
                            unit: item.å•ä½
                        });
                    }
                }
                
                return warnings;
            });
            
            // è®¡ç®—ç§‘æŠ€è¿›å±•
            const techProgress = computed(() => {
                const techData = tech.value || {};
                const categories = {
                    completed: [],
                    inProgress: [],
                    available: []
                };
                
                Object.values(techData).forEach(item => {
                    if (!item.ç ”å‘çŠ¶æ€) return;
                    
                    switch(item.ç ”å‘çŠ¶æ€[0]) {
                        case 'å·²ç ”å‘':
                            categories.completed.push(item);
                            break;
                        case 'ç ”å‘ä¸­':
                            categories.inProgress.push(item);
                            break;
                        case 'æœªç ”å‘':
                            categories.available.push(item);
                            break;
                    }
                });
                
                return categories;
            });
            
            // è®¡ç®—å»ºç­‘çŠ¶æ€
            const buildingStatus = computed(() => {
                const buildingData = buildings.value || {};
                const status = {
                    normal: [],
                    constructing: [],
                    upgrading: [],
                    damaged: [],
                    abandoned: []
                };
                
                Object.values(buildingData).forEach(building => {
                    if (!building.çŠ¶æ€) return;
                    
                    switch(building.çŠ¶æ€[0]) {
                        case 'æ­£å¸¸è¿è¥':
                            status.normal.push(building);
                            break;
                        case 'å»ºè®¾ä¸­':
                            status.constructing.push(building);
                            break;
                        case 'å‡çº§ä¸­':
                            status.upgrading.push(building);
                            break;
                        case 'æŸå':
                            status.damaged.push(building);
                            break;
                        case 'åºŸå¼ƒ':
                            status.abandoned.push(building);
                            break;
                    }
                });
                
                return status;
            });
            
            // åˆå§‹åŒ–
            onMounted(() => {
                fetchData();
                // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
                setInterval(fetchData, 30000);
            });
            
            return {
                // çŠ¶æ€
                data,
                loading,
                error,
                lastUpdate,
                
                // è®¡ç®—å±æ€§
                basicInfo,
                population,
                economy,
                warehouse,
                military,
                residents,
                resources,
                buildings,
                tech,
                races,
                projects,
                decrees,
                totalPopulation,
                financialHealth,
                resourceWarnings,
                techProgress,
                buildingStatus,
                
                // æ–¹æ³•
                fetchData,
                updateVariable,
                triggerMonthlySettlement
            };
        });
        
        // ========== å¯æŠ˜å é¢æ¿ç»„ä»¶ ==========
        const CollapsiblePanel = defineComponent({
            props: {
                title: String,
                icon: String,
                defaultOpen: {
                    type: Boolean,
                    default: false
                },
                summary: String,
                variant: {
                    type: String,
                    default: 'default' // default, warning, danger, success, info
                }
            },
            setup(props, { slots }) {
                const isOpen = ref(props.defaultOpen);
                const toggle = () => { isOpen.value = !isOpen.value; };
                
                const variantClass = computed(() => {
                    return `panel-${props.variant}`;
                });
                
                return {
                    isOpen,
                    toggle,
                    variantClass
                };
            },
            template: `
                <div class="collapsible-panel" :class="variantClass">
                    <div class="panel-header" @click="toggle">
                        <div class="header-left">
                            <span class="panel-icon">{{ icon }}</span>
                            <span class="panel-title">{{ title }}</span>
                            <span v-if="summary" class="panel-summary">{{ summary }}</span>
                        </div>
                        <span class="toggle-arrow" :class="{ open: isOpen }">â–¼</span>
                    </div>
                    <transition name="slide">
                        <div v-show="isOpen" class="panel-content">
                            <slot></slot>
                        </div>
                    </transition>
                </div>
            `
        });
        
        // ========== æ•°æ®å¡ç‰‡ç»„ä»¶ ==========
        const DataCard = defineComponent({
            props: {
                title: String,
                value: [String, Number],
                icon: String,
                unit: String,
                trend: String, // up, down, stable
                color: String,
                size: {
                    type: String,
                    default: 'medium' // small, medium, large
                }
            },
            setup(props) {
                const formattedValue = computed(() => {
                    const num = Number(props.value);
                    if (!isNaN(num)) {
                        return num.toLocaleString();
                    }
                    return props.value;
                });
                
                const trendIcon = computed(() => {
                    switch(props.trend) {
                        case 'up': return 'ğŸ“ˆ';
                        case 'down': return 'ğŸ“‰';
                        case 'stable': return 'âš–ï¸';
                        default: return '';
                    }
                });
                
                return {
                    formattedValue,
                    trendIcon
                };
            },
            template: `
                <div class="data-card" :class="'size-' + size">
                    <div class="card-header">
                        <span v-if="icon" class="card-icon">{{ icon }}</span>
                        <span class="card-title">{{ title }}</span>
                    </div>
                    <div class="card-value" :style="{ color: color }">
                        {{ formattedValue }}<span v-if="unit" class="unit">{{ unit }}</span>
                        <span v-if="trendIcon" class="trend">{{ trendIcon }}</span>
                    </div>
                </div>
            `
        });
        
        // ========== è¿›åº¦æ¡ç»„ä»¶ ==========
        const ProgressBar = defineComponent({
            props: {
                value: Number,
                max: Number,
                label: String,
                color: String,
                showPercentage: {
                    type: Boolean,
                    default: true
                },
                height: {
                    type: String,
                    default: '8px'
                }
            },
            setup(props) {
                const percentage = computed(() => {
                    if (!props.max) return 0;
                    return Math.min(100, (props.value / props.max) * 100);
                });
                
                const barColor = computed(() => {
                    if (props.color) return props.color;
                    if (percentage.value < 30) return '#f44336'; // çº¢è‰²
                    if (percentage.value < 70) return '#ff9800'; // æ©™è‰²
                    return '#4caf50'; // ç»¿è‰²
                });
                
                return {
                    percentage,
                    barColor
                };
            },
            template: `
                <div class="progress-container">
                    <div v-if="label" class="progress-label">
                        <span>{{ label }}</span>
                        <span v-if="showPercentage" class="percentage">{{ Math.round(percentage) }}%</span>
                    </div>
                    <div class="progress-bar" :style="{ height: height }">
                        <div class="progress-fill" :style="{
                            width: percentage + '%',
                            backgroundColor: barColor
                        }"></div>
                    </div>
                </div>
            `
        });
        
        // ========== ä¸»åº”ç”¨ç»„ä»¶ ==========
        const App = defineComponent({
            setup() {
                const store = useTerritoryStore();
                const { 
                    data, loading, error, lastUpdate,
                    basicInfo, population, economy, warehouse, military, residents,
                    totalPopulation, financialHealth, resourceWarnings, techProgress, buildingStatus
                } = storeToRefs(store);
                
                // æ ¼å¼åŒ–æ—¶é—´
                const formattedTime = computed(() => {
                    if (!lastUpdate.value) return 'ä»æœªæ›´æ–°';
                    return lastUpdate.value.toLocaleTimeString();
                });
                
                // åˆ·æ–°æ•°æ®
                const refreshData = () => {
                    store.fetchData();
                };
                
                // æ‰§è¡Œæœˆåº¦ç»“ç®—
                const runMonthlySettlement = async () => {
                    const confirmed = confirm('ç¡®å®šè¦æ‰§è¡Œæœˆåº¦ç»“ç®—å—ï¼Ÿè¿™å°†æ›´æ–°æ‰€æœ‰ç»æµæ•°æ®ã€‚');
                    if (confirmed) {
                        await store.triggerMonthlySettlement();
                    }
                };
                
                // è®¡ç®—å¨èƒç­‰çº§é¢œè‰²
                const threatColor = computed(() => {
                    const threat = residents.value?.å¨èƒç­‰çº§;
                    switch(threat) {
                        case 'å®‰å…¨': return '#4caf50';
                        case 'è­¦æˆ’': return '#ff9800';
                        case 'å±é™©': return '#f44336';
                        case 'æå±é™©': return '#9c27b0';
                        default: return '#757575';
                    }
                });
                
                // è®¡ç®—æ”¶æ”¯çŠ¶æ€
                const balanceStatus = computed(() => {
                    const income = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ || 0;
                    const expense = economy.value?.è´¢æ”¿?.æœˆæ€»æ”¯å‡º || 0;
                    const net = income - expense;
                    
                    if (net > 0) return { text: 'ç›ˆä½™', icon: 'ğŸ“ˆ', color: '#4caf50' };
                    if (net < 0) return { text: 'äºæŸ', icon: 'ğŸ“‰', color: '#f44336' };
                    return { text: 'å¹³è¡¡', icon: 'âš–ï¸', color: '#ff9800' };
                });
                
                return {
                    // çŠ¶æ€
                    data,
                    loading,
                    error,
                    formattedTime,
                    
                    // æ•°æ®
                    basicInfo,
                    population,
                    economy,
                    warehouse,
                    military,
                    residents,
                    totalPopulation,
                    financialHealth,
                    resourceWarnings,
                    techProgress,
                    buildingStatus,
                    
                    // è®¡ç®—å€¼
                    threatColor,
                    balanceStatus,
                    
                    // æ–¹æ³•
                    refreshData,
                    runMonthlySettlement
                };
            },
            template: `
                <div class="territory-dashboard">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="dashboard-toolbar">
                        <div class="toolbar-left">
                            <h1 class="dashboard-title">ğŸ° {{ basicInfo.åç§° || 'é¢†åœ°çŠ¶æ€é¢æ¿' }}</h1>
                            <span class="update-time">æœ€åæ›´æ–°: {{ formattedTime }}</span>
                        </div>
                        <div class="toolbar-right">
                            <button @click="refreshData" class="btn btn-refresh" :disabled="loading">
                                <span v-if="loading">åˆ·æ–°ä¸­...</span>
                                <span v-else>ğŸ”„ åˆ·æ–°æ•°æ®</span>
                            </button>
                            <button @click="runMonthlySettlement" class="btn btn-settlement">
                                ğŸ“… æœˆåº¦ç»“ç®—
                            </button>
                        </div>
                    </div>
                    
                    <!-- é”™è¯¯æ˜¾ç¤º -->
                    <div v-if="error" class="error-alert">
                        âŒ é”™è¯¯: {{ error }}
                    </div>
                    
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div v-if="loading && !data" class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½é¢†åœ°æ•°æ®...</p>
                    </div>
                    
                    <!-- ä¸»è¦å†…å®¹ -->
                    <div v-if="data" class="dashboard-content">
                        
                        <!-- ç¬¬ä¸€è¡Œ: å…³é”®æŒ‡æ ‡ -->
                        <div class="metrics-row">
                            <DataCard 
                                title="æ€»äººå£" 
                                :value="totalPopulation" 
                                icon="ğŸ‘¥" 
                                unit="äºº"
                                size="large"
                                color="#2196f3"
                            />
                            <DataCard 
                                title="å›½åº“èµ„é‡‘" 
                                :value="economy?.è´¢æ”¿?.åº“å­˜é‡‘å¸" 
                                icon="ğŸ’°" 
                                unit="é‡‘å¸"
                                size="large"
                                color="#ffc107"
                            />
                            <DataCard 
                                title="æœˆåº¦æ”¶æ”¯" 
                                :value="economy?.è´¢æ”¿?.æœˆå‡€æ”¶å…¥" 
                                icon="ğŸ’¸"
                                :trend="balanceStatus.icon"
                                :color="balanceStatus.color"
                                size="large"
                            />
                            <DataCard 
                                title="å¨èƒç­‰çº§" 
                                :value="residents?.å¨èƒç­‰çº§" 
                                icon="âš ï¸"
                                :color="threatColor"
                                size="medium"
                            />
                            <DataCard 
                                title="æ°‘å¿ƒæŒ‡æ•°" 
                                :value="residents?.æ°‘å¿ƒæŒ‡æ•°" 
                                icon="â¤ï¸"
                                unit=""
                                size="medium"
                                :color="residents?.æ°‘å¿ƒæŒ‡æ•° > 70 ? '#4caf50' : residents?.æ°‘å¿ƒæŒ‡æ•° > 40 ? '#ff9800' : '#f44336'"
                            />
                        </div>
                        
                        <!-- ç¬¬äºŒè¡Œ: è¯¦ç»†é¢æ¿ -->
                        <div class="panels-row">
                            
                            <!-- å·¦ä¾§åˆ— -->
                            <div class="panel-column">
                                <!-- åŸºç¡€ä¿¡æ¯ -->
                                <CollapsiblePanel title="ğŸ“‹ é¢†åœ°åŸºç¡€ä¿¡æ¯" icon="ğŸ°" defaultOpen>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <span class="info-label">é¢†åœ°åç§°:</span>
                                            <span class="info-value">{{ basicInfo.åç§° }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">é¢†åœ°é¢ç§¯:</span>
                                            <span class="info-value">{{ basicInfo.é¢ç§¯ }} å¹³æ–¹é‡Œ</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">åœ°å½¢ç‰¹å¾:</span>
                                            <span class="info-value">{{ basicInfo.åœ°å½¢ }}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">å‘å±•é˜¶æ®µ:</span>
                                            <span class="info-value">{{ basicInfo.å‘å±•é˜¶æ®µ }}</span>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                                
                                <!-- äººå£ä¸ç§æ— -->
                                <CollapsiblePanel title="ğŸ‘¥ äººå£ä¸ç§æ—æ„æˆ" icon="ğŸŒ">
                                    <div class="population-section">
                                        <h4>æ€»äººå£: {{ totalPopulation }} äºº</h4>
                                        <ProgressBar 
                                            :value="population?.èŒä¸šåˆ†å¸ƒ?.å†œæ°‘?.äººæ•° || 0"
                                            :max="totalPopulation"
                                            label="å†œæ°‘"
                                            color="#8bc34a"
                                        />
                                        <ProgressBar 
                                            :value="population?.èŒä¸šåˆ†å¸ƒ?.å·¥åŒ ?.äººæ•° || 0"
                                            :max="totalPopulation"
                                            label="å·¥åŒ "
                                            color="#ff9800"
                                        />
                                        <ProgressBar 
                                            :value="population?.èŒä¸šåˆ†å¸ƒ?.å•†äºº?.äººæ•° || 0"
                                            :max="totalPopulation"
                                            label="å•†äºº"
                                            color="#2196f3"
                                        />
                                        
                                        <div v-if="races && Object.keys(races).length > 0" class="races-section">
                                            <h4>ç§æ—æ„æˆ</h4>
                                            <div class="races-grid">
                                                <div v-for="(race, raceName) in races" :key="raceName" class="race-item">
                                                    <span class="race-name">{{ raceName }}</span>
                                                    <span class="race-count">{{ race.æ•°é‡ }}äºº</span>
                                                    <span class="race-status" :class="'status-' + race.åœ°ä½">{{ race.åœ°ä½ }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                                
                                <!-- èµ„æºä¸ä»“åº“ -->
                                <CollapsiblePanel title="ğŸª ä»“åº“ç‰©èµ„å‚¨å¤‡" icon="ğŸ“¦">
                                    <div class="warehouse-section">
                                        <div v-if="resourceWarnings.length > 0" class="resource-warnings">
                                            <h4 style="color: #f44336;">âš ï¸ ç‰©èµ„é¢„è­¦</h4>
                                            <div v-for="warning in resourceWarnings" :key="warning.name" class="warning-item">
                                                {{ warning.name }}: {{ warning.current }}{{ warning.unit }} (å®‰å…¨çº¿: {{ warning.safe }}{{ warning.unit }})
                                            </div>
                                        </div>
                                        
                                        <div class="resources-grid">
                                            <div v-for="(item, key) in warehouse" :key="key" class="resource-item">
                                                <span class="resource-name">{{ item.åç§° }}</span>
                                                <span class="resource-amount">{{ item.å½“å‰å‚¨é‡ }}{{ item.å•ä½ }}</span>
                                                <ProgressBar 
                                                    :value="item.å½“å‰å‚¨é‡"
                                                    :max="item.å®‰å…¨å‚¨é‡ * 2"
                                                    :showPercentage="false"
                                                    height="4px"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                            </div>
                            
                            <!-- ä¸­é—´åˆ— -->
                            <div class="panel-column">
                                <!-- ç»æµçŠ¶å†µ -->
                                <CollapsiblePanel title="ğŸ’° ç»æµä¸è´¢æ”¿" icon="ğŸ’" defaultOpen>
                                    <div class="economy-section">
                                        <div class="economy-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">æœˆæ”¶å…¥:</span>
                                                <span class="stat-value income">{{ economy?.è´¢æ”¿?.æœˆæ€»æ”¶å…¥ }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">æœˆæ”¯å‡º:</span>
                                                <span class="stat-value expense">{{ economy?.è´¢æ”¿?.æœˆæ€»æ”¯å‡º }} é‡‘å¸</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">å‡€æ”¶å…¥:</span>
                                                <span class="stat-value" :class="balanceStatus.text">{{ economy?.è´¢æ”¿?.æœˆå‡€æ”¶å…¥ }} é‡‘å¸ {{ balanceStatus.icon }}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">å›½åº“èµ„é‡‘:</span>
                                                <span class="stat-value treasury">{{ economy?.è´¢æ”¿?.åº“å­˜é‡‘å¸ }} é‡‘å¸</span>
                                            </div>
                                        </div>
                                        
                                        <div class="taxes-section">
                                            <h4>ç¨ç‡ä½“ç³»</h4>
                                            <div class="taxes-grid">
                                                <div class="tax-item">
                                                    <span>å†œä¸šç¨: {{ (economy?.å…¬å…±ç¨ç‡?.å†œä¸šç¨ * 100).toFixed(1) }}%</span>
                                                </div>
                                                <div class="tax-item">
                                                    <span>å•†ä¸šç¨: {{ (economy?.å…¬å…±ç¨ç‡?.å•†ä¸šç¨ * 100).toFixed(1) }}%</span>
                                                </div>
                                                <div class="tax-item">
                                                    <span>å·¥ä¸šç¨: {{ (economy?.å…¬å…±ç¨ç‡?.å·¥ä¸šç¨ * 100).toFixed(1) }}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                                
                                <!-- å†›äº‹ä¸é˜²å¾¡ -->
                                <CollapsiblePanel title="âš”ï¸ å†›äº‹ä¸é˜²å¾¡" icon="ğŸ›¡ï¸">
                                    <div class="military-section">
                                        <div class="military-stats">
                                            <div class="military-item">
                                                <span class="military-label">å¸¸å¤‡å†›:</span>
                                                <span class="military-value">{{ military?.å…µåŠ›?.å¸¸å¤‡å†› }} äºº</span>
                                            </div>
                                            <div class="military-item">
                                                <span class="military-label">æ°‘å…µ:</span>
                                                <span class="military-value">{{ military?.å…µåŠ›?.æ°‘å…µ }} äºº</span>
                                            </div>
                                            <div class="military-item">
                                                <span class="military-label">ç²¾é”éƒ¨é˜Ÿ:</span>
                                                <span class="military-value">{{ military?.å…µåŠ›?.ç²¾é”éƒ¨é˜Ÿ }} äºº</span>
                                            </div>
                                            <div class="military-item">
                                                <span class="military-label">æ€»æˆ˜åŠ›è¯„çº§:</span>
                                                <span class="military-value rating">{{ military?.æˆ˜åŠ›è¯„çº§?.æ€»è¯„çº§ }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="defense-section">
                                            <h4>é˜²å¾¡è®¾æ–½</h4>
                                            <div class="defense-grid">
                                                <div class="defense-item">
                                                    <span>åŸå¢™å®Œæ•´åº¦:</span>
                                                    <ProgressBar :value="military?.é˜²å¾¡è®¾æ–½?.åŸå¢™å®Œæ•´åº¦ * 100" :max="100" />
                                                </div>
                                                <div class="defense-item">
                                                    <span>ç­æœ›å¡”: {{ military?.é˜²å¾¡è®¾æ–½?.ç­æœ›å¡”æ•°é‡ }} åº§</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                                
                                <!-- å±…æ°‘çŠ¶æ€ -->
                                <CollapsiblePanel title="ğŸ  å±…æ°‘ä¸ç¤¾ä¼šçŠ¶æ€" icon="â¤ï¸">
                                    <div class="residents-section">
                                        <div class="resident-stats">
                                            <div class="resident-item">
                                                <span class="resident-label">ç”Ÿæ´»æ°´å¹³:</span>
                                                <span class="resident-value">{{ residents?.ç”Ÿæ´»æ°´å¹³ }}</span>
                                            </div>
                                            <div class="resident-item">
                                                <span class="resident-label">æ²»å®‰çŠ¶å†µ:</span>
                                                <span class="resident-value">{{ residents?.æ²»å®‰çŠ¶å†µ }}</span>
                                            </div>
                                            <div class="resident-item">
                                                <span class="resident-label">æ°‘å¿ƒæŒ‡æ•°:</span>
                                                <ProgressBar 
                                                    :value="residents?.æ°‘å¿ƒæŒ‡æ•°" 
                                                    :max="100"
                                                    :showPercentage="true"
                                                    height="6px"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div v-if="residents?.å½“å‰äº‹ä»¶ && residents.å½“å‰äº‹ä»¶ !== 'æš‚æ— '" class="current-event">
                                            <h4>ğŸ“Œ å½“å‰äº‹ä»¶</h4>
                                            <p>{{ residents.å½“å‰äº‹ä»¶ }}</p>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                            </div>
                            
                            <!-- å³ä¾§åˆ— -->
                            <div class="panel-column">
                                <!-- ç§‘æŠ€ç ”å‘ -->
                                <CollapsiblePanel title="ğŸ”¬ ç§‘æŠ€ç ”å‘è¿›å±•" icon="âš™ï¸">
                                    <div class="tech-section">
                                        <div v-if="techProgress.completed.length > 0" class="tech-category">
                                            <h4>âœ… å·²ç ”å‘ç§‘æŠ€</h4>
                                            <div class="tech-list">
                                                <div v-for="tech in techProgress.completed" :key="tech.åç§°" class="tech-item completed">
                                                    {{ tech.åç§° }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div v-if="techProgress.inProgress.length > 0" class="tech-category">
                                            <h4>ğŸ”„ ç ”å‘ä¸­ç§‘æŠ€</h4>
                                            <div class="tech-list">
                                                <div v-for="tech in techProgress.inProgress" :key="tech.åç§°" class="tech-item in-progress">
                                                    {{ tech.åç§° }} ({{ tech.å½“å‰è¿›åº¦ }}%)
                                                    <ProgressBar :value="tech.å½“å‰è¿›åº¦" :max="100" height="4px" />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div v-if="techProgress.available.length > 0" class="tech-category">
                                            <h4>ğŸ“š å¯ç ”å‘ç§‘æŠ€</h4>
                                            <div class="tech-list">
                                                <div v-for="tech in techProgress.available" :key="tech.åç§°" class="tech-item available">
                                                    {{ tech.åç§° }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                                
                                <!-- å»ºç­‘è®¾æ–½ -->
                                <CollapsiblePanel title="ğŸ›ï¸ å»ºç­‘è®¾æ–½" icon="ğŸ—ï¸">
                                    <div class="buildings-section">
                                        <div class="building-status-summary">
                                            <span>æ­£å¸¸è¿è¥: {{ buildingStatus.normal.length }}</span>
                                            <span>å»ºè®¾ä¸­: {{ buildingStatus.constructing.length }}</span>
                                            <span>å‡çº§ä¸­: {{ buildingStatus.upgrading.length }}</span>
                                        </div>
                                        
                                        <div class="buildings-grid">
                                            <div v-for="building in buildingStatus.normal" :key="building.id" class="building-item normal">
                                                <div class="building-header">
                                                    <span class="building-name">{{ building.åç§° }}</span>
                                                    <span class="building-level">Lv.{{ building.ç­‰çº§ }}</span>
                                                </div>
                                                <div class="building-info">
                                                    <span>å²—ä½: {{ building.å²—ä½?.å½“å‰äººæ•° }}/{{ building.å²—ä½?.æœ€å¤§äººæ•° }}</span>
                                                    <span v-if="building.äº§æƒ === 'private'">[ç§æœ‰]</span>
                                                </div>
                                            </div>
                                            
                                            <div v-for="building in buildingStatus.constructing" :key="building.id" class="building-item constructing">
                                                <div class="building-header">
                                                    <span class="building-name">{{ building.åç§° }}</span>
                                                    <span class="building-status">ğŸ”„ å»ºè®¾ä¸­</span>
                                                </div>
                                            </div>
                                            
                                            <div v-for="building in buildingStatus.upgrading" :key="building.id" class="building-item upgrading">
                                                <div class="building-header">
                                                    <span class="building-name">{{ building.åç§° }}</span>
                                                    <span class="building-status">â¬†ï¸ å‡çº§ä¸­</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                                
                                <!-- ç”Ÿäº§ä¸ä¾›åº”é“¾ -->
                                <CollapsiblePanel title="âš™ï¸ ç”Ÿäº§ä¸ä¾›åº”é“¾" icon="ğŸ”¨">
                                    <div class="production-section">
                                        <div v-if="buildingStatus.normal.some(b => b.ç”Ÿäº§é…æ–¹)" class="production-list">
                                            <h4>å½“å‰ç”Ÿäº§</h4>
                                            <div v-for="building in buildingStatus.normal" :key="building.id">
                                                <div v-if="building.ç”Ÿäº§é…æ–¹ && building.å²—ä½?.å½“å‰äººæ•° > 0" class="production-item">
                                                    <div class="production-header">
                                                        <span class="production-name">{{ building.åç§° }}</span>
                                                        <span class="production-efficiency">æ•ˆç‡: {{ (building.ç”Ÿäº§é…æ–¹?.ç”Ÿäº§æ•ˆç‡ * 100).toFixed(0) }}%</span>
                                                    </div>
                                                    <div class="production-details">
                                                        <div v-if="building.ç”Ÿäº§é…æ–¹?.æŠ•å…¥èµ„æº">
                                                            æŠ•å…¥:
                                                            <span v-for="(amount, resource) in building.ç”Ÿäº§é…æ–¹.æŠ•å…¥èµ„æº" :key="resource">
                                                                {{ amount * building.å²—ä½.å½“å‰äººæ•° }}{{ resource }}
                                                            </span>
                                                        </div>
                                                        <div v-if="building.ç”Ÿäº§é…æ–¹?.äº§å‡ºèµ„æº">
                                                            äº§å‡º:
                                                            <span v-for="(amount, resource) in building.ç”Ÿäº§é…æ–¹.äº§å‡ºèµ„æº" :key="resource">
                                                                {{ amount * building.å²—ä½.å½“å‰äººæ•° }}{{ resource }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="resource-regeneration">
                                            <h4>èµ„æºå†ç”Ÿ</h4>
                                            <div class="regeneration-item">
                                                æ£®æ—: {{ resources?.æ£®æ—èµ„æº?.å†ç”Ÿé€Ÿç‡ }} æ–¹/æœˆ
                                            </div>
                                            <div class="regeneration-item">
                                                çŸ¿è„‰: {{ resources?.çŸ¿è„‰èµ„æº?.å¼€é‡‡é€Ÿç‡ }} æ–¤/æœˆ
                                            </div>
                                        </div>
                                    </div>
                                </CollapsiblePanel>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åº•éƒ¨çŠ¶æ€æ  -->
                    <div class="dashboard-footer">
                        <div class="footer-left">
                            <span>é¢†åœ°ç»è¥ç³»ç»Ÿ v3.0 | MVUå˜é‡é©±åŠ¨</span>
                        </div>
                        <div class="footer-right">
                            <span>æ•°æ®æ¥æº: MVUå˜é‡ç³»ç»Ÿ</span>
                            <span class="footer-separator">|</span>
                            <span @click="refreshData" class="refresh-link">ç‚¹å‡»åˆ·æ–°</span>
                        </div>
                    </div>
                </div>
            `
        });
        
        // ========== åˆ›å»ºVueåº”ç”¨ ==========
        const app = createApp(App);
        app.use(pinia);
        
        // æŒ‚è½½åˆ°DOM
        document.addEventListener('DOMContentLoaded', () => {
            app.mount('#app');
        });
        
        // ========== å…¨å±€æ ·å¼ ==========
        const style = document.createElement('style');
        style.textContent = `
            :root {
                --primary-color: #2c3e50;
                --secondary-color: #34495e;
                --accent-color: #3498db;
                --success-color: #2ecc71;
                --warning-color: #f39c12;
                --danger-color: #e74c3c;
                --info-color: #9b59b6;
                --light-color: #ecf0f1;
                --dark-color: #2c3e50;
                --border-radius: 8px;
                --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                --transition-speed: 0.3s;
            }
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            
            .territory-dashboard {
                max-width: 1800px;
                margin: 0 auto;
                background: white;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                overflow: hidden;
            }
            
            /* å·¥å…·æ  */
            .dashboard-toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                background: var(--primary-color);
                color: white;
            }
            
            .toolbar-left {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .dashboard-title {
                font-size: 24px;
                font-weight: bold;
            }
            
            .update-time {
                font-size: 14px;
                opacity: 0.8;
            }
            
            .toolbar-right {
                display: flex;
                gap: 10px;
            }
            
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: var(--border-radius);
                cursor: pointer;
                font-weight: bold;
                transition: all var(--transition-speed);
            }
            
            .btn-refresh {
                background: var(--accent-color);
                color: white;
            }
            
            .btn-refresh:hover {
                background: #2980b9;
            }
            
            .btn-settlement {
                background: var(--success-color);
                color: white;
            }
            
            .btn-settlement:hover {
                background: #27ae60;
            }
            
            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            /* é”™è¯¯å’ŒåŠ è½½çŠ¶æ€ */
            .error-alert {
                margin: 20px;
                padding: 15px;
                background: var(--danger-color);
                color: white;
                border-radius: var(--border-radius);
            }
            
            .loading-overlay {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 100px 20px;
            }
            
            .loading-spinner {
                width: 50px;
                height: 50px;
                border: 5px solid #f3f3f3;
                border-top: 5px solid var(--accent-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* ä¸»è¦å†…å®¹ */
            .dashboard-content {
                padding: 20px;
            }
            
            /* æŒ‡æ ‡è¡Œ */
            .metrics-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            
            .data-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: var(--border-radius);
                padding: 15px;
                box-shadow: var(--box-shadow);
            }
            
            .data-card.size-large {
                grid-column: span 2;
            }
            
            .card-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .card-icon {
                font-size: 24px;
            }
            
            .card-title {
                font-weight: bold;
                color: var(--secondary-color);
            }
            
            .card-value {
                font-size: 32px;
                font-weight: bold;
            }
            
            .card-value .unit {
                font-size: 16px;
                margin-left: 5px;
                opacity: 0.7;
            }
            
            .card-value .trend {
                margin-left: 10px;
                font-size: 20px;
            }
            
            /* é¢æ¿è¡Œ */
            .panels-row {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            @media (max-width: 1200px) {
                .panels-row {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            
            @media (max-width: 768px) {
                .panels-row {
                    grid-template-columns: 1fr;
                }
            }
            
            .panel-column {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            
            /* å¯æŠ˜å é¢æ¿ */
            .collapsible-panel {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: var(--border-radius);
                overflow: hidden;
                box-shadow: var(--box-shadow);
            }
            
            .panel-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background: var(--light-color);
                cursor: pointer;
                transition: background var(--transition-speed);
            }
            
            .panel-header:hover {
                background: #d5dbdb;
            }
            
            .header-left {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .panel-icon {
                font-size: 20px;
            }
            
            .panel-title {
                font-weight: bold;
                font-size: 18px;
                color: var(--primary-color);
            }
            
            .panel-summary {
                font-size: 14px;
                color: #666;
                margin-left: 10px;
            }
            
            .toggle-arrow {
                transition: transform var(--transition-speed);
            }
            
            .toggle-arrow.open {
                transform: rotate(180deg);
            }
            
            .panel-content {
                padding: 20px;
            }
            
            .slide-enter-active, .slide-leave-active {
                transition: all var(--transition-speed);
                max-height: 1000px;
                overflow: hidden;
            }
            
            .slide-enter-from, .slide-leave-to {
                max-height: 0;
                opacity: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            
            /* ä¿¡æ¯ç½‘æ ¼ */
            .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .info-item {
                display: flex;
                justify-content: space-between;
                padding: 5px 0;
                border-bottom: 1px solid #eee;
            }
            
            .info-label {
                font-weight: bold;
                color: #666;
            }
            
            .info-value {
                color: var(--primary-color);
            }
            
            /* è¿›åº¦æ¡ */
            .progress-container {
                margin-bottom: 10px;
            }
            
            .progress-label {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 14px;
            }
            
            .progress-bar {
                background: #eee;
                border-radius: 10px;
                overflow: hidden;
            }
            
            .progress-fill {
                height: 100%;
                border-radius: 10px;
                transition: width 0.5s ease;
            }
            
            /* èµ„æºç½‘æ ¼ */
            .resources-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-top: 15px;
            }
            
            .resource-item {
                padding: 10px;
                border: 1px solid #eee;
                border-radius: var(--border-radius);
            }
            
            .resource-name {
                display: block;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .resource-amount {
                font-size: 18px;
                font-weight: bold;
                color: var(--accent-color);
            }
            
            /* ç»æµç»Ÿè®¡ */
            .economy-stats {
                display: grid;
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .stat-item {
                display: flex;
                justify-content: space-between;
                padding: 10px;
                background: #f8f9fa;
                border-radius: var(--border-radius);
            }
            
            .stat-label {
                font-weight: bold;
            }
            
            .stat-value {
                font-weight: bold;
            }
            
            .stat-value.income {
                color: var(--success-color);
            }
            
            .stat-value.expense {
                color: var(--danger-color);
            }
            
            .stat-value.treasury {
                color: var(--warning-color);
            }
            
            /* å»ºç­‘ç½‘æ ¼ */
            .buildings-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
                margin-top: 15px;
            }
            
            .building-item {
                padding: 10px;
                border-radius: var(--border-radius);
                border: 1px solid #eee;
            }
            
            .building-item.normal {
                border-left: 4px solid var(--success-color);
            }
            
            .building-item.constructing {
                border-left: 4px solid var(--warning-color);
            }
            
            .building-item.upgrading {
                border-left: 4px solid var(--accent-color);
            }
            
            .building-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 5px;
            }
            
            .building-name {
                font-weight: bold;
            }
            
            .building-level {
                background: #eee;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 12px;
            }
            
            /* ç§‘æŠ€åˆ—è¡¨ */
            .tech-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 10px;
            }
            
            .tech-item {
                padding: 10px;
                border-radius: var(--border-radius);
                border: 1px solid #eee;
            }
            
            .tech-item.completed {
                border-left: 4px solid var(--success-color);
                background: #f0fff4;
            }
            
            .tech-item.in-progress {
                border-left: 4px solid var(--accent-color);
                background: #f0f8ff;
            }
            
            .tech-item.available {
                border-left: 4px solid #ccc;
                background: #f9f9f9;
            }
            
            /* ç§æ—ç½‘æ ¼ */
            .races-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
                margin-top: 10px;
            }
            
            .race-item {
                padding: 10px;
                border: 1px solid #eee;
                border-radius: var(--border-radius);
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .race-name {
                font-weight: bold;
            }
            
            .race-count {
                font-size: 18px;
                color: var(--accent-color);
            }
            
            .race-status {
                font-size: 12px;
                padding: 2px 8px;
                border-radius: 10px;
                text-align: center;
            }
            
            .race-status.status-ä¸»å¯¼ {
                background: #d4edda;
                color: #155724;
            }
            
            .race-status.status-å¹³ç­‰ {
                background: #cce5ff;
                color: #004085;
            }
            
            .race-status.status-å—é™åˆ¶ {
                background: #fff3cd;
                color: #856404;
            }
            
            .race-status.status-å¥´éš¶ {
                background: #f8d7da;
                color: #721c24;
            }
            
            /* åº•éƒ¨æ  */
            .dashboard-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background: var(--light-color);
                border-top: 1px solid #ddd;
                font-size: 14px;
                color: #666;
            }
            
            .footer-right {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            
            .footer-separator {
                opacity: 0.5;
            }
            
            .refresh-link {
                color: var(--accent-color);
                cursor: pointer;
                text-decoration: underline;
            }
            
            .refresh-link:hover {
                color: var(--primary-color);
            }
            
            /* èµ„æºé¢„è­¦ */
            .resource-warnings {
                padding: 15px;
                background: #fff8f8;
                border: 1px solid #ffcccc;
                border-radius: var(--border-radius);
                margin-bottom: 15px;
            }
            
            .warning-item {
                padding: 5px 0;
                border-bottom: 1px dashed #ffcccc;
            }
            
            .warning-item:last-child {
                border-bottom: none;
            }
        `;
        
        document.head.appendChild(style);
        
        // ========== MVU API æ¨¡æ‹Ÿ (å¼€å‘ç¯å¢ƒ) ==========
        // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™äº›å‡½æ•°åº”è¯¥ç”±SillyTavernçš„MVUæ’ä»¶æä¾›
        if (typeof window.getVariables !== 'function') {
            console.warn('MVU APIæœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
            
            // æ¨¡æ‹ŸMVUæ•°æ® - åŸºäºæ‚¨çš„3.0ç‰ˆå˜é‡ç»“æ„
            const mockTerritoryData = {
                åŸºæœ¬ä¿¡æ¯: {
                    åç§°: "åŒ—å¢ƒè¾¹å¢ƒé¢†",
                    é¢ç§¯: 85,
                    åœ°å½¢: "ä¸˜é™µä¸æ£®æ—",
                    å‘å±•é˜¶æ®µ: "åˆå»º"
                },
                äººå£: {
                    æ€»äººå£: 1250,
                    èŒä¸šåˆ†å¸ƒ: {
                        å†œæ°‘: { äººæ•°: 700 },
                        å·¥åŒ : { äººæ•°: 120 },
                        å•†äºº: { äººæ•°: 60 },
                        å®˜å‘˜: { äººæ•°: 15 },
                        å£«å…µ: { äººæ•°: 80 },
                        æ— ä¸š: { äººæ•°: 275 }
                    },
                    ç§æ—æ„æˆ: {
                        äººç±»: { æ•°é‡: 900, åœ°ä½: "ä¸»å¯¼" },
                        çŸ®äºº: { æ•°é‡: 150, åœ°ä½: "å¹³ç­‰" },
                        åŠç²¾çµ: { æ•°é‡: 100, åœ°ä½: "å¹³ç­‰" },
                        å“¥å¸ƒæ—: { æ•°é‡: 50, åœ°ä½: "å¥´éš¶" }
                    }
                },
                ç»æµ: {
                    è´¢æ”¿: {
                        åº“å­˜é‡‘å¸: 2500,
                        æœˆæ€»æ”¶å…¥: 1850,
                        æœˆæ€»æ”¯å‡º: 1670,
                        æœˆå‡€æ”¶å…¥: 180
                    },
                    å…¬å…±ç¨ç‡: {
                        å†œä¸šç¨: 0.10,
                        å•†ä¸šç¨: 0.15,
                        å·¥ä¸šç¨: 0.12
                    }
                },
                ä»“åº“: {
                    res_food_grain: {
                        åç§°: "ç²®é£Ÿ",
                        å½“å‰å‚¨é‡: 6500,
                        å®‰å…¨å‚¨é‡: 3750,
                        å•ä½: "æ‹…"
                    },
                    res_material_wood: {
                        åç§°: "æœ¨æ",
                        å½“å‰å‚¨é‡: 900,
                        å®‰å…¨å‚¨é‡: 300,
                        å•ä½: "æ–¹"
                    },
                    res_material_stone: {
                        åç§°: "çŸ³æ",
                        å½“å‰å‚¨é‡: 500,
                        å®‰å…¨å‚¨é‡: 200,
                        å•ä½: "æ–¹"
                    },
                    res_material_iron: {
                        åç§°: "é“çŸ¿",
                        å½“å‰å‚¨é‡: 300,
                        å®‰å…¨å‚¨é‡: 100,
                        å•ä½: "æ–¤"
                    }
                },
                å†›äº‹: {
                    å…µåŠ›: {
                        å¸¸å¤‡å†›: 80,
                        æ°‘å…µ: 200,
                        ç²¾é”éƒ¨é˜Ÿ: 0
                    },
                    æˆ˜åŠ›è¯„çº§: {
                        æ€»è¯„çº§: "D"
                    },
                    é˜²å¾¡è®¾æ–½: {
                        åŸå¢™å®Œæ•´åº¦: 0.7,
                        ç­æœ›å¡”æ•°é‡: 2
                    }
                },
                çŠ¶æ€: {
                    å±…æ°‘çŠ¶æ€: {
                        ç”Ÿæ´»æ°´å¹³: "æ¸©é¥±",
                        æ²»å®‰çŠ¶å†µ: 65,
                        æ°‘å¿ƒæŒ‡æ•°: 70,
                        å½“å‰äº‹ä»¶: "æš‚æ— ",
                        å¨èƒç­‰çº§: "è­¦æˆ’"
                    }
                },
                ç§‘æŠ€: {
                    tech_basic_agriculture: {
                        åç§°: "åŸºç¡€å†œä¸šæŠ€æœ¯",
                        ç ”å‘çŠ¶æ€: ["å·²ç ”å‘"],
                        å½“å‰è¿›åº¦: 100
                    },
                    tech_iron_smelting: {
                        åç§°: "é“å™¨å†¶ç‚¼æŠ€æœ¯",
                        ç ”å‘çŠ¶æ€: ["ç ”å‘ä¸­"],
                        å½“å‰è¿›åº¦: 45
                    },
                    tech_basic_military_tactics: {
                        åç§°: "åŸºç¡€å†›äº‹æˆ˜æœ¯",
                        ç ”å‘çŠ¶æ€: ["æœªç ”å‘"],
                        å½“å‰è¿›åº¦: 0
                    }
                },
                å»ºç­‘: {
                    building_residential: {
                        åç§°: "å±…æ°‘åŒº",
                        ç­‰çº§: 2,
                        çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                        å²—ä½: { å½“å‰äººæ•°: 0, æœ€å¤§äººæ•°: 0 }
                    },
                    building_market: {
                        åç§°: "å¸‚åœº",
                        ç­‰çº§: 2,
                        çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                        å²—ä½: { å½“å‰äººæ•°: 25, æœ€å¤§äººæ•°: 40 },
                        äº§æƒ: "lord"
                    },
                    building_blacksmith: {
                        åç§°: "é“åŒ é“º",
                        ç­‰çº§: 1,
                        çŠ¶æ€: ["æ­£å¸¸è¿è¥"],
                        å²—ä½: { å½“å‰äººæ•°: 4, æœ€å¤§äººæ•°: 8 },
                        äº§æƒ: "private",
                        ç”Ÿäº§é…æ–¹: {
                            æŠ•å…¥èµ„æº: { res_material_iron: 2, res_material_wood: 1 },
                            äº§å‡ºèµ„æº: { item_weapon_spear: 3, item_tool_hammer: 5 },
                            ç”Ÿäº§æ•ˆç‡: 0.8
                        }
                    },
                    building_watchtower: {
                        åç§°: "åŒ—å¢ƒç­æœ›å¡”",
                        ç­‰çº§: 1,
                        çŠ¶æ€: ["å»ºè®¾ä¸­"],
                        å²—ä½: { å½“å‰äººæ•°: 0, æœ€å¤§äººæ•°: 5 },
                        äº§æƒ: "lord"
                    }
                },
                èµ„æº: {
                    æ£®æ—èµ„æº: { å†ç”Ÿé€Ÿç‡: 100, å¼€é‡‡é€Ÿç‡: 150 },
                    çŸ¿è„‰èµ„æº: { å¼€é‡‡é€Ÿç‡: 50 }
                },
                é¡¹ç›®: {
                    å½“å‰å»ºè®¾é¡¹ç›®: "åŒ—å¢ƒç­æœ›å¡”",
                    é¡¹ç›®è¿›åº¦: 30
                },
                æ³•ä»¤: {
                    decree_basic_tax: {
                        åç§°: "åŸºç¡€ç¨æ³•",
                        ç”Ÿæ•ˆçŠ¶æ€: [true]
                    }
                }
            };
            
            // æ¨¡æ‹ŸMVU APIå‡½æ•°
            window.getVariables = async function() {
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve({ Territory: mockTerritoryData });
                    }, 500);
                });
            };
            
            window.getCurrentMessageId = function() {
                return 'mock-message-id';
            };
            
            window.replaceMvuData = async function() {
                return new Promise(resolve => {
                    setTimeout(() => {
                        console.log('æ¨¡æ‹Ÿ: MVUæ•°æ®å·²æ›´æ–°');
                        resolve(true);
                    }, 300);
                });
            };
            
            window.executeMvuCode = async function(code) {
                console.log('æ¨¡æ‹Ÿ: æ‰§è¡ŒMVUä»£ç :', code);
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve(true);
                    }, 500);
                });
            };
            
            // æ¨¡æ‹Ÿlodash
            window._ = {
                set: function(obj, path, value) {
                    const keys = path.split('.');
                    let current = obj;
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) current[keys[i]] = {};
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = value;
                    return obj;
                }
            };
        }
    </script>
</head>
<body>
    <div id="app"></div>
</body>
</html>
