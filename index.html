<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢†åœ°ç»è¥çŠ¶æ€é¢æ¿</title>
    <style>
        /* å¼ºåˆ¶é‡ç½®æ‰€æœ‰æ ·å¼ */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            background: #F5E6C8 !important;
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif !important;
            color: #2C1810 !important;
            overflow-x: hidden !important;
        }
        
        /* ä¸»å®¹å™¨ */
        .territory-dashboard {
            background: #F5E6C8 !important;
            padding: 10px !important;
            min-height: 100vh !important;
        }
        
        /* æ ‡é¢˜æ  */
        .header {
            background: #E8D4A8 !important;
            border: 2px solid #8B6914 !important;
            border-radius: 8px !important;
            padding: 12px 15px !important;
            margin-bottom: 10px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        .header-left h1 {
            margin: 0 0 5px 0 !important;
            font-size: 18px !important;
            color: #2C1810 !important;
        }
        
        .header-left .game-time {
            font-size: 12px !important;
            color: #8B6914 !important;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons {
            display: flex !important;
            gap: 8px !important;
        }
        
        .btn {
            padding: 6px 12px !important;
            border: 1px solid #8B6914 !important;
            border-radius: 4px !important;
            background: #F5E6C8 !important;
            color: #2C1810 !important;
            font-size: 12px !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
        }
        
        .btn:hover {
            background: #E8D4A8 !important;
            transform: translateY(-1px) !important;
        }
        
        .btn-primary {
            background: #8B6914 !important;
            color: #F5E6C8 !important;
            font-weight: bold !important;
        }
        
        .btn-primary:hover {
            background: #725811 !important;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicators {
            display: flex !important;
            gap: 10px !important;
            margin-bottom: 10px !important;
            flex-wrap: wrap !important;
        }
        
        .status-item {
            flex: 1 !important;
            min-width: 120px !important;
            background: rgba(255,255,255,0.8) !important;
            border: 1px solid #8B6914 !important;
            border-radius: 6px !important;
            padding: 8px !important;
            text-align: center !important;
        }
        
        .status-value {
            font-size: 20px !important;
            font-weight: bold !important;
            margin-bottom: 4px !important;
        }
        
        .status-label {
            font-size: 11px !important;
            color: #4A3728 !important;
        }
        
        /* é€‰é¡¹å¡å¯¼èˆª */
        .tab-nav {
            display: flex !important;
            border-bottom: 1px solid #8B6914 !important;
            margin-bottom: 10px !important;
            overflow-x: auto !important;
        }
        
        .tab-button {
            padding: 8px 12px !important;
            border: none !important;
            background: transparent !important;
            color: #4A3728 !important;
            font-size: 13px !important;
            cursor: pointer !important;
            white-space: nowrap !important;
            border-bottom: 2px solid transparent !important;
            transition: all 0.2s !important;
        }
        
        .tab-button.active {
            color: #2C1810 !important;
            font-weight: bold !important;
            border-bottom: 2px solid #8B6914 !important;
            background: rgba(139,105,20,0.1) !important;
        }
        
        /* é€‰é¡¹å¡å†…å®¹ */
        .tab-content {
            display: none !important;
        }
        
        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.3s !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* æ•°æ®è¡¨æ ¼ */
        .data-table {
            width: 100% !important;
            border-collapse: collapse !important;
            background: rgba(255,255,255,0.9) !important;
            border-radius: 6px !important;
            overflow: hidden !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        
        .data-table th {
            background: #E8D4A8 !important;
            padding: 8px 10px !important;
            text-align: left !important;
            font-size: 12px !important;
            color: #2C1810 !important;
            border-bottom: 1px solid #8B6914 !important;
        }
        
        .data-table td {
            padding: 8px 10px !important;
            border-bottom: 1px solid rgba(139,105,20,0.2) !important;
            font-size: 12px !important;
        }
        
        .data-table tr:hover {
            background: rgba(245,230,200,0.5) !important;
        }
        
        /* å¡ç‰‡ç½‘æ ¼ */
        .card-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
            gap: 10px !important;
            margin-bottom: 10px !important;
        }
        
        .card {
            background: rgba(255,255,255,0.9) !important;
            border: 1px solid #8B6914 !important;
            border-radius: 6px !important;
            padding: 10px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        
        .card-header {
            font-weight: bold !important;
            color: #2C1810 !important;
            margin-bottom: 8px !important;
            padding-bottom: 5px !important;
            border-bottom: 1px solid rgba(139,105,20,0.3) !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 6px !important;
            background: rgba(139,105,20,0.2) !important;
            border-radius: 3px !important;
            margin: 4px 0 !important;
            overflow: hidden !important;
        }
        
        .progress-fill {
            height: 100% !important;
            background: #8B6914 !important;
            border-radius: 3px !important;
            transition: width 0.3s !important;
        }
        
        /* èµ„æºæ ‡ç­¾ */
        .resource-tag {
            display: inline-block !important;
            padding: 2px 6px !important;
            background: #E8D4A8 !important;
            border: 1px solid #8B6914 !important;
            border-radius: 10px !important;
            font-size: 11px !important;
            margin: 2px !important;
        }
        
        /* è­¦å‘Šæç¤º */
        .alert {
            padding: 8px 10px !important;
            border-radius: 4px !important;
            margin-bottom: 8px !important;
            font-size: 12px !important;
        }
        
        .alert-warning {
            background: rgba(255,193,7,0.2) !important;
            border: 1px solid #ffc107 !important;
            color: #856404 !important;
        }
        
        .alert-danger {
            background: rgba(220,53,69,0.2) !important;
            border: 1px solid #dc3545 !important;
            color: #721c24 !important;
        }
        
        .alert-success {
            background: rgba(40,167,69,0.2) !important;
            border: 1px solid #28a745 !important;
            color: #155724 !important;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .status-indicators {
                flex-direction: column !important;
            }
            
            .card-grid {
                grid-template-columns: 1fr !important;
            }
            
            .control-buttons {
                flex-wrap: wrap !important;
                justify-content: center !important;
            }
            
            .header {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .header-left {
                text-align: center !important;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(139,105,20,0.1) !important;
            border-radius: 3px !important;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8B6914 !important;
            border-radius: 3px !important;
        }
    </style>
</head>
<body>
    <div class="territory-dashboard" id="app">
        <!-- æ ‡é¢˜æ  -->
        <div class="header">
            <div class="header-left">
                <h1>ğŸ° {{ territory.åŸºæœ¬ä¿¡æ¯?.åç§°?.[0] || "é¢†åœ°çŠ¶æ€é¢æ¿" }}</h1>
                <div class="game-time">
                    æ¸¸æˆæ—¶é—´: {{ territory.ç¯å¢ƒ?.å­£èŠ‚?.[0] || "æ˜¥å­£" }} | 
                    ä¸Šæ¬¡æ›´æ–°: {{ lastUpdateTime }}
                </div>
            </div>
            <div class="control-buttons">
                <button class="btn" @click="refreshData" :disabled="isLoading">
                    {{ isLoading ? 'ğŸ”„ åŠ è½½ä¸­...' : 'ğŸ”„ åˆ·æ–°æ•°æ®' }}
                </button>
                <button class="btn btn-primary" @click="monthlySettlement">
                    ğŸ“… æœˆåº¦ç»“ç®—
                </button>
                <button class="btn" @click="toggleAutoRefresh">
                    {{ autoRefreshEnabled ? 'â¸ï¸ æš‚åœåˆ·æ–°' : 'â–¶ï¸ è‡ªåŠ¨åˆ·æ–°' }}
                </button>
                <button class="btn" @click="exportData">
                    ğŸ“¤ å¯¼å‡ºæ•°æ®
                </button>
            </div>
        </div>
        
        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status-indicators">
            <div class="status-item">
                <div class="status-value">{{ formatNumber(totalPopulation) }}</div>
                <div class="status-label">æ€»äººå£</div>
            </div>
            <div class="status-item">
                <div class="status-value">{{ formatCurrency(treasury) }}</div>
                <div class="status-label">å›½åº“èµ„é‡‘</div>
            </div>
            <div class="status-item">
                <div class="status-value" :style="{ color: netIncomeColor }">
                    {{ formatCurrency(netIncome, true) }}
                </div>
                <div class="status-label">æœˆåº¦å‡€æ”¶å…¥</div>
            </div>
            <div class="status-item">
                <div class="status-value">{{ threatLevel }}</div>
                <div class="status-label">å¨èƒç­‰çº§</div>
            </div>
            <div class="status-item">
                <div class="status-value">{{ morale }}%</div>
                <div class="status-label">æ°‘å¿ƒæŒ‡æ•°</div>
                <div class="progress-bar">
                    <div class="progress-fill" :style="{ width: morale + '%' }"></div>
                </div>
            </div>
        </div>
        
        <!-- è­¦å‘Šæç¤º -->
        <div v-if="resourceWarnings.length > 0" class="alert alert-warning">
            âš ï¸ ç‰©èµ„é¢„è­¦: 
            <span v-for="warning in resourceWarnings" :key="warning.name" style="margin-right: 10px;">
                {{ warning.name }}({{ warning.current }}{{ warning.unit }} < å®‰å…¨çº¿{{ warning.safe }}{{ warning.unit }})
            </span>
        </div>
        
        <!-- é€‰é¡¹å¡å¯¼èˆª -->
        <div class="tab-nav">
            <button class="tab-button" :class="{ active: activeTab === 'overview' }" @click="switchTab('overview')">
                æ¦‚è§ˆ
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'population' }" @click="switchTab('population')">
                äººå£
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'economy' }" @click="switchTab('economy')">
                ç»æµ
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'resources' }" @click="switchTab('resources')">
                èµ„æº
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'military' }" @click="switchTab('military')">
                å†›äº‹
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'buildings' }" @click="switchTab('buildings')">
                å»ºç­‘
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'technology' }" @click="switchTab('technology')">
                ç§‘æŠ€
            </button>
            <button class="tab-button" :class="{ active: activeTab === 'system' }" @click="switchTab('system')">
                ç³»ç»Ÿ
            </button>
        </div>
        
        <!-- æ¦‚è§ˆé€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'overview' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">ğŸ“‹ é¢†åœ°åŸºç¡€ä¿¡æ¯</div>
                    <table class="data-table">
                        <tr>
                            <td style="width: 100px;">åç§°</td>
                            <td>{{ territory.åŸºæœ¬ä¿¡æ¯?.åç§°?.[0] }}</td>
                        </tr>
                        <tr>
                            <td>é¢ç§¯</td>
                            <td>{{ territory.åŸºæœ¬ä¿¡æ¯?.é¢ç§¯?.[0] }} å¹³æ–¹é‡Œ</td>
                        </tr>
                        <tr>
                            <td>åœ°å½¢</td>
                            <td>{{ territory.åŸºæœ¬ä¿¡æ¯?.åœ°å½¢?.[0] }}</td>
                        </tr>
                        <tr>
                            <td>å‘å±•é˜¶æ®µ</td>
                            <td>{{ territory.åŸºæœ¬ä¿¡æ¯?.å‘å±•é˜¶æ®µ?.[0] }}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ’° ç»æµæ¦‚å†µ</div>
                    <table class="data-table">
                        <tr>
                            <td>æœˆæ€»æ”¶å…¥</td>
                            <td style="color: #28a745;">{{ formatCurrency(monthlyIncome) }}</td>
                        </tr>
                        <tr>
                            <td>æœˆæ€»æ”¯å‡º</td>
                            <td style="color: #dc3545;">{{ formatCurrency(monthlyExpense) }}</td>
                        </tr>
                        <tr>
                            <td>å‡€æ”¶å…¥</td>
                            <td :style="{ color: netIncomeColor }">{{ formatCurrency(netIncome, true) }}</td>
                        </tr>
                        <tr>
                            <td>ç¨ç‡ä½“ç³»</td>
                            <td>
                                <div>å†œä¸š: {{ (publicTaxes.å†œä¸šç¨ * 100).toFixed(1) }}%</div>
                                <div>å•†ä¸š: {{ (publicTaxes.å•†ä¸šç¨ * 100).toFixed(1) }}%</div>
                                <div>å·¥ä¸š: {{ (publicTaxes.å·¥ä¸šç¨ * 100).toFixed(1) }}%</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ‘¥ äººå£æ¦‚å†µ</div>
                    <table class="data-table">
                        <tr>
                            <td>æ€»äººå£</td>
                            <td>{{ formatNumber(totalPopulation) }} äºº</td>
                        </tr>
                        <tr>
                            <td>ç§æ—æ„æˆ</td>
                            <td>
                                <div v-for="race in races" :key="race.name" style="margin-bottom: 3px;">
                                    {{ race.name }}: {{ race.count }}äºº ({{ race.status }})
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>èŒä¸šåˆ†å¸ƒ</td>
                            <td>
                                <div v-for="job in topJobs" :key="job.name" style="margin-bottom: 2px;">
                                    {{ job.name }}: {{ job.count }}äºº
                                    <div class="progress-bar">
                                        <div class="progress-fill" :style="{ width: job.percentage + '%' }"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">âš ï¸ å¨èƒä¸å®‰å…¨</div>
                    <table class="data-table">
                        <tr>
                            <td>å¨èƒç­‰çº§</td>
                            <td>
                                <span :style="{
                                    color: threatLevelColor,
                                    fontWeight: 'bold'
                                }">
                                    {{ threatLevel }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>ä¸»è¦å¨èƒ</td>
                            <td>{{ threatInfo.ä¸»è¦é­”ç‰©?.[0] || 'æœªçŸ¥' }}</td>
                        </tr>
                        <tr>
                            <td>é¢„ä¼°å¨èƒ</td>
                            <td>{{ threatInfo.é¢„è®¡ä¸‹æ¬¡è¢­å‡»?.[0] || 'æœªçŸ¥' }}</td>
                        </tr>
                        <tr>
                            <td>ç”Ÿæ´»æ°´å¹³</td>
                            <td>{{ residents.ç”Ÿæ´»æ°´å¹³?.[0] || 'æœªçŸ¥' }}</td>
                        </tr>
                        <tr>
                            <td>æ²»å®‰çŠ¶å†µ</td>
                            <td>{{ residents.æ²»å®‰çŠ¶å†µ?.[0] || 0 }}/100</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- äººå£é€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'population' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">ğŸ‘¥ è¯¦ç»†äººå£æ•°æ®</div>
                    <table class="data-table">
                        <tr>
                            <th>æŒ‡æ ‡</th>
                            <th>æ•°å€¼</th>
                            <th>è¯´æ˜</th>
                        </tr>
                        <tr>
                            <td>æ€»äººå£</td>
                            <td>{{ formatNumber(totalPopulation) }} äºº</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>äººå£å¢é•¿ç‡</td>
                            <td>{{ (populationGrowth * 100).toFixed(2) }}%</td>
                            <td>æ¯æœˆè‡ªç„¶å¢é•¿ç‡</td>
                        </tr>
                        <tr>
                            <td>ç§»æ°‘ç‡</td>
                            <td>{{ (migrationRate * 100).toFixed(2) }}%</td>
                            <td>æ¯æœˆå‡€ç§»æ°‘ç‡</td>
                        </tr>
                        <tr>
                            <td>å¤±ä¸šç‡</td>
                            <td>{{ (unemploymentRate * 100).toFixed(1) }}%</td>
                            <td>æ— ä¸šäººå£æ¯”ä¾‹</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸŒ ç§æ—æ„æˆ</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç§æ—</th>
                                <th>æ•°é‡</th>
                                <th>å æ¯”</th>
                                <th>åœ°ä½</th>
                                <th>ç‰¹æ®Šèƒ½åŠ›</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="race in races" :key="race.name">
                                <td>{{ race.name }}</td>
                                <td>{{ race.count }}äºº</td>
                                <td>{{ race.percentage }}%</td>
                                <td>
                                    <span class="resource-tag" :style="{
                                        backgroundColor: getRaceStatusColor(race.status),
                                        color: '#2C1810'
                                    }">
                                        {{ race.status }}
                                    </span>
                                </td>
                                <td style="font-size: 11px;">{{ race.specialAbility }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ¢ èŒä¸šåˆ†å¸ƒ</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>èŒä¸š</th>
                                <th>äººæ•°</th>
                                <th>å æ¯”</th>
                                <th>æœˆè´¡çŒ®</th>
                                <th>æ»¡æ„åº¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="job in jobs" :key="job.name">
                                <td>{{ job.name }}</td>
                                <td>{{ job.count }}äºº</td>
                                <td>{{ job.percentage }}%</td>
                                <td :style="{ color: job.contribution >= 0 ? '#28a745' : '#dc3545' }">
                                    {{ job.contribution >= 0 ? '+' : '' }}{{ job.contribution }}é‡‘å¸
                                </td>
                                <td>
                                    {{ job.satisfaction }}/100
                                    <div class="progress-bar">
                                        <div class="progress-fill" :style="{ width: job.satisfaction + '%' }"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ“Š ç¤¾ä¼šé˜¶å±‚</div>
                    <table class="data-table">
                        <tbody>
                            <tr v-for="classItem in socialClasses" :key="classItem.name">
                                <td style="font-weight: bold;">{{ classItem.name }}</td>
                                <td>{{ classItem.population }}äºº</td>
                                <td>
                                    <div>è´¢å¯Œ: {{ formatCurrency(classItem.wealth) }}</div>
                                    <div>å½±å“åŠ›: {{ classItem.influence }}</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ç»æµé€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'economy' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">ğŸ’° è´¢æ”¿çŠ¶å†µ</div>
                    <table class="data-table">
                        <tr>
                            <td>å›½åº“èµ„é‡‘</td>
                            <td style="font-weight: bold; color: #ffc107;">
                                {{ formatCurrency(treasury) }}
                            </td>
                        </tr>
                        <tr>
                            <td>æœˆæ€»æ”¶å…¥</td>
                            <td style="color: #28a745;">{{ formatCurrency(monthlyIncome) }}</td>
                        </tr>
                        <tr>
                            <td>æœˆæ€»æ”¯å‡º</td>
                            <td style="color: #dc3545;">{{ formatCurrency(monthlyExpense) }}</td>
                        </tr>
                        <tr>
                            <td>æœˆå‡€æ”¶å…¥</td>
                            <td :style="{ color: netIncomeColor, fontWeight: 'bold' }">
                                {{ formatCurrency(netIncome, true) }}
                            </td>
                        </tr>
                        <tr>
                            <td>æ”¶æ”¯çŠ¶æ€</td>
                            <td :style="{ color: balanceStatus === 'ç›ˆä½™' ? '#28a745' : balanceStatus === 'äºæŸ' ? '#dc3545' : '#ffc107' }">
                                {{ balanceStatus }}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ“Š ç»æµæŒ‡æ ‡</div>
                    <table class="data-table">
                        <tr>
                            <td>GDP(å¹´)</td>
                            <td>{{ formatCurrency(economyIndicators.GDP) }}</td>
                        </tr>
                        <tr>
                            <td>äººå‡GDP</td>
                            <td>{{ formatCurrency(economyIndicators.äººå‡GDP) }}/äºº/å¹´</td>
                        </tr>
                        <tr>
                            <td>é€šè´§è†¨èƒ€ç‡</td>
                            <td>{{ (economyIndicators.é€šè´§è†¨èƒ€ç‡ * 100).toFixed(2) }}%</td>
                        </tr>
                        <tr>
                            <td>å¤±ä¸šç‡</td>
                            <td>{{ (economyIndicators.å¤±ä¸šç‡ * 100).toFixed(1) }}%</td>
                        </tr>
                        <tr>
                            <td>è´¸æ˜“é¡ºå·®</td>
                            <td style="color: #28a745;">+{{ formatCurrency(economyIndicators.è´¸æ˜“é¡ºå·®) }}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ›ï¸ ç¨æ”¶ä½“ç³»</div>
                    <table class="data-table">
                        <tr>
                            <td>å†œä¸šç¨</td>
                            <td>{{ (publicTaxes.å†œä¸šç¨ * 100).toFixed(1) }}%</td>
                        </tr>
                        <tr>
                            <td>å•†ä¸šç¨</td>
                            <td>{{ (publicTaxes.å•†ä¸šç¨ * 100).toFixed(1) }}%</td>
                        </tr>
                        <tr>
                            <td>å·¥ä¸šç¨</td>
                            <td>{{ (publicTaxes.å·¥ä¸šç¨ * 100).toFixed(1) }}%</td>
                        </tr>
                        <tr>
                            <td>ä¸ªäººæ‰€å¾—ç¨</td>
                            <td>{{ (publicTaxes.ä¸ªäººæ‰€å¾—ç¨ * 100).toFixed(1) }}%</td>
                        </tr>
                        <tr>
                            <td>ç§æœ‰èµ„äº§ç¨ç‡</td>
                            <td>{{ (privateTaxRate * 100).toFixed(1) }}%</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ’ ç‰©ä»·æŒ‡æ•°</div>
                    <table class="data-table">
                        <tr v-for="item in priceIndex" :key="item.name">
                            <td>{{ item.name }}</td>
                            <td>{{ item.price }} é‡‘å¸/{{ item.unit }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- èµ„æºé€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'resources' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">ğŸª ä»“åº“ç‰©èµ„</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç‰©èµ„</th>
                                <th>å½“å‰å‚¨é‡</th>
                                <th>å®‰å…¨å‚¨é‡</th>
                                <th>çŠ¶æ€</th>
                                <th>å•ä½ä»·å€¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="resource in warehouseResources" :key="resource.id">
                                <td>{{ resource.name }}</td>
                                <td :style="{ color: resource.current < resource.safe ? '#dc3545' : '#28a745' }">
                                    {{ resource.current }}{{ resource.unit }}
                                </td>
                                <td>{{ resource.safe }}{{ resource.unit }}</td>
                                <td>
                                    <span v-if="resource.current >= resource.safe * 1.5" style="color: #28a745;">å……è¶³</span>
                                    <span v-else-if="resource.current >= resource.safe" style="color: #ffc107;">æ­£å¸¸</span>
                                    <span v-else style="color: #dc3545; font-weight: bold;">çŸ­ç¼º</span>
                                </td>
                                <td>{{ resource.price }} é‡‘å¸/{{ resource.unit }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸŒ³ è‡ªç„¶èµ„æºåŠ¨æ€</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>èµ„æº</th>
                                <th>æ€»å‚¨é‡</th>
                                <th>æœˆå¼€é‡‡</th>
                                <th>æœˆå†ç”Ÿ</th>
                                <th>å¯æŒç»­</th>
                                <th>æ¯ç«­æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="resource in naturalResources" :key="resource.name">
                                <td>{{ resource.name }}</td>
                                <td>{{ resource.total }}{{ resource.unit }}</td>
                                <td>{{ resource.monthlyExtraction }}{{ resource.unit }}</td>
                                <td>{{ resource.monthlyRegeneration }}{{ resource.unit }}</td>
                                <td>{{ resource.sustainable }}{{ resource.unit }}</td>
                                <td>{{ resource.depletionTime }}ä¸ªæœˆ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸŒ¤ï¸ ç¯å¢ƒçŠ¶å†µ</div>
                    <table class="data-table">
                        <tr>
                            <td>å­£èŠ‚</td>
                            <td>{{ environment.å­£èŠ‚?.[0] || 'æ˜¥å­£' }}</td>
                        </tr>
                        <tr>
                            <td>å¤©æ°”</td>
                            <td>{{ environment.å¤©æ°”çŠ¶å†µ?.[0] || 'æ™´æœ—' }}</td>
                        </tr>
                        <tr>
                            <td>æ¸©åº¦</td>
                            <td>{{ environment.æ¸©åº¦?.[0] || 15 }}Â°C</td>
                        </tr>
                        <tr>
                            <td>é™æ°´</td>
                            <td>{{ environment.é™æ°´?.[0] || 'é€‚ä¸­' }}</td>
                        </tr>
                        <tr>
                            <td>ç¾å®³é£é™©</td>
                            <td>{{ (environment.è‡ªç„¶ç¾å®³é£é™©?.[0] * 100).toFixed(1) }}%</td>
                        </tr>
                    </table>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(139,105,20,0.1); border-radius: 4px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">å­£èŠ‚å½±å“:</div>
                        <div>å†œä¸šäº§å‡º: {{ (environment.å­£èŠ‚å½±å“?.å†œä¸šäº§å‡ºä¿®æ­£?.[0] * 100 - 100).toFixed(0) }}%</div>
                        <div>å•†ä¸šæ´»åŠ¨: {{ (environment.å­£èŠ‚å½±å“?.å•†ä¸šæ´»åŠ¨ä¿®æ­£?.[0] * 100 - 100).toFixed(0) }}%</div>
                        <div>èµ„æºé‡‡é›†: {{ (environment.å­£èŠ‚å½±å“?.èµ„æºé‡‡é›†ä¿®æ­£?.[0] * 100 - 100).toFixed(0) }}%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å†›äº‹é€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'military' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">âš”ï¸ å…µåŠ›çŠ¶å†µ</div>
                    <table class="data-table">
                        <tr>
                            <td>å¸¸å¤‡å†›</td>
                            <td>{{ military.å¸¸å¤‡å†›?.[0] || 0 }} äºº</td>
                        </tr>
                        <tr>
                            <td>æ°‘å…µ</td>
                            <td>{{ military.æ°‘å…µ?.[0] || 0 }} äºº</td>
                        </tr>
                        <tr>
                            <td>ç²¾é”éƒ¨é˜Ÿ</td>
                            <td>{{ military.ç²¾é”éƒ¨é˜Ÿ?.[0] || 0 }} äºº</td>
                        </tr>
                        <tr>
                            <td>æ€»å…µåŠ›</td>
                            <td style="font-weight: bold;">{{ totalMilitary }} äºº</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ›¡ï¸ æˆ˜åŠ›è¯„ä¼°</div>
                    <table class="data-table">
                        <tr>
                            <td>æ€»è¯„çº§</td>
                            <td style="font-size: 18px; font-weight: bold; color: #8B6914;">
                                {{ militaryRating.æ€»è¯„çº§?.[0] || 'D' }}
                            </td>
                        </tr>
                        <tr>
                            <td>é¢†ä¸»æˆ˜åŠ›</td>
                            <td>{{ militaryRating.é¢†ä¸»æˆ˜åŠ›?.[0] || 'B' }}</td>
                        </tr>
                        <tr>
                            <td>å†›é˜Ÿæˆ˜åŠ›</td>
                            <td>{{ militaryRating.å†›é˜Ÿæˆ˜åŠ›?.[0] || 'E' }}</td>
                        </tr>
                        <tr>
                            <td>é˜²å¾¡è¯„çº§</td>
                            <td>{{ militaryRating.é˜²å¾¡è¯„çº§?.[0] || 'D+' }}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ–ï¸ è£…å¤‡ä¸å£«æ°”</div>
                    <table class="data-table">
                        <tr>
                            <td>è£…å¤‡å®Œæ•´ç‡</td>
                            <td>
                                {{ (equipmentStatus.è£…å¤‡å®Œæ•´ç‡?.[0] * 100).toFixed(0) }}%
                                <div class="progress-bar">
                                    <div class="progress-fill" :style="{ width: equipmentStatus.è£…å¤‡å®Œæ•´ç‡?.[0] * 100 + '%' }"></div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>è®­ç»ƒæ°´å¹³</td>
                            <td>
                                {{ (equipmentStatus.è®­ç»ƒæ°´å¹³?.[0] * 100).toFixed(0) }}%
                                <div class="progress-bar">
                                    <div class="progress-fill" :style="{ width: equipmentStatus.è®­ç»ƒæ°´å¹³?.[0] * 100 + '%' }"></div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>å£«æ°”</td>
                            <td>
                                {{ equipmentStatus.å£«æ°”?.[0] || 70 }}/100
                                <div class="progress-bar">
                                    <div class="progress-fill" :style="{ width: equipmentStatus.å£«æ°”?.[0] + '%' }"></div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ° é˜²å¾¡è®¾æ–½</div>
                    <table class="data-table">
                        <tr>
                            <td>åŸå¢™å®Œæ•´åº¦</td>
                            <td>
                                {{ (defenseFacilities.åŸå¢™å®Œæ•´åº¦?.[0] * 100).toFixed(0) }}%
                                <div class="progress-bar">
                                    <div class="progress-fill" :style="{ width: defenseFacilities.åŸå¢™å®Œæ•´åº¦?.[0] * 100 + '%' }"></div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>ç­æœ›å¡”æ•°é‡</td>
                            <td>{{ defenseFacilities.ç­æœ›å¡”æ•°é‡?.[0] || 2 }} åº§</td>
                        </tr>
                        <tr>
                            <td>åŸé—¨çŠ¶æ€</td>
                            <td>{{ defenseFacilities.åŸé—¨çŠ¶æ€?.[0] || 'å®Œå¥½' }}</td>
                        </tr>
                        <tr>
                            <td>æŠ¤åŸæ²³</td>
                            <td>{{ defenseFacilities.æŠ¤åŸæ²³?.[0] || 'æ— ' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å»ºç­‘é€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'buildings' }">
            <div class="card-grid">
                <div v-for="building in buildingsList" :key="building.id" class="card">
                    <div class="card-header">
                        {{ building.name }}
                        <span style="font-size: 11px; color: #4A3728;">
                            Lv.{{ building.level }}
                        </span>
                    </div>
                    <table class="data-table">
                        <tr>
                            <td>ç±»å‹</td>
                            <td>{{ building.type }}</td>
                        </tr>
                        <tr>
                            <td>äº§æƒ</td>
                            <td>{{ building.ownership === 'lord' ? 'é¢†ä¸»æ‰€æœ‰' : 'ç§æœ‰' }}</td>
                        </tr>
                        <tr>
                            <td>çŠ¶æ€</td>
                            <td :style="{
                                color: building.status === 'æ­£å¸¸è¿è¥' ? '#28a745' : 
                                       building.status === 'å»ºè®¾ä¸­' ? '#ffc107' : '#dc3545'
                            }">
                                {{ building.status }}
                            </td>
                        </tr>
                        <tr>
                            <td>å²—ä½</td>
                            <td>{{ building.currentWorkers }}/{{ building.maxWorkers }} äºº</td>
                        </tr>
                        <tr v-if="building.monthlyIncome > 0">
                            <td>æœˆæ”¶å…¥</td>
                            <td style="color: #28a745;">+{{ building.monthlyIncome }} é‡‘å¸</td>
                        </tr>
                        <tr v-if="building.monthlyExpense > 0">
                            <td>æœˆæ”¯å‡º</td>
                            <td style="color: #dc3545;">-{{ building.monthlyExpense }} é‡‘å¸</td>
                        </tr>
                        <tr>
                            <td>å‡€æ”¶ç›Š</td>
                            <td :style="{ 
                                color: building.netIncome >= 0 ? '#28a745' : '#dc3545',
                                fontWeight: 'bold'
                            }">
                                {{ building.netIncome >= 0 ? '+' : '' }}{{ building.netIncome }} é‡‘å¸
                            </td>
                        </tr>
                    </table>
                    <div v-if="building.production" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(139,105,20,0.3);">
                        <div style="font-size: 11px; color: #4A3728; margin-bottom: 3px;">ç”Ÿäº§é…æ–¹:</div>
                        <div v-if="building.production.input" style="font-size: 11px;">
                            æŠ•å…¥: 
                            <span v-for="(amount, resource) in building.production.input" :key="resource">
                                {{ amount }} {{ resource }}
                            </span>
                        </div>
                        <div v-if="building.production.output" style="font-size: 11px;">
                            äº§å‡º: 
                            <span v-for="(amount, resource) in building.production.output" :key="resource">
                                {{ amount }} {{ resource }}
                            </span>
                        </div>
                        <div style="font-size: 11px;">
                            æ•ˆç‡: {{ (building.production.efficiency * 100).toFixed(0) }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç§‘æŠ€é€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'technology' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">ğŸ”¬ å·²ç ”å‘ç§‘æŠ€</div>
                    <div v-for="tech in developedTech" :key="tech.id" style="padding: 8px; border-bottom: 1px solid rgba(139,105,20,0.2);">
                        <div style="font-weight: bold; color: #28a745;">âœ… {{ tech.name }}</div>
                        <div style="font-size: 11px; color: #4A3728;">{{ tech.description }}</div>
                    </div>
                    <div v-if="developedTech.length === 0" style="padding: 8px; text-align: center; color: #6c757d;">
                        æš‚æ— å·²ç ”å‘ç§‘æŠ€
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ”„ ç ”å‘ä¸­ç§‘æŠ€</div>
                    <div v-for="tech in researchingTech" :key="tech.id" style="padding: 8px; border-bottom: 1px solid rgba(139,105,20,0.2);">
                        <div style="font-weight: bold; color: #ffc107;">ğŸ”„ {{ tech.name }}</div>
                        <div style="font-size: 11px; color: #4A3728;">è¿›åº¦: {{ tech.progress }}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{ width: tech.progress + '%' }"></div>
                        </div>
                        <div style="font-size: 11px; color: #4A3728;">{{ tech.description }}</div>
                    </div>
                    <div v-if="researchingTech.length === 0" style="padding: 8px; text-align: center; color: #6c757d;">
                        æš‚æ— ç ”å‘ä¸­ç§‘æŠ€
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ“š å¯ç ”å‘ç§‘æŠ€</div>
                    <div v-for="tech in availableTech" :key="tech.id" style="padding: 8px; border-bottom: 1px solid rgba(139,105,20,0.2);">
                        <div style="font-weight: bold;">ğŸ“– {{ tech.name }}</div>
                        <div style="font-size: 11px; color: #4A3728;">éš¾åº¦: {{ tech.difficulty }}/100</div>
                        <div style="font-size: 11px; color: #4A3728;">æˆæœ¬: {{ tech.cost }} é‡‘å¸</div>
                        <div style="font-size: 11px; color: #4A3728;">{{ tech.description }}</div>
                    </div>
                    <div v-if="availableTech.length === 0" style="padding: 8px; text-align: center; color: #6c757d;">
                        æš‚æ— å¯ç ”å‘ç§‘æŠ€
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿé€‰é¡¹å¡ -->
        <div class="tab-content" :class="{ active: activeTab === 'system' }">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
                    <table class="data-table">
                        <tr>
                            <td>å½“å‰æ¸¸æˆæ—¶é—´</td>
                            <td>{{ system.å½“å‰æ¸¸æˆæ—¶é—´?.[0] || 'ç¬¬1å¹´ 1æœˆ' }}</td>
                        </tr>
                        <tr>
                            <td>è‡ªåŠ¨ç»“ç®—å¼€å…³</td>
                            <td>
                                <span :style="{ color: system.è‡ªåŠ¨ç»“ç®—å¼€å…³?.[0] ? '#28a745' : '#dc3545' }">
                                    {{ system.è‡ªåŠ¨ç»“ç®—å¼€å…³?.[0] ? 'å¼€å¯' : 'å…³é—­' }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>ä¸Šæ¬¡ç»“ç®—æ—¶é—´</td>
                            <td>{{ system.ä¸Šæ¬¡ç»“ç®—æ—¶é—´?.[0] || 'ç¬¬1å¹´ 1æœˆ' }}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ‘‘ é¢†ä¸»ä¿¡æ¯</div>
                    <table class="data-table">
                        <tr>
                            <td>å§“å</td>
                            <td>{{ lord.å§“å?.[0] || 'è‰¾ä¸¹' }}</td>
                        </tr>
                        <tr>
                            <td>ç§°å·</td>
                            <td>{{ lord.ç§°å·?.[0] || 'è¾¹å¢ƒå®ˆæŠ¤è€…' }}</td>
                        </tr>
                        <tr>
                            <td>ä¸ªäººæˆ˜åŠ›</td>
                            <td style="font-weight: bold;">{{ lord.ä¸ªäººæˆ˜åŠ›?.[0] || 'B' }}</td>
                        </tr>
                        <tr>
                            <td>ç®¡ç†èƒ½åŠ›</td>
                            <td>{{ lord.ç®¡ç†èƒ½åŠ›?.[0] || 65 }}/100</td>
                        </tr>
                        <tr>
                            <td>å†›äº‹èƒ½åŠ›</td>
                            <td>{{ lord.å†›äº‹èƒ½åŠ›?.[0] || 70 }}/100</td>
                        </tr>
                        <tr>
                            <td>å¤–äº¤èƒ½åŠ›</td>
                            <td>{{ lord.å¤–äº¤èƒ½åŠ›?.[0] || 55 }}/100</td>
                        </tr>
                        <tr>
                            <td>çŸ¥è¯†æ°´å¹³</td>
                            <td>{{ lord.çŸ¥è¯†æ°´å¹³?.[0] || 60 }}/100</td>
                        </tr>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ“œ æ³•ä»¤ä¸æ”¿ç­–</div>
                    <div v-for="decree in decrees" :key="decree.id" style="padding: 8px; border-bottom: 1px solid rgba(139,105,20,0.2);">
                        <div style="font-weight: bold;">
                            {{ decree.name }}
                            <span :style="{ 
                                color: decree.active ? '#28a745' : '#6c757d',
                                fontSize: '11px',
                                marginLeft: '5px'
                            }">
                                {{ decree.active ? 'ç”Ÿæ•ˆä¸­' : 'æœªç”Ÿæ•ˆ' }}
                            </span>
                        </div>
                        <div style="font-size: 11px; color: #4A3728;">ç”Ÿæ•ˆæ—¶é—´: {{ decree.effectiveTime }}</div>
                    </div>
                    <div v-if="decrees.length === 0" style="padding: 8px; text-align: center; color: #6c757d;">
                        æš‚æ— ç”Ÿæ•ˆæ³•ä»¤
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">ğŸ”„ æ•°æ®ç®¡ç†</div>
                    <div style="padding: 8px;">
                        <div style="margin-bottom: 8px;">
                            <button class="btn" @click="refreshData" style="width: 100%; justify-content: center;">
                                ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ•°æ®
                            </button>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <button class="btn" @click="exportData" style="width: 100%; justify-content: center;">
                                ğŸ“¤ å¯¼å‡ºå½“å‰æ•°æ®
                            </button>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <button class="btn btn-primary" @click="monthlySettlement" style="width: 100%; justify-content: center;">
                                ğŸ“… æ‰§è¡Œæœˆåº¦ç»“ç®—
                            </button>
                        </div>
                        <div style="font-size: 11px; color: #4A3728; margin-top: 10px;">
                            æ•°æ®ç‰ˆæœ¬: 3.0 | æœ€åæ›´æ–°: {{ lastUpdateTime }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div style="margin-top: 20px; padding: 10px; text-align: center; font-size: 11px; color: #4A3728; border-top: 1px solid rgba(139,105,20,0.3);">
            é¢†åœ°ç»è¥ç³»ç»Ÿ v3.0 | MVUå˜é‡é©±åŠ¨ | 
            <span @click="refreshData" style="color: #8B6914; cursor: pointer; text-decoration: underline;">
                ç‚¹å‡»åˆ·æ–°æ•°æ®
            </span>
        </div>
    </div>

    <!-- å¼•å…¥Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        
        createApp({
            setup() {
                // çŠ¶æ€ç®¡ç†
                const territory = ref({});
                const isLoading = ref(false);
                const lastUpdateTime = ref('ä»æœªæ›´æ–°');
                const activeTab = ref('overview');
                const autoRefreshEnabled = ref(false);
                let autoRefreshInterval = null;
                
                // ä»MVUè·å–æ•°æ®
                async function fetchFromMVU() {
                    try {
                        isLoading.value = true;
                        
                        // å°è¯•ä»MVUæ’ä»¶è·å–æ•°æ®
                        if (typeof window.getVariables === 'function') {
                            const mvuData = await window.getVariables({ 
                                type: 'message', 
                                message_id: window.getCurrentMessageId?.() || 'current' 
                            });
                            
                            if (mvuData && mvuData.Territory) {
                                territory.value = mvuData.Territory;
                                console.log('MVUæ•°æ®è·å–æˆåŠŸ');
                            }
                        }
                        
                        // å¦‚æœMVUä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        if (!territory.value || Object.keys(territory.value).length === 0) {
                            console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                            territory.value = getMockData();
                        }
                        
                        lastUpdateTime.value = new Date().toLocaleTimeString();
                        
                    } catch (error) {
                        console.error('è·å–æ•°æ®å¤±è´¥:', error);
                        territory.value = getMockData();
                    } finally {
                        isLoading.value = false;
                        
                        // è°ƒæ•´iframeé«˜åº¦
                        setTimeout(adjustIframeHeight, 100);
                    }
                }
                
                // åˆ·æ–°æ•°æ®
                function refreshData() {
                    fetchFromMVU();
                }
                
                // æœˆåº¦ç»“ç®—
                async function monthlySettlement() {
                    if (confirm('ç¡®å®šè¦æ‰§è¡Œæœˆåº¦ç»“ç®—å—ï¼Ÿè¿™å°†æ›´æ–°æ‰€æœ‰ç»æµæ•°æ®ã€‚')) {
                        try {
                            isLoading.value = true;
                            
                            if (typeof window.executeMvuCode === 'function') {
                                await window.executeMvuCode('Territory.monthlySettlement()');
                                console.log('æœˆåº¦ç»“ç®—æ‰§è¡ŒæˆåŠŸ');
                            } else {
                                console.log('æ¨¡æ‹Ÿæ‰§è¡Œæœˆåº¦ç»“ç®—');
                                // æ¨¡æ‹Ÿç»“ç®—æ•ˆæœ
                                const mockData = getMockData();
                                // æ¨¡æ‹Ÿä¸€äº›æ•°æ®å˜åŒ–
                                mockData.è´¢æ”¿.åº“å­˜é‡‘å¸[0] += mockData.è´¢æ”¿.æœˆå‡€æ”¶å…¥[0];
                                mockData.äººå£.æ€»äººå£[0] = Math.floor(mockData.äººå£.æ€»äººå£[0] * (1 + mockData.äººå£.äººå£å¢é•¿ç‡[0]));
                                territory.value = mockData;
                            }
                            
                            await fetchFromMVU();
                            alert('æœˆåº¦ç»“ç®—å®Œæˆï¼');
                        } catch (error) {
                            console.error('æœˆåº¦ç»“ç®—å¤±è´¥:', error);
                            alert('æœˆåº¦ç»“ç®—å¤±è´¥: ' + error.message);
                        } finally {
                            isLoading.value = false;
                        }
                    }
                }
                
                // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
                function toggleAutoRefresh() {
                    autoRefreshEnabled.value = !autoRefreshEnabled.value;
                    
                    if (autoRefreshEnabled.value) {
                        autoRefreshInterval = setInterval(refreshData, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
                        console.log('è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨');
                    } else {
                        if (autoRefreshInterval) {
                            clearInterval(autoRefreshInterval);
                            autoRefreshInterval = null;
                        }
                        console.log('è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
                    }
                }
                
                // å¯¼å‡ºæ•°æ®
                function exportData() {
                    const dataStr = JSON.stringify(territory.value, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `é¢†åœ°æ•°æ®_${new Date().toISOString().slice(0,10)}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    alert('æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶');
                }
                
                // åˆ‡æ¢é€‰é¡¹å¡
                function switchTab(tabName) {
                    activeTab.value = tabName;
                    // è°ƒæ•´iframeé«˜åº¦ä»¥é€‚åº”æ–°å†…å®¹
                    setTimeout(adjustIframeHeight, 50);
                }
                
                // è°ƒæ•´iframeé«˜åº¦
                function adjustIframeHeight() {
                    const height = document.documentElement.scrollHeight;
                    if (window.parent && window.parent.postMessage) {
                        window.parent.postMessage({
                            type: 'resize_iframe',
                            height: height + 'px'
                        }, '*');
                    }
                }
                
                // æ ¼å¼åŒ–å‡½æ•°
                function formatNumber(num) {
                    return Number(num || 0).toLocaleString();
                }
                
                function formatCurrency(amount, showSign = false) {
                    const num = Number(amount || 0);
                    let formatted = num.toLocaleString() + ' é‡‘å¸';
                    if (showSign) {
                        formatted = (num >= 0 ? '+' : '') + formatted;
                    }
                    return formatted;
                }
                
                function getRaceStatusColor(status) {
                    switch(status) {
                        case 'ä¸»å¯¼': return '#d4edda';
                        case 'å¹³ç­‰': return '#cce5ff';
                        case 'å—é™åˆ¶': return '#fff3cd';
                        case 'å¥´éš¶': return '#f8d7da';
                        default: return '#f8f9fa';
                    }
                }
                
                // è®¡ç®—å±æ€§
                const totalPopulation = computed(() => territory.value.äººå£?.æ€»äººå£?.[0] || 0);
                const treasury = computed(() => territory.value.è´¢æ”¿?.åº“å­˜é‡‘å¸?.[0] || 0);
                const monthlyIncome = computed(() => territory.value.è´¢æ”¿?.æœˆæ€»æ”¶å…¥?.[0] || 0);
                const monthlyExpense = computed(() => territory.value.è´¢æ”¿?.æœˆæ€»æ”¯å‡º?.[0] || 0);
                const netIncome = computed(() => territory.value.è´¢æ”¿?.æœˆå‡€æ”¶å…¥?.[0] || 0);
                const netIncomeColor = computed(() => netIncome.value >= 0 ? '#28a745' : '#dc3545');
                const balanceStatus = computed(() => territory.value.è´¢æ”¿?.æ”¶æ”¯çŠ¶æ€?.[0] || 'å¹³è¡¡');
                const threatLevel = computed(() => territory.value.çŠ¶æ€?.å¨èƒçŠ¶æ€?.å¨èƒç­‰çº§?.[0] || 'è­¦æˆ’');
                const threatLevelColor = computed(() => {
                    switch(threatLevel.value) {
                        case 'å®‰å…¨': return '#28a745';
                        case 'è­¦æˆ’': return '#ffc107';
                        case 'å±é™©': return '#dc3545';
                        case 'æå±é™©': return '#721c24';
                        default: return '#6c757d';
                    }
                });
                const morale = computed(() => territory.value.çŠ¶æ€?.å±…æ°‘çŠ¶æ€?.æ°‘å¿ƒæŒ‡æ•°?.[0] || 70);
                const threatInfo = computed(() => territory.value.çŠ¶æ€?.å¨èƒçŠ¶æ€ || {});
                const residents = computed(() => territory.value.çŠ¶æ€?.å±…æ°‘çŠ¶æ€ || {});
                const environment = computed(() => territory.value.ç¯å¢ƒ || {});
                const system = computed(() => territory.value.System || {});
                const lord = computed(() => territory.value.Character?.é¢†ä¸» || {});
                
                // äººå£ç›¸å…³è®¡ç®—å±æ€§
                const populationGrowth = computed(() => territory.value.äººå£?.äººå£å¢é•¿ç‡?.[0] || 0.008);
                const migrationRate = computed(() => territory.value.äººå£?.ç§»æ°‘ç‡?.[0] || 0.002);
                const unemploymentRate = computed(() => {
                    const jobless = territory.value.äººå£?.èŒä¸šåˆ†å¸ƒ?.æ— ä¸š?.äººæ•°?.[0] || 0;
                    return totalPopulation.value > 0 ? jobless / totalPopulation.value : 0;
                });
                
                // ç»æµç›¸å…³è®¡ç®—å±æ€§
                const publicTaxes = computed(() => territory.value.å…¬å…±ç¨ç‡ || {
                    å†œä¸šç¨: [0.10],
                    å•†ä¸šç¨: [0.15],
                    å·¥ä¸šç¨: [0.12],
                    ä¸ªäººæ‰€å¾—ç¨: [0.05]
                });
                
                const privateTaxRate = computed(() => territory.value.è´¢æ”¿?.ç§æœ‰èµ„äº§ç¨ç‡?.[0] || 0.15);
                
                const economyIndicators = computed(() => territory.value.ç»æµæŒ‡æ ‡ || {
                    GDP: [25000],
                    äººå‡GDP: [20],
                    é€šè´§è†¨èƒ€ç‡: [0.02],
                    å¤±ä¸šç‡: [0.212],
                    è´¸æ˜“é¡ºå·®: [300]
                });
                
                const priceIndex = computed(() => {
                    const prices = territory.value.ç‰©ä»·æŒ‡æ•° || {};
                    return [
                        { name: 'ç²®é£Ÿ', price: prices.ç²®é£Ÿå•ä»·?.[0] || 0.4, unit: 'æ‹…' },
                        { name: 'æœ¨æ', price: prices.æœ¨æå•ä»·?.[0] || 1.8, unit: 'æ–¹' },
                        { name: 'çŸ³æ', price: prices.çŸ³æå•ä»·?.[0] || 2.5, unit: 'æ–¹' },
                        { name: 'é“çŸ¿', price: prices.é“çŸ¿å•ä»·?.[0] || 3.0, unit: 'æ–¤' },
                        { name: 'æ­¦å™¨', price: prices.æ­¦å™¨å•ä»·?.[0] || 15, unit: 'æŠŠ' },
                        { name: 'å·¥å…·', price: prices.å·¥å…·å•ä»·?.[0] || 8, unit: 'ä»¶' }
                    ];
                });
                
                // å†›äº‹ç›¸å…³è®¡ç®—å±æ€§
                const military = computed(() => territory.value.å†›äº‹?.å…µåŠ› || {});
                const militaryRating = computed(() => territory.value.å†›äº‹?.æˆ˜åŠ›è¯„çº§ || {});
                const equipmentStatus = computed(() => territory.value.å†›äº‹?.è£…å¤‡çŠ¶æ€ || {});
                const defenseFacilities = computed(() => territory.value.å†›äº‹?.é˜²å¾¡è®¾æ–½ || {});
                const totalMilitary = computed(() => {
                    const regular = military.value.å¸¸å¤‡å†›?.[0] || 0;
                    const militia = military.value.æ°‘å…µ?.[0] || 0;
                    const elite = military.value.ç²¾é”éƒ¨é˜Ÿ?.[0] || 0;
                    return regular + militia + elite;
                });
                
                // èµ„æºç›¸å…³è®¡ç®—å±æ€§
                const warehouseResources = computed(() => {
                    const warehouse = territory.value.ä»“åº“ || {};
                    return Object.values(warehouse).map(item => ({
                        id: item.id?.[0] || '',
                        name: item.åç§°?.[0] || '',
                        current: item.å½“å‰å‚¨é‡?.[0] || 0,
                        safe: item.å®‰å…¨å‚¨é‡?.[0] || 0,
                        unit: item.å•ä½?.[0] || '',
                        price: item.å¸‚åœºä»·æ ¼?.[0] || 0
                    }));
                });
                
                const naturalResources = computed(() => {
                    const resources = territory.value.èµ„æºåŠ¨æ€ || {};
                    return [
                        {
                            name: 'æ£®æ—',
                            total: resources.æ£®æ—?.å½“å‰å‚¨é‡?.[0] || 12000,
                            monthlyExtraction: resources.æ£®æ—?.æ¯æœˆå¼€é‡‡é‡?.[0] || 150,
                            monthlyRegeneration: resources.æ£®æ—?.æ¯æœˆå†ç”Ÿé‡?.[0] || 100,
                            sustainable: resources.æ£®æ—?.å¯æŒç»­å¼€é‡‡é‡?.[0] || 80,
                            depletionTime: 'âˆ',
                            unit: 'æ–¹'
                        },
                        {
                            name: 'é“çŸ¿è„‰',
                            total: resources.é“çŸ¿è„‰?.å½“å‰å‚¨é‡?.[0] || 5000,
                            monthlyExtraction: resources.é“çŸ¿è„‰?.æ¯æœˆå¼€é‡‡é‡?.[0] || 50,
                            monthlyRegeneration: 0,
                            sustainable: 0,
                            depletionTime: resources.é“çŸ¿è„‰?.é¢„ä¼°æ¯ç«­æ—¶é—´?.[0] || 100,
                            unit: 'æ–¤'
                        },
                        {
                            name: 'çŸ³çŸ¿',
                            total: resources.çŸ³çŸ¿?.å½“å‰å‚¨é‡?.[0] || 8000,
                            monthlyExtraction: resources.çŸ³çŸ¿?.æ¯æœˆå¼€é‡‡é‡?.[0] || 40,
                            monthlyRegeneration: 0,
                            sustainable: 0,
                            depletionTime: resources.çŸ³çŸ¿?.é¢„ä¼°æ¯ç«­æ—¶é—´?.[0] || 200,
                            unit: 'æ–¹'
                        }
                    ];
                });
                
                // èµ„æºé¢„è­¦
                const resourceWarnings = computed(() => {
                    return warehouseResources.value.filter(resource => resource.current < resource.safe);
                });
                
                // ç§æ—æ„æˆ
                const races = computed(() => {
                    const raceData = territory.value.äººå£?.ç§æ—æ„æˆ || {};
                    return Object.entries(raceData).map(([name, data]) => ({
                        name,
                        count: data.æ•°é‡?.[0] || 0,
                        percentage: totalPopulation.value > 0 ? 
                            ((data.æ•°é‡?.[0] || 0) / totalPopulation.value * 100).toFixed(1) : 0,
                        status: data.åœ°ä½?.[0] || '',
                        specialAbility: data.ç‰¹æ®Šèƒ½åŠ›?.[0] || ''
                    }));
                });
                
                // èŒä¸šåˆ†å¸ƒ
                const jobs = computed(() => {
                    const jobData = territory.value.äººå£?.èŒä¸šåˆ†å¸ƒ || {};
                    return Object.entries(jobData).map(([name, data]) => ({
                        name,
                        count: data.äººæ•°?.[0] || 0,
                        percentage: totalPopulation.value > 0 ? 
                            ((data.äººæ•°?.[0] || 0) / totalPopulation.value * 100).toFixed(1) : 0,
                        contribution: data.æœˆè´¡çŒ®?.[0] || 0,
                        satisfaction: data.æ»¡æ„åº¦?.[0] || 0
                    }));
                });
                
                // å‰3ä¸ªèŒä¸šï¼ˆç”¨äºæ¦‚è§ˆï¼‰
                const topJobs = computed(() => {
                    return jobs.value
                        .filter(job => job.count > 0 && job.name !== 'æ— ä¸š')
                        .sort((a, b) => b.count - a.count)
                        .slice(0, 3)
                        .map(job => ({
                            ...job,
                            percentage: (job.count / totalPopulation.value * 100).toFixed(1)
                        }));
                });
                
                // ç¤¾ä¼šé˜¶å±‚
                const socialClasses = computed(() => {
                    const classesData = territory.value.ç¤¾ä¼šé˜¶å±‚ || {};
                    return Object.entries(classesData).map(([name, data]) => ({
                        name,
                        population: data.æ€»äººå£?.[0] || 0,
                        wealth: data.æ€»è´¢å¯Œ?.[0] || 0,
                        influence: data.æ”¿æ²»å½±å“åŠ›?.[0] || 0
                    }));
                });
                
                // å»ºç­‘åˆ—è¡¨
                const buildingsList = computed(() => {
                    const buildingsData = territory.value.å»ºç­‘ || {};
                    return Object.values(buildingsData).map(building => ({
                        id: building.id?.[0] || '',
                        name: building.åç§°?.[0] || '',
                        type: building.ç±»å‹?.[0] || '',
                        ownership: building.äº§æƒ?.[0] || '',
                        level: building.ç­‰çº§?.[0] || 1,
                        status: building.çŠ¶æ€?.[0] || '',
                        currentWorkers: building.å²—ä½?.å½“å‰äººæ•°?.[0] || 0,
                        maxWorkers: building.å²—ä½?.æœ€å¤§äººæ•°?.[0] || 0,
                        monthlyIncome: building.è´¢åŠ¡?.è®¡ç®—_æœˆæ”¶å…¥?.[0] || 0,
                        monthlyExpense: building.è´¢åŠ¡?.è®¡ç®—_æœˆæ”¯å‡º?.[0] || 0,
                        netIncome: building.è´¢åŠ¡?.è®¡ç®—_å‡€æ”¶ç›Š?.[0] || 0,
                        production: building.ç”Ÿäº§é…æ–¹ ? {
                            input: building.ç”Ÿäº§é…æ–¹.æŠ•å…¥èµ„æº || {},
                            output: building.ç”Ÿäº§é…æ–¹.äº§å‡ºèµ„æº || {},
                            efficiency: building.ç”Ÿäº§é…æ–¹.ç”Ÿäº§æ•ˆç‡?.[0] || 1
                        } : null
                    }));
                });
                
                // ç§‘æŠ€åˆ†ç±»
                const developedTech = computed(() => {
                    const techData = territory.value.ç§‘æŠ€ || {};
                    return Object.values(techData)
                        .filter(tech => tech.ç ”å‘çŠ¶æ€?.[0] === 'å·²ç ”å‘')
                        .map(tech => ({
                            id: tech.id?.[0] || '',
                            name: tech.åç§°?.[0] || '',
                            description: tech.æ•ˆæœæè¿°?.[0] || ''
                        }));
                });
                
                const researchingTech = computed(() => {
                    const techData = territory.value.ç§‘æŠ€ || {};
                    return Object.values(techData)
                        .filter(tech => tech.ç ”å‘çŠ¶æ€?.[0] === 'ç ”å‘ä¸­')
                        .map(tech => ({
                            id: tech.id?.[0] || '',
                            name: tech.åç§°?.[0] || '',
                            progress: tech.å½“å‰è¿›åº¦?.[0] || 0,
                            description: tech.æ•ˆæœæè¿°?.[0] || ''
                        }));
                });
                
                const availableTech = computed(() => {
                    const techData = territory.value.ç§‘æŠ€ || {};
                    return Object.values(techData)
                        .filter(tech => tech.ç ”å‘çŠ¶æ€?.[0] === 'æœªç ”å‘')
                        .map(tech => ({
                            id: tech.id?.[0] || '',
                            name: tech.åç§°?.[0] || '',
                            difficulty: tech.ç ”å‘éš¾åº¦?.[0] || 0,
                            cost: tech.ç ”å‘æˆæœ¬?.é‡‘å¸?.[0] || 0,
                            description: tech.æ•ˆæœæè¿°?.[0] || ''
                        }));
                });
                
                // æ³•ä»¤åˆ—è¡¨
                const decrees = computed(() => {
                    const decreeData = territory.value.æ³•ä»¤ || {};
                    return Object.values(decreeData).map(decree => ({
                        id: decree.id?.[0] || '',
                        name: decree.åç§°?.[0] || '',
                        active: decree.ç”Ÿæ•ˆçŠ¶æ€?.[0] || false,
                        effectiveTime: decree.ç”Ÿæ•ˆæ—¶é—´?.[0] || ''
                    }));
                });
                
                // æ¨¡æ‹Ÿæ•°æ®
                function getMockData() {
                    return {
                        åŸºæœ¬ä¿¡æ¯: {
                            åç§°: ["åŒ—å¢ƒè¾¹å¢ƒé¢†"],
                            é¢ç§¯: [85],
                            åœ°å½¢: ["ä¸˜é™µä¸æ£®æ—"],
                            å‘å±•é˜¶æ®µ: ["åˆå»º"]
                        },
                        äººå£: {
                            æ€»äººå£: [1250],
                            ç§æ—æ„æˆ: {
                                äººç±»: { æ•°é‡: [900], åœ°ä½: ["ä¸»å¯¼"], ç‰¹æ®Šèƒ½åŠ›: ["é€‚åº”æ€§å¼ºï¼Œå­¦ä¹ èƒ½åŠ›å¿«"] },
                                çŸ®äºº: { æ•°é‡: [150], åœ°ä½: ["å¹³ç­‰"], ç‰¹æ®Šèƒ½åŠ›: ["åœ°ä¸‹è§†è§‰ï¼Œé”»é€ ä¸çŸ³å·¥ä¸“ç²¾"] },
                                åŠç²¾çµ: { æ•°é‡: [100], åœ°ä½: ["å¹³ç­‰"], ç‰¹æ®Šèƒ½åŠ›: ["è‡ªç„¶äº²å’Œï¼Œå¼“ç®­ä¸è¿½è¸ªä¸“ç²¾"] },
                                å“¥å¸ƒæ—: { æ•°é‡: [50], åœ°ä½: ["å¥´éš¶"], ç‰¹æ®Šèƒ½åŠ›: ["å¤œè§†ï¼Œæ•æ·ï¼Œå°å‹å·¥ç¨‹"] }
                            },
                            èŒä¸šåˆ†å¸ƒ: {
                                å†œæ°‘: { äººæ•°: [700], æœˆè´¡çŒ®: [15], æ»¡æ„åº¦: [65] },
                                å·¥åŒ : { äººæ•°: [120], æœˆè´¡çŒ®: [25], æ»¡æ„åº¦: [70] },
                                å•†äºº: { äººæ•°: [60], æœˆè´¡çŒ®: [30], æ»¡æ„åº¦: [75] },
                                å®˜å‘˜: { äººæ•°: [15], æœˆè´¡çŒ®: [-10], æ»¡æ„åº¦: [80] },
                                å£«å…µ: { äººæ•°: [80], æœˆè´¡çŒ®: [-20], æ»¡æ„åº¦: [70] },
                                å­¦è€…: { äººæ•°: [10], æœˆè´¡çŒ®: [5], æ»¡æ„åº¦: [85] },
                                æ— ä¸š: { äººæ•°: [265], æœˆè´¡çŒ®: [0], æ»¡æ„åº¦: [40] }
                            },
                            äººå£å¢é•¿ç‡: [0.008],
                            ç§»æ°‘ç‡: [0.002]
                        },
                        ç»æµ: {
                            è´¢æ”¿: {
                                åº“å­˜é‡‘å¸: [2500],
                                æœˆæ€»æ”¶å…¥: [1850],
                                æœˆæ€»æ”¯å‡º: [1670],
                                æœˆå‡€æ”¶å…¥: [180],
                                æ”¶æ”¯çŠ¶æ€: ["ğŸ“ˆç›ˆä½™"]
                            },
                            å…¬å…±ç¨ç‡: {
                                å†œä¸šç¨: [0.10],
                                å•†ä¸šç¨: [0.15],
                                å·¥ä¸šç¨: [0.12],
                                ä¸ªäººæ‰€å¾—ç¨: [0.05]
                            },
                            ç‰©ä»·æŒ‡æ•°: {
                                ç²®é£Ÿå•ä»·: [0.4],
                                æœ¨æå•ä»·: [1.8],
                                çŸ³æå•ä»·: [2.5],
                                é“çŸ¿å•ä»·: [3.0],
                                æ­¦å™¨å•ä»·: [15],
                                å·¥å…·å•ä»·: [8]
                            },
                            ç»æµæŒ‡æ ‡: {
                                GDP: [25000],
                                äººå‡GDP: [20],
                                é€šè´§è†¨èƒ€ç‡: [0.02],
                                å¤±ä¸šç‡: [0.212],
                                è´¸æ˜“é¡ºå·®: [300]
                            }
                        },
                        ä»“åº“: {
                            res_food_grain: {
                                id: ["res_food_grain"],
                                åç§°: ["ç²®é£Ÿ"],
                                å½“å‰å‚¨é‡: [6500],
                                å®‰å…¨å‚¨é‡: [3750],
                                å•ä½: ["æ‹…"],
                                å¸‚åœºä»·æ ¼: [0.4]
                            },
                            res_material_wood: {
                                id: ["res_material_wood"],
                                åç§°: ["æœ¨æ"],
                                å½“å‰å‚¨é‡: [900],
                                å®‰å…¨å‚¨é‡: [300],
                                å•ä½: ["æ–¹"],
                                å¸‚åœºä»·æ ¼: [1.8]
                            },
                            res_material_stone: {
                                id: ["res_material_stone"],
                                åç§°: ["çŸ³æ"],
                                å½“å‰å‚¨é‡: [500],
                                å®‰å…¨å‚¨é‡: [200],
                                å•ä½: ["æ–¹"],
                                å¸‚åœºä»·æ ¼: [2.5]
                            },
                            res_material_iron: {
                                id: ["res_material_iron"],
                                åç§°: ["é“çŸ¿"],
                                å½“å‰å‚¨é‡: [300],
                                å®‰å…¨å‚¨é‡: [100],
                                å•ä½: ["æ–¤"],
                                å¸‚åœºä»·æ ¼: [3.0]
                            }
                        },
                        å†›äº‹: {
                            å…µåŠ›: {
                                å¸¸å¤‡å†›: [80],
                                æ°‘å…µ: [200],
                                ç²¾é”éƒ¨é˜Ÿ: [0]
                            },
                            æˆ˜åŠ›è¯„çº§: {
                                æ€»è¯„çº§: ["D"],
                                é¢†ä¸»æˆ˜åŠ›: ["B"],
                                å†›é˜Ÿæˆ˜åŠ›: ["E"],
                                é˜²å¾¡è¯„çº§: ["D+"]
                            },
                            è£…å¤‡çŠ¶æ€: {
                                è£…å¤‡å®Œæ•´ç‡: [0.65],
                                è®­ç»ƒæ°´å¹³: [0.5],
                                å£«æ°”: [70]
                            },
                            é˜²å¾¡è®¾æ–½: {
                                åŸå¢™å®Œæ•´åº¦: [0.7],
                                ç­æœ›å¡”æ•°é‡: [2],
                                åŸé—¨çŠ¶æ€: ["å®Œå¥½"],
                                æŠ¤åŸæ²³: ["æ— "]
                            }
                        },
                        çŠ¶æ€: {
                            å±…æ°‘çŠ¶æ€: {
                                ç”Ÿæ´»æ°´å¹³: ["æ¸©é¥±"],
                                æ²»å®‰çŠ¶å†µ: [65],
                                æ°‘å¿ƒæŒ‡æ•°: [70],
                                å½“å‰äº‹ä»¶: ["æš‚æ— "]
                            },
                            å¨èƒçŠ¶æ€: {
                                å¨èƒç­‰çº§: ["è­¦æˆ’"],
                                ä¸»è¦é­”ç‰©: ["å“¥å¸ƒæ—å›¢ä¼™"],
                                é¢„è®¡ä¸‹æ¬¡è¢­å‡»: ["1-3ä¸ªæœˆå†…"]
                            }
                        },
                        ç¯å¢ƒ: {
                            å­£èŠ‚: ["æ˜¥å­£"],
                            å¤©æ°”çŠ¶å†µ: ["æ™´æœ—"],
                            æ¸©åº¦: [15],
                            é™æ°´: ["é€‚ä¸­"],
                            è‡ªç„¶ç¾å®³é£é™©: [0.1],
                            å­£èŠ‚å½±å“: {
                                å†œä¸šäº§å‡ºä¿®æ­£: [1.2],
                                å•†ä¸šæ´»åŠ¨ä¿®æ­£: [1.0],
                                èµ„æºé‡‡é›†ä¿®æ­£: [1.1]
                            }
                        },
                        System: {
                            å½“å‰æ¸¸æˆæ—¶é—´: ["ç¬¬1å¹´ 1æœˆ"],
                            è‡ªåŠ¨ç»“ç®—å¼€å…³: [false],
                            ä¸Šæ¬¡ç»“ç®—æ—¶é—´: ["ç¬¬1å¹´ 1æœˆ"]
                        },
                        Character: {
                            é¢†ä¸»: {
                                å§“å: ["è‰¾ä¸¹"],
                                ç§°å·: ["è¾¹å¢ƒå®ˆæŠ¤è€…"],
                                ä¸ªäººæˆ˜åŠ›: ["B"],
                                ç®¡ç†èƒ½åŠ›: [65],
                                å†›äº‹èƒ½åŠ›: [70],
                                å¤–äº¤èƒ½åŠ›: [55],
                                çŸ¥è¯†æ°´å¹³: [60]
                            }
                        }
                    };
                }
                
                // åˆå§‹åŒ–
                onMounted(() => {
                    console.log('é¢†åœ°çŠ¶æ€é¢æ¿åˆå§‹åŒ–...');
                    fetchFromMVU();
                    
                    // æä¾›å…¨å±€APIä¾›SillyTavernè°ƒç”¨
                    window.TerritoryDashboard = {
                        refresh: fetchFromMVU,
                        setData: (newData) => {
                            territory.value = newData;
                            lastUpdateTime.value = new Date().toLocaleTimeString();
                            console.log('æ‰‹åŠ¨è®¾ç½®é¢†åœ°æ•°æ®æˆåŠŸ');
                        }
                    };
                    
                    // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'update_territory_data') {
                            territory.value = event.data.data;
                            lastUpdateTime.value = new Date().toLocaleTimeString();
                            console.log('é€šè¿‡postMessageæ›´æ–°é¢†åœ°æ•°æ®');
                        }
                        
                        if (event.data && event.data.type === 'refresh_territory_data') {
                            fetchFromMVU();
                            console.log('é€šè¿‡postMessageåˆ·æ–°é¢†åœ°æ•°æ®');
                        }
                    });
                });
                
                return {
                    // çŠ¶æ€
                    territory,
                    isLoading,
                    lastUpdateTime,
                    activeTab,
                    autoRefreshEnabled,
                    
                    // è®¡ç®—å±æ€§
                    totalPopulation,
                    treasury,
                    monthlyIncome,
                    monthlyExpense,
                    netIncome,
                    netIncomeColor,
                    balanceStatus,
                    threatLevel,
                    threatLevelColor,
                    morale,
                    threatInfo,
                    residents,
                    environment,
                    system,
                    lord,
                    populationGrowth,
                    migrationRate,
                    unemploymentRate,
                    publicTaxes,
                    privateTaxRate,
                    economyIndicators,
                    priceIndex,
                    military,
                    militaryRating,
                    equipmentStatus,
                    defenseFacilities,
                    totalMilitary,
                    warehouseResources,
                    naturalResources,
                    resourceWarnings,
                    races,
                    jobs,
                    topJobs,
                    socialClasses,
                    buildingsList,
                    developedTech,
                    researchingTech,
                    availableTech,
                    decrees,
                    
                    // æ–¹æ³•
                    refreshData,
                    monthlySettlement,
                    toggleAutoRefresh,
                    exportData,
                    switchTab,
                    formatNumber,
                    formatCurrency,
                    getRaceStatusColor
                };
            }
        }).mount('#app');
        
        // è°ƒæ•´iframeé«˜åº¦çš„å‡½æ•°
        function adjustIframeHeight() {
            const height = document.documentElement.scrollHeight;
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'resize_iframe',
                    height: height + 'px'
                }, '*');
            }
        }
        
        // åˆå§‹è°ƒæ•´
        setTimeout(adjustIframeHeight, 200);
        
        console.log('é¢†åœ°ç»è¥çŠ¶æ€é¢æ¿ v3.0 å·²åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
