<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢†åœ°çŠ¶æ€é¢æ¿</title>
    <!-- åŠ è½½lodashï¼Œç”¨äºå®‰å…¨çš„å˜é‡è®¿é—® -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <style>
        /* å®Œå…¨é‡ç½®ï¼Œåªä½¿ç”¨æœ€åŸºæœ¬æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100% !important;
            background: #F5E6C8 !important;
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif !important;
            color: #2C1810 !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            overflow-x: hidden !important;
        }
        
        /* ä¸»å®¹å™¨ */
        .territory-panel {
            width: 100% !important;
            max-width: 100% !important;
            padding: 10px !important;
            background: #F5E6C8 !important;
        }
        
        /* æ ‡é¢˜ */
        .panel-header {
            text-align: center;
            padding: 15px 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #8B6914;
        }
        
        .panel-title {
            font-size: 20px;
            color: #2C1810;
            margin-bottom: 5px;
        }
        
        .panel-subtitle {
            color: #8B6914;
            font-size: 12px;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .control-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(232, 212, 168, 0.5);
            border-radius: 5px;
            border: 1px solid #8B6914;
        }
        
        .control-btn {
            padding: 6px 12px;
            background: #8B6914;
            color: #F5E6C8;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #725811;
        }
        
        /* å¿«é€ŸçŠ¶æ€æ  */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #8B6914;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2C1810;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            color: #4A3728;
        }
        
        /* ç« èŠ‚æ ·å¼ */
        .section {
            margin-bottom: 15px;
            border: 1px solid #8B6914;
            border-radius: 5px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .section-header {
            background: #E8D4A8;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #8B6914;
        }
        
        .section-title {
            font-weight: bold;
            color: #2C1810;
        }
        
        .section-toggle {
            font-size: 12px;
            color: #8B6914;
        }
        
        .section-content {
            padding: 10px;
            display: block; /* é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ */
        }
        
        /* æ•°æ®è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .data-table th {
            background: #E8D4A8;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #8B6914;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(139, 105, 20, 0.3);
        }
        
        .data-table tr:hover {
            background: rgba(245, 230, 200, 0.5);
        }
        
        /* é€‰é¡¹å¡å¯¼èˆª */
        .tab-nav {
            display: flex;
            overflow-x: auto;
            margin-bottom: 10px;
            border-bottom: 1px solid #8B6914;
            background: rgba(232, 212, 168, 0.3);
        }
        
        .tab-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            color: #4A3728;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: #2C1810;
            font-weight: bold;
            border-bottom: 2px solid #8B6914;
            background: rgba(139, 105, 20, 0.1);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-btn {
                min-width: 100px;
            }
            
            .tab-nav {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 480px) {
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                padding: 8px 10px;
                font-size: 12px;
            }
        }
        
        /* è¿›åº¦æ¡ */
        .progress {
            height: 6px;
            background: rgba(139, 105, 20, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 4px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #8B6914;
            border-radius: 3px;
        }
        
        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .tag-success {
            background: #d4edda;
            color: #155724;
        }
        
        .tag-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .tag-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* è­¦å‘Šæ¡† */
        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        /* åº•éƒ¨ä¿¡æ¯ */
        .footer {
            margin-top: 20px;
            padding: 10px;
            text-align: center;
            color: #4A3728;
            font-size: 11px;
            border-top: 1px solid rgba(139, 105, 20, 0.3);
        }

        /* è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-item {
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        
        .debug-key {
            font-weight: bold;
            color: #2C1810;
        }
        
        .debug-value {
            color: #6c757d;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8B6914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å»ºç­‘è¯¦æƒ…æŠ˜å æ ·å¼ */
        .building-details {
            margin-top: 10px;
            padding: 10px;
            background: rgba(245, 230, 200, 0.3);
            border-radius: 4px;
            border: 1px solid rgba(139, 105, 20, 0.2);
        }
        
        .building-details h4 {
            margin: 10px 0 5px 0;
            font-size: 13px;
            color: #2C1810;
        }
        
        /* ç§‘æŠ€å¡ç‰‡æ ·å¼ */
        .tech-card {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #8B6914;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* é¡¹ç›®å¡ç‰‡æ ·å¼ */
        .project-card {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #8B6914;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* æ³•ä»¤å¡ç‰‡æ ·å¼ */
        .decree-card {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #8B6914;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* è¯¦ç»†ä¿¡æ¯æŠ˜å æŒ‰é’® */
        .details-toggle {
            background: none;
            border: none;
            color: #8B6914;
            font-size: 11px;
            cursor: pointer;
            text-decoration: underline;
            padding: 2px 5px;
            margin-top: 5px;
        }
        
        /* èµ„æºè­¦å‘Š */
        .resource-alert {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .resource-alert.low {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #721c24;
        }
        
        .resource-alert.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #856404;
        }
        
        /* ç¼©è¿›å†…å®¹ */
        .indent-content {
            padding-left: 15px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="territory-panel">
        <!-- æ ‡é¢˜ -->
        <div class="panel-header">
            <h1 class="panel-title">ğŸ° é¢†åœ°çŠ¶æ€é¢æ¿</h1>
            <div class="panel-subtitle">ç‰ˆæœ¬: 3.0 | æœ€åæ›´æ–°: <span id="last-update">åˆšåˆš</span></div>
        </div>
        
        <!-- æ§åˆ¶æ  -->
        <div class="control-bar">
            <button class="control-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="control-btn" onclick="monthlySettlement()">ğŸ“… æœˆåº¦ç»“ç®—</button>
            <button class="control-btn" onclick="toggleAutoRefresh()" id="auto-refresh-btn">â–¶ï¸ è‡ªåŠ¨åˆ·æ–°</button>
            <button class="control-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
            <button class="control-btn" onclick="showDebugPanel()">ğŸ› è°ƒè¯•ä¿¡æ¯</button>
        </div>
        
        <!-- å¿«é€ŸçŠ¶æ€ -->
        <div class="quick-stats" id="quick-stats">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- é€‰é¡¹å¡å¯¼èˆª -->
        <div class="tab-nav" id="tab-nav">
            <button class="tab-btn active" onclick="switchTab('overview')">æ¦‚è§ˆ</button>
            <button class="tab-btn" onclick="switchTab('population')">äººå£</button>
            <button class="tab-btn" onclick="switchTab('economy')">ç»æµ</button>
            <button class="tab-btn" onclick="switchTab('resources')">èµ„æº</button>
            <button class="tab-btn" onclick="switchTab('military')">å†›äº‹</button>
            <button class="tab-btn" onclick="switchTab('buildings')">å»ºç­‘</button>
            <button class="tab-btn" onclick="switchTab('technology')">ç§‘æŠ€</button>
            <button class="tab-btn" onclick="switchTab('projects')">é¡¹ç›®</button>
            <button class="tab-btn" onclick="switchTab('decrees')">æ³•ä»¤</button>
            <button class="tab-btn" onclick="switchTab('system')">ç³»ç»Ÿ</button>
        </div>
        
        <!-- æ¦‚è§ˆé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-overview" style="display: block;">
            <!-- åŸºç¡€ä¿¡æ¯ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ° é¢†åœ°åŸºç¡€ä¿¡æ¯</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="basic-info">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç»æµæ¦‚å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ’° ç»æµæ¦‚å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="economy-overview">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- äººå£æ¦‚å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ‘¥ äººå£æ¦‚å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="population-overview">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å¨èƒä¸å®‰å…¨ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">âš ï¸ å¨èƒä¸å®‰å…¨</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="threat-overview">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- äººå£é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-population" style="display: none;">
            <!-- è¯¦ç»†äººå£æ•°æ® -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ“Š è¯¦ç»†äººå£æ•°æ®</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="population-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- å¹´é¾„ç»“æ„ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ“… å¹´é¾„ç»“æ„</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="age-structure">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç§æ—æ„æˆ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸŒ ç§æ—æ„æˆ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="race-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- èŒä¸šåˆ†å¸ƒ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ¢ èŒä¸šåˆ†å¸ƒ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="occupation-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- æ»¡æ„åº¦ç»´åº¦ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ˜Š æ»¡æ„åº¦ç»´åº¦</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="satisfaction-dimensions">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ç»æµé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-economy" style="display: none;">
            <!-- è´¢æ”¿çŠ¶å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ’° è´¢æ”¿çŠ¶å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="finance-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è´¢æ”¿è¯¦ç»†æ„æˆ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ“Š è´¢æ”¿è¯¦ç»†æ„æˆ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="finance-composition">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç¨æ”¶ä½“ç³» -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ›ï¸ ç¨æ”¶ä½“ç³»</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="tax-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç‰©ä»·æŒ‡æ•° -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ’° ç‰©ä»·æŒ‡æ•°</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="price-index">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- èµ„æºé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-resources" style="display: none;">
            <!-- ä»“åº“ç‰©èµ„ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸª ä»“åº“ç‰©èµ„</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="resource-warnings"></div>
                    <table class="data-table" id="warehouse-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è‡ªç„¶èµ„æº -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸŒ³ è‡ªç„¶èµ„æº</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="natural-resources">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- ç¯å¢ƒçŠ¶å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸŒ¤ï¸ ç¯å¢ƒçŠ¶å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="environment-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å†›äº‹é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-military" style="display: none;">
            <!-- å…µåŠ›çŠ¶å†µ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">âš”ï¸ å…µåŠ›çŠ¶å†µ</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="military-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è£…å¤‡çŠ¶æ€ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ–ï¸ è£…å¤‡çŠ¶æ€</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="equipment-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- é˜²å¾¡è®¾æ–½ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ° é˜²å¾¡è®¾æ–½</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="defense-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å»ºç­‘é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-buildings" style="display: none;">
            <!-- å»ºç­‘åˆ—è¡¨ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ›ï¸ å»ºç­‘è®¾æ–½</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="buildings-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç§‘æŠ€é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-technology" style="display: none;">
            <!-- ç§‘æŠ€åˆ—è¡¨ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ”¬ ç§‘æŠ€ç ”å‘</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="technology-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é¡¹ç›®é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-projects" style="display: none;">
            <!-- é¡¹ç›®ä¿¡æ¯ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ—ï¸ å»ºè®¾é¡¹ç›®</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="projects-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ³•ä»¤é€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-decrees" style="display: none;">
            <!-- æ³•ä»¤åˆ—è¡¨ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ“œ æ³•ä»¤åˆ—è¡¨</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="decrees-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿé€‰é¡¹å¡ -->
        <div class="tab-content" id="tab-system" style="display: none;">
            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="system-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- é¢†ä¸»ä¿¡æ¯ -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ‘‘ é¢†ä¸»ä¿¡æ¯</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <table class="data-table" id="lord-details">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            
            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div class="section" id="debug-section" style="display: none;">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ› è°ƒè¯•ä¿¡æ¯</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div id="debug-info"></div>
                </div>
            </div>
            
            <!-- æ•°æ®ç®¡ç† -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">ğŸ”„ æ•°æ®ç®¡ç†</div>
                    <div class="section-toggle">â–¼</div>
                </div>
                <div class="section-content">
                    <div style="padding: 15px; text-align: center;">
                        <button class="control-btn" onclick="refreshData()" style="margin-bottom: 10px; width: 100%;">
                            ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ•°æ®
                        </button>
                        <button class="control-btn" onclick="exportData()" style="margin-bottom: 10px; width: 100%;">
                            ğŸ“¤ å¯¼å‡ºå½“å‰æ•°æ®
                        </button>
                        <button class="control-btn" onclick="monthlySettlement()" style="margin-bottom: 10px; width: 100%;">
                            ğŸ“… æ‰§è¡Œæœˆåº¦ç»“ç®—
                        </button>
                        <button class="control-btn" onclick="clearData()" style="margin-bottom: 10px; width: 100%; background: #dc3545;">
                            ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°æ•°æ®
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div class="footer">
            é¢†åœ°ç»è¥ç³»ç»Ÿ v3.0 | MVUå˜é‡é©±åŠ¨ | 
            <span onclick="refreshData()" style="color: #8B6914; cursor: pointer; text-decoration: underline;">
                ç‚¹å‡»åˆ·æ–°æ•°æ®
            </span>
        </div>
    </div>

    <script>
        // é¢†åœ°æ•°æ®å­˜å‚¨
        let territoryData = null;
        let lastUpdate = null;
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let debugMode = false;
        
        // æ•°æ®è½¬æ¢å‡½æ•° - ç®€åŒ–ç‰ˆï¼Œåªä¿®å¤æ ¸å¿ƒé—®é¢˜
        function convertMVUData(data) {
            if (!data || typeof data !== 'object') return data;
            
            // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå€¼ï¼‰
            // æ³¨æ„ï¼šæœ‰äº›æ•°ç»„å¯èƒ½åŒ…å«[å€¼, æè¿°]æ ¼å¼
            if (Array.isArray(data)) {
                return data.length > 0 ? data[0] : null;
            }
            
            // å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€’å½’å¤„ç†
            const result = {};
            
            for (const [key, value] of Object.entries(data)) {
                // è·³è¿‡$metaå±æ€§
                if (key === '$meta') continue;
                
                if (Array.isArray(value)) {
                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå€¼ï¼‰
                    result[key] = convertMVUData(value);
                } else if (typeof value === 'object' && value !== null) {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€’å½’å¤„ç†
                    // è·³è¿‡æ¨¡æ¿å¯¹è±¡
                    if (value.$meta && value.$meta.extensible === true) {
                        // å¯¹äºå¯æ‰©å±•å¯¹è±¡ï¼Œå¤„ç†å…¶å†…å®¹ä½†è·³è¿‡æ¨¡æ¿æœ¬èº«
                        const processedObj = {};
                        for (const [subKey, subValue] of Object.entries(value)) {
                            if (subKey !== '$meta') {
                                processedObj[subKey] = convertMVUData(subValue);
                            }
                        }
                        result[key] = processedObj;
                    } else {
                        result[key] = convertMVUData(value);
                    }
                } else {
                    // å…¶ä»–æƒ…å†µç›´æ¥èµ‹å€¼
                    result[key] = value;
                }
            }
            
            return result;
        }
        
        // ä»MVUè·å–æ•°æ® - æ¢å¤äº¤äº’åŠŸèƒ½ç‰ˆ
        async function fetchFromMVU() {
            try {
                showLoading(true);
                console.log('å¼€å§‹ä»MVUè·å–æ•°æ®...');
                
                let mvuData = null;
                
                // æ–¹æ³•1ï¼šä½¿ç”¨getVariables
                if (typeof getVariables === 'function') {
                    console.log('ä½¿ç”¨ getVariables()');
                    try {
                        mvuData = getVariables({
                            type: 'message',
                            message_id: getCurrentMessageId?.() || 'current'
                        });
                        console.log('getVariables è¿”å›:', mvuData);
                    } catch (e) {
                        console.error('getVariables é”™è¯¯:', e);
                    }
                }
                
                // æ–¹æ³•2ï¼šå°è¯•window.getVariables
                if (!mvuData && typeof window.getVariables === 'function') {
                    console.log('ä½¿ç”¨ window.getVariables()');
                    try {
                        mvuData = await window.getVariables({
                            type: 'message',
                            message_id: window.getCurrentMessageId?.() || 'current'
                        });
                    } catch (e) {
                        console.error('window.getVariables é”™è¯¯:', e);
                    }
                }
                
                // ä»stat_dataä¸­æå–Territoryæ•°æ®
                if (mvuData) {
                    console.log('åŸå§‹MVUæ•°æ®é”®:', Object.keys(mvuData));
                    
                    // å…³é”®ï¼šæ£€æŸ¥stat_dataæ˜¯å¦å­˜åœ¨
                    if (mvuData.stat_data) {
                        console.log('æ‰¾åˆ° stat_data');
                        
                        // æ£€æŸ¥Territoryæ˜¯å¦å­˜åœ¨
                        if (mvuData.stat_data.Territory) {
                            console.log('æ‰¾åˆ° Territory æ•°æ®');
                            territoryData = convertMVUData(mvuData.stat_data.Territory);
                        } else {
                            console.warn('stat_data ä¸­æ²¡æœ‰ Territory æ•°æ®');
                            // å°è¯•ä½¿ç”¨stat_dataæœ¬èº«
                            territoryData = convertMVUData(mvuData.stat_data);
                        }
                    } else if (mvuData.Territory) {
                        // å¦‚æœæ²¡æœ‰stat_dataï¼Œç›´æ¥å°è¯•Territory
                        console.log('ç›´æ¥æ‰¾åˆ° Territory æ•°æ®');
                        territoryData = convertMVUData(mvuData.Territory);
                    } else {
                        console.warn('MVUæ•°æ®ä¸­æ²¡æœ‰æ‰¾åˆ°é¢†åœ°æ•°æ®');
                        territoryData = getDefaultData();
                    }
                } else {
                    console.log('æ— æ³•ä»MVUè·å–æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤æ•°æ®');
                    const storedData = localStorage.getItem('territoryData');
                    if (storedData) {
                        territoryData = JSON.parse(storedData);
                        console.log('ä½¿ç”¨localStorageç¼“å­˜æ•°æ®');
                    } else {
                        territoryData = getDefaultData();
                        console.log('ä½¿ç”¨é»˜è®¤æ•°æ®');
                    }
                }
                
                // éªŒè¯æ•°æ®
                if (!territoryData || !territoryData.äººå£) {
                    console.warn('é¢†åœ°æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                    territoryData = getDefaultData();
                }
                
                console.log('æœ€ç»ˆé¢†åœ°æ•°æ®:', territoryData);
                
                lastUpdate = new Date();
                document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
                
                updateUI();
                localStorage.setItem('territoryData', JSON.stringify(territoryData));
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                territoryData = getDefaultData();
                updateUI();
            } finally {
                showLoading(false);
                adjustIframeHeight();
            }
        }
        
        // è·å–é»˜è®¤æ•°æ®
        function getDefaultData() {
            return {
                åŸºæœ¬ä¿¡æ¯: {
                    åç§°: "åŒ—å¢ƒè¾¹å¢ƒé¢†",
                    é¢ç§¯: 85,
                    åœ°å½¢: "ä¸˜é™µä¸æ£®æ—",
                    å‘å±•é˜¶æ®µ: "åˆå»º"
                },
                äººå£: {
                    æ€»äººå£: 1250,
                    ç§æ—æ„æˆ: {
                        äººç±»: { æ•°é‡: 900, åœ°ä½: "ä¸»å¯¼", ç‰¹æ®Šèƒ½åŠ›: "é€‚åº”æ€§å¼ºï¼Œå­¦ä¹ èƒ½åŠ›å¿«" },
                        çŸ®äºº: { æ•°é‡: 150, åœ°ä½: "å¹³ç­‰", ç‰¹æ®Šèƒ½åŠ›: "åœ°ä¸‹è§†è§‰ï¼Œé”»é€ ä¸çŸ³å·¥ä¸“ç²¾" },
                        åŠç²¾çµ: { æ•°é‡: 100, åœ°ä½: "å¹³ç­‰", ç‰¹æ®Šèƒ½åŠ›: "è‡ªç„¶äº²å’Œï¼Œå¼“ç®­ä¸è¿½è¸ªä¸“ç²¾" },
                        å“¥å¸ƒæ—: { æ•°é‡: 50, åœ°ä½: "å¥´éš¶", ç‰¹æ®Šèƒ½åŠ›: "å¤œè§†ï¼Œæ•æ·ï¼Œå°å‹å·¥ç¨‹" },
                        å…½äºº: { æ•°é‡: 30, åœ°ä½: "å—é™åˆ¶", ç‰¹æ®Šèƒ½åŠ›: "åŠ›é‡å¼ºå¤§ï¼Œè€åŠ›è¶…å¸¸" }
                    },
                    å¹´é¾„ç»“æ„: {
                        å„¿ç«¥_0-14: 250,
                        é’å¹´_15-35: 600,
                        ä¸­å¹´_36-60: 300,
                        è€å¹´_60: 100
                    },
                    æ»¡æ„åº¦ç»´åº¦: {
                        é£Ÿç‰©æ»¡æ„åº¦: 70,
                        ä½æˆ¿æ»¡æ„åº¦: 60,
                        å®‰å…¨æ»¡æ„åº¦: 65,
                        å¨±ä¹æ»¡æ„åº¦: 50,
                        ç¨æ”¶æ»¡æ„åº¦: 55,
                        å·¥ä½œæ»¡æ„åº¦: 65,
                        æ•™è‚²æ»¡æ„åº¦: 40,
                        åŒ»ç–—æ»¡æ„åº¦: 45
                    },
                    èŒä¸šåˆ†å¸ƒ: {
                        å†œæ°‘: { äººæ•°: 700, æœˆè´¡çŒ®: 15, å¹³å‡è–ªèµ„: 2, æ»¡æ„åº¦: 65 },
                        å·¥åŒ : { äººæ•°: 120, æœˆè´¡çŒ®: 25, å¹³å‡è–ªèµ„: 5, æ»¡æ„åº¦: 70 },
                        å•†äºº: { äººæ•°: 60, æœˆè´¡çŒ®: 30, å¹³å‡è–ªèµ„: 8, æ»¡æ„åº¦: 75 },
                        å®˜å‘˜: { äººæ•°: 15, æœˆè´¡çŒ®: -10, å¹³å‡è–ªèµ„: 10, æ»¡æ„åº¦: 80 },
                        å£«å…µ: { äººæ•°: 80, æœˆè´¡çŒ®: -20, å¹³å‡è–ªèµ„: 6, æ»¡æ„åº¦: 70 },
                        å­¦è€…: { äººæ•°: 10, æœˆè´¡çŒ®: 5, å¹³å‡è–ªèµ„: 7, æ»¡æ„åº¦: 85 },
                        æ— ä¸š: { äººæ•°: 265, æœˆè´¡çŒ®: 0, å¹³å‡è–ªèµ„: 0, æ»¡æ„åº¦: 40 }
                    },
                    äººå£å¢é•¿ç‡: 0.008
                },
                ç»æµ: {
                    è´¢æ”¿: {
                        åº“å­˜é‡‘å¸: 2500,
                        é¢†ä¸»èµ„äº§_æœˆæ”¶å…¥: 400,
                        é¢†ä¸»èµ„äº§_æœˆæ”¯å‡º: 135,
                        ç§æœ‰èµ„äº§_åº”ç¨æ”¶å…¥: 960,
                        ç§æœ‰èµ„äº§ç¨ç‡: 0.15,
                        ç§æœ‰èµ„äº§_ç¨æ”¶: 144,
                        ç‰¹æ®Šæ”¶æ”¯: 0,
                        æœˆæ€»æ”¶å…¥: 544,
                        æœˆæ€»æ”¯å‡º: 135,
                        æœˆå‡€æ”¶å…¥: 409,
                        æ”¶æ”¯çŠ¶æ€: "ğŸ“ˆç›ˆä½™"
                    },
                    å…¬å…±ç¨ç‡: {
                        å†œä¸šç¨: 0.10,
                        å•†ä¸šç¨: 0.15,
                        å·¥ä¸šç¨: 0.12,
                        ä¸ªäººæ‰€å¾—ç¨: 0.05
                    },
                    ç‰©ä»·æŒ‡æ•°: {
                        ç²®é£Ÿå•ä»·: 0.4,
                        æœ¨æå•ä»·: 1.8,
                        çŸ³æå•ä»·: 2.5,
                        é“çŸ¿å•ä»·: 3.0,
                        æ­¦å™¨å•ä»·: 15,
                        å·¥å…·å•ä»·: 8
                    }
                },
                ä»“åº“: {
                    res_food_grain: {
                        åç§°: "ç²®é£Ÿ",
                        å½“å‰å‚¨é‡: 6500,
                        å®‰å…¨å‚¨é‡: 3750,
                        å•ä½: "æ‹…",
                        å¸‚åœºä»·æ ¼: 0.4
                    },
                    res_material_wood: {
                        åç§°: "æœ¨æ",
                        å½“å‰å‚¨é‡: 900,
                        å®‰å…¨å‚¨é‡: 300,
                        å•ä½: "æ–¹",
                        å¸‚åœºä»·æ ¼: 1.8
                    },
                    res_material_stone: {
                        åç§°: "çŸ³æ",
                        å½“å‰å‚¨é‡: 500,
                        å®‰å…¨å‚¨é‡: 200,
                        å•ä½: "æ–¹",
                        å¸‚åœºä»·æ ¼: 2.5
                    },
                    res_material_iron: {
                        åç§°: "é“çŸ¿",
                        å½“å‰å‚¨é‡: 300,
                        å®‰å…¨å‚¨é‡: 100,
                        å•ä½: "æ–¤",
                        å¸‚åœºä»·æ ¼: 3.0
                    },
                    item_weapon_spear: {
                        åç§°: "é•¿çŸ›",
                        å½“å‰å‚¨é‡: 30,
                        å®‰å…¨å‚¨é‡: 50,
                        å•ä½: "æŠŠ",
                        å¸‚åœºä»·æ ¼: 12
                    },
                    item_tool_hammer: {
                        åç§°: "é“é”¤",
                        å½“å‰å‚¨é‡: 40,
                        å®‰å…¨å‚¨é‡: 30,
                        å•ä½: "æŠŠ",
                        å¸‚åœºä»·æ ¼: 8
                    }
                },
                èµ„æºåŠ¨æ€: {
                    æ£®æ—: {
                        å½“å‰å‚¨é‡: 12000,
                        æ¯æœˆå¼€é‡‡é‡: 150,
                        å¼€é‡‡éš¾åº¦: 0.6,
                        çŸ¿çŸ³å“è´¨: 0.7,
                        é¢„ä¼°æ¯ç«­æ—¶é—´: 100
                    },
                    é“çŸ¿è„‰: {
                        å½“å‰å‚¨é‡: 5000,
                        æ¯æœˆå¼€é‡‡é‡: 50,
                        å¼€é‡‡éš¾åº¦: 0.6,
                        çŸ¿çŸ³å“è´¨: 0.7,
                        é¢„ä¼°æ¯ç«­æ—¶é—´: 100
                    },
                    çŸ³çŸ¿: {
                        å½“å‰å‚¨é‡: 8000,
                        æ¯æœˆå¼€é‡‡é‡: 40,
                        å¼€é‡‡éš¾åº¦: 0.5,
                        çŸ¿çŸ³å“è´¨: 0.8,
                        é¢„ä¼°æ¯ç«­æ—¶é—´: 200
                    }
                },
                å†›äº‹: {
                    å…µåŠ›: {
                        å¸¸å¤‡å†›: 80,
                        æ°‘å…µ: 200,
                        ç²¾é”éƒ¨é˜Ÿ: 0
                    },
                    æˆ˜åŠ›è¯„çº§: {
                        æ€»è¯„çº§: "D",
                        é¢†ä¸»æˆ˜åŠ›: "B",
                        å†›é˜Ÿæˆ˜åŠ›: "E",
                        é˜²å¾¡è¯„çº§: "D+"
                    },
                    è£…å¤‡çŠ¶æ€: {
                        è£…å¤‡å®Œæ•´ç‡: 0.65,
                        è®­ç»ƒæ°´å¹³: 0.5,
                        å£«æ°”: 70
                    },
                    é˜²å¾¡è®¾æ–½: {
                        åŸå¢™å®Œæ•´åº¦: 0.7,
                        ç­æœ›å¡”æ•°é‡: 2,
                        åŸé—¨çŠ¶æ€: "å®Œå¥½",
                        æŠ¤åŸæ²³: "æ— "
                    }
                },
                çŠ¶æ€: {
                    å±…æ°‘çŠ¶æ€: {
                        ç”Ÿæ´»æ°´å¹³: "æ¸©é¥±",
                        æ²»å®‰çŠ¶å†µ: 65,
                        æ°‘å¿ƒæŒ‡æ•°: 70,
                        å½“å‰äº‹ä»¶: "æš‚æ— ",
                        æµè¡Œç—…é£é™©: 0.1,
                        çŠ¯ç½ªç‡: 0.05
                    },
                    å¨èƒçŠ¶æ€: {
                        å¨èƒç­‰çº§: "è­¦æˆ’",
                        ä¸»è¦é­”ç‰©: "å“¥å¸ƒæ—å›¢ä¼™",
                        é­”ç‰©æ•°é‡: "çº¦30-50",
                        ä¸Šæ¬¡è¢­å‡»: "ä¸€ä¸ªæœˆå‰",
                        å¨èƒæ–¹å‘: "åŒ—é¢æ£®æ—",
                        é¢„è®¡ä¸‹æ¬¡è¢­å‡»: "1-3ä¸ªæœˆå†…"
                    }
                },
                ç¯å¢ƒ: {
                    å­£èŠ‚å½±å“: {
                        å†œä¸šäº§å‡ºä¿®æ­£: 1.2,
                        å•†ä¸šæ´»åŠ¨ä¿®æ­£: 1.0,
                        å†›äº‹è¡ŒåŠ¨ä¿®æ­£: 0.9,
                        èµ„æºé‡‡é›†ä¿®æ­£: 1.1
                    },
                    å¤©æ°”çŠ¶å†µ: "æ™´æœ—",
                    è‡ªç„¶ç¾å®³é£é™©: 0.1,
                    æ¸©åº¦: 15,
                    é™æ°´: "é€‚ä¸­"
                },
                å»ºç­‘: {
                    building_blacksmith: {
                        åç§°: "é“åŒ é“º",
                        ç±»å‹: "ç”Ÿäº§",
                        äº§æƒ: "private",
                        ç­‰çº§: 1,
                        çŠ¶æ€: "æ­£å¸¸è¿è¥",
                        å²—ä½: {
                            å½“å‰äººæ•°: 4,
                            æœ€å¤§äººæ•°: 8,
                            æœˆè–ª: 4
                        },
                        ç”Ÿäº§é…æ–¹: {
                            æŠ•å…¥èµ„æº: {
                                res_material_iron: 2,
                                res_material_wood: 1
                            },
                            äº§å‡ºèµ„æº: {
                                item_weapon_spear: 3,
                                item_tool_hammer: 5
                            },
                            ç”Ÿäº§æ•ˆç‡: 0.8,
                            æ¯æœˆäº§é‡: 0
                        },
                        å‡çº§è·¯å¾„: {
                            ä¸‹ä¸€ç­‰çº§: 2,
                            æ‰€éœ€é‡‘å¸: 500,
                            æ‰€éœ€ææ–™: {
                                æœ¨æ: 100,
                                çŸ³æ: 50,
                                é“çŸ¿: 80
                            },
                            æ‰€éœ€æ—¶é—´: 30,
                            å‡çº§æ•ˆæœ: {
                                åŸºç¡€æ”¶å…¥å¢åŠ : 20,
                                æœ€å¤§å²—ä½å¢åŠ : 2,
                                ç”Ÿäº§æ•ˆç‡æå‡: 0.15,
                                æ–°åŠŸèƒ½è§£é”: "å¯ç”Ÿäº§é”å­ç”²"
                            }
                        },
                        è´¢åŠ¡: {
                            åŸºç¡€æ”¶å…¥: 60,
                            äººå‡äº§å‡ºä»·å€¼: 15,
                            ç»´æŠ¤è´¹ç”¨: 30,
                            è®¡ç®—_æœˆæ”¶å…¥: 120,
                            è®¡ç®—_æœˆæ”¯å‡º: 46,
                            è®¡ç®—_å‡€æ”¶ç›Š: 74
                        },
                        ç‰¹æ®Šæ•ˆæœ: "ç”Ÿäº§æ­¦å™¨å’Œå·¥å…·ï¼Œæå‡å†›é˜Ÿè£…å¤‡å®Œæ•´ç‡ã€‚"
                    },
                    building_market: {
                        åç§°: "ä¸­å¿ƒå¸‚åœº",
                        ç±»å‹: "å•†ä¸š",
                        äº§æƒ: "lord",
                        ç­‰çº§: 2,
                        çŠ¶æ€: "æ­£å¸¸è¿è¥",
                        å²—ä½: {
                            å½“å‰äººæ•°: 25,
                            æœ€å¤§äººæ•°: 40,
                            æœˆè–ª: 3
                        },
                        ç”Ÿäº§é…æ–¹: {
                            æŠ•å…¥èµ„æº: {},
                            äº§å‡ºèµ„æº: {},
                            ç”Ÿäº§æ•ˆç‡: 1.0,
                            æ¯æœˆäº§é‡: 0
                        },
                        å‡çº§è·¯å¾„: {
                            ä¸‹ä¸€ç­‰çº§: 3,
                            æ‰€éœ€é‡‘å¸: 800,
                            æ‰€éœ€ææ–™: {
                                æœ¨æ: 150,
                                çŸ³æ: 100,
                                é“çŸ¿: 30
                            },
                            æ‰€éœ€æ—¶é—´: 45,
                            å‡çº§æ•ˆæœ: {
                                åŸºç¡€æ”¶å…¥å¢åŠ : 100,
                                æœ€å¤§å²—ä½å¢åŠ : 10,
                                ç”Ÿäº§æ•ˆç‡æå‡: 0,
                                æ–°åŠŸèƒ½è§£é”: "å¯ä¸¾åŠæœˆåº¦é›†å¸‚"
                            }
                        },
                        è´¢åŠ¡: {
                            åŸºç¡€æ”¶å…¥: 200,
                            äººå‡äº§å‡ºä»·å€¼: 8,
                            ç»´æŠ¤è´¹ç”¨: 60,
                            è®¡ç®—_æœˆæ”¶å…¥: 400,
                            è®¡ç®—_æœˆæ”¯å‡º: 135,
                            è®¡ç®—_å‡€æ”¶ç›Š: 265
                        },
                        ç‰¹æ®Šæ•ˆæœ: "æå‡é¢†åœ°å•†ä¸šç¹è£åº¦ï¼Œæ˜¯å•†ä¸šç¨çš„ä¸»è¦æ¥æºã€‚"
                    }
                },
                ç§‘æŠ€: {
                    tech_basic_agriculture: {
                        åç§°: "åŸºç¡€å†œä¸šæŠ€æœ¯",
                        ç±»åˆ«: "å†œä¸š",
                        ç ”å‘çŠ¶æ€: "å·²ç ”å‘",
                        ç ”å‘æˆæœ¬: {
                            é‡‘å¸: 200,
                            æ—¶é—´: 30,
                            äººå‘˜: 2
                        },
                        å½“å‰è¿›åº¦: 100,
                        æ•ˆæœæè¿°: "æé«˜ç²®é£Ÿäº§é‡å’Œå†œä¸šæ•ˆç‡ã€‚",
                        å…·ä½“æ•ˆæœ: {
                            ç»æµæ•ˆæœ: {
                                æ”¶å…¥åŠ æˆ: 0.1,
                                æ•ˆç‡æå‡: 0.15,
                                æˆæœ¬é™ä½: 0.05
                            },
                            å†›äº‹æ•ˆæœ: {
                                æˆ˜åŠ›æå‡: 0,
                                è®­ç»ƒæ•ˆç‡: 0,
                                è£…å¤‡è´¨é‡: 0
                            },
                            ç¤¾ä¼šæ•ˆæœ: {
                                æ°‘å¿ƒå½±å“: 5,
                                æ²»å®‰å½±å“: 2,
                                äººå£å½±å“: 0.01
                            }
                        }
                    },
                    tech_iron_smelting: {
                        åç§°: "é“å™¨å†¶ç‚¼æŠ€æœ¯",
                        ç±»åˆ«: "å·¥ä¸š",
                        ç ”å‘çŠ¶æ€: "ç ”å‘ä¸­",
                        ç ”å‘æˆæœ¬: {
                            é‡‘å¸: 500,
                            æ—¶é—´: 60,
                            äººå‘˜: 5
                        },
                        å½“å‰è¿›åº¦: 45,
                        æ•ˆæœæè¿°: "æ”¹è¿›é“å™¨å†¶ç‚¼å·¥è‰ºï¼Œæé«˜æ­¦å™¨å’Œå·¥å…·è´¨é‡ã€‚",
                        å…·ä½“æ•ˆæœ: {
                            ç»æµæ•ˆæœ: {
                                æ”¶å…¥åŠ æˆ: 0,
                                æ•ˆç‡æå‡: 0.2,
                                æˆæœ¬é™ä½: 0.1
                            },
                            å†›äº‹æ•ˆæœ: {
                                æˆ˜åŠ›æå‡: 0.15,
                                è®­ç»ƒæ•ˆç‡: 0,
                                è£…å¤‡è´¨é‡: 0.25
                            },
                            ç¤¾ä¼šæ•ˆæœ: {
                                æ°‘å¿ƒå½±å“: 3,
                                æ²»å®‰å½±å“: 5,
                                äººå£å½±å“: 0
                            }
                        }
                    },
                    tech_basic_military_tactics: {
                        åç§°: "åŸºç¡€å†›äº‹æˆ˜æœ¯",
                        ç±»åˆ«: "å†›äº‹",
                        ç ”å‘çŠ¶æ€: "æœªç ”å‘",
                        ç ”å‘æˆæœ¬: {
                            é‡‘å¸: 300,
                            æ—¶é—´: 45,
                            äººå‘˜: 3
                        },
                        å½“å‰è¿›åº¦: 0,
                        æ•ˆæœæè¿°: "æé«˜å†›é˜Ÿè®­ç»ƒæ•ˆç‡å’Œæˆ˜æ–—èƒ½åŠ›ã€‚",
                        å…·ä½“æ•ˆæœ: {
                            ç»æµæ•ˆæœ: {
                                æ”¶å…¥åŠ æˆ: 0,
                                æ•ˆç‡æå‡: 0,
                                æˆæœ¬é™ä½: 0.05
                            },
                            å†›äº‹æ•ˆæœ: {
                                æˆ˜åŠ›æå‡: 0.2,
                                è®­ç»ƒæ•ˆç‡: 0.25,
                                è£…å¤‡è´¨é‡: 0
                            },
                            ç¤¾ä¼šæ•ˆæœ: {
                                æ°‘å¿ƒå½±å“: 2,
                                æ²»å®‰å½±å“: 8,
                                äººå£å½±å“: 0
                            }
                        }
                    }
                },
                é¡¹ç›®: {
                    å½“å‰å»ºè®¾é¡¹ç›®: "åŸå¢™æ‰©å»º",
                    é¡¹ç›®è¿›åº¦: 30,
                    é¡¹ç›®æ‰€éœ€èµ„æº: {
                        é‡‘å¸: 1000,
                        æœ¨æ: 200,
                        çŸ³æ: 300,
                        é“çŸ¿: 50
                    }
                },
                æ³•ä»¤: {
                    decree_basic_tax: {
                        åç§°: "åŸºç¡€ç¨æ³•",
                        ç”Ÿæ•ˆçŠ¶æ€: true,
                        ç”Ÿæ•ˆæ—¶é—´: "ç¬¬1å¹´ 1æœˆ",
                        å¤±æ•ˆæ¡ä»¶: "è¢«æ–°ç¨æ³•å–ä»£",
                        ç»æµæ•ˆæœ: {
                            ç¨ç‡ä¿®æ­£: 0,
                            ä¸“é¡¹ç¨ç‡: 0,
                            å›ºå®šæ”¶å…¥: 0,
                            å›ºå®šæ”¯å‡º: 0,
                            æ•ˆç‡åŠ æˆ: 0
                        },
                        ç¤¾ä¼šæ•ˆæœ: {
                            æ°‘å¿ƒå½±å“: 0,
                            æ²»å®‰å½±å“: 0,
                            äººå£å½±å“: 0
                        }
                    }
                },
                System: {
                    å½“å‰æ¸¸æˆæ—¶é—´: "ç¬¬1å¹´ 1æœˆ",
                    å½“å‰å­£èŠ‚: "æ˜¥å­£",
                    ä¸Šæ¬¡ç»“ç®—æ—¶é—´: "ç¬¬1å¹´ 1æœˆ",
                    è‡ªåŠ¨ç»“ç®—å¼€å…³: false
                },
                Character: {
                    é¢†ä¸»: {
                        å§“å: "è‰¾ä¸¹",
                        ç§°å·: "è¾¹å¢ƒå®ˆæŠ¤è€…",
                        å¥åº·çŠ¶æ€: "è‰¯å¥½",
                        ä¸ªäººæˆ˜åŠ›: "B",
                        ç®¡ç†èƒ½åŠ›: 65,
                        å†›äº‹èƒ½åŠ›: 70,
                        å¤–äº¤èƒ½åŠ›: 55,
                        çŸ¥è¯†æ°´å¹³: 60
                    }
                }
            };
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const refreshBtn = document.querySelector('.control-btn[onclick="refreshData()"]');
            if (refreshBtn) {
                if (show) {
                    refreshBtn.innerHTML = '<div class="loading"></div>åˆ·æ–°ä¸­...';
                    refreshBtn.disabled = true;
                } else {
                    refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                    refreshBtn.disabled = false;
                }
            }
        }
        
        // æ›´æ–°UI
        function updateUI() {
            if (!territoryData) {
                console.warn('æ²¡æœ‰æ•°æ®å¯æ›´æ–°');
                return;
            }
            
            console.log('æ›´æ–°UIï¼Œå½“å‰æ•°æ®:', territoryData);
            
            updateQuickStats();
            updateBasicInfo();
            updateEconomyOverview();
            updatePopulationOverview();
            updateThreatOverview();
            updateResourceWarnings();
            
            // å¼ºåˆ¶åˆ·æ–°å½“å‰æ‰“å¼€çš„é€‰é¡¹å¡å†…å®¹
            refreshCurrentTab();
            
            // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ ¹æ®å½“å‰æ¿€æ´»çš„é€‰é¡¹å¡æ›´æ–°å†…å®¹ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.textContent.trim();
                // ç¡®ä¿é€‰é¡¹å¡å†…å®¹å·²åŠ è½½
                switch(tabName) {
                    case 'äººå£':
                        loadTabData('population');
                        break;
                    case 'ç»æµ':
                        loadTabData('economy');
                        break;
                    case 'èµ„æº':
                        loadTabData('resources');
                        break;
                    case 'å†›äº‹':
                        loadTabData('military');
                        break;
                    case 'å»ºç­‘':
                        loadTabData('buildings');
                        break;
                    case 'ç§‘æŠ€':
                        loadTabData('technology');
                        break;
                    case 'é¡¹ç›®':
                        loadTabData('projects');
                        break;
                    case 'æ³•ä»¤':
                        loadTabData('decrees');
                        break;
                    case 'ç³»ç»Ÿ':
                        loadTabData('system');
                        break;
                }
            }
        }
        
        // åˆ·æ–°å½“å‰æ‰“å¼€çš„é€‰é¡¹å¡
        function refreshCurrentTab() {
            // æ£€æŸ¥æ‰€æœ‰å¯è§çš„é€‰é¡¹å¡å†…å®¹ï¼Œå¹¶é‡æ–°åŠ è½½å®ƒä»¬
            document.querySelectorAll('.tab-content').forEach(tab => {
                if (tab.style.display !== 'none' && tab.id !== 'tab-overview') {
                    // æ ¹æ®é€‰é¡¹å¡IDç¡®å®šè¦åŠ è½½çš„å†…å®¹
                    const tabId = tab.id;
                    
                    switch(tabId) {
                        case 'tab-population':
                            loadTabData('population');
                            break;
                        case 'tab-economy':
                            loadTabData('economy');
                            break;
                        case 'tab-resources':
                            loadTabData('resources');
                            break;
                        case 'tab-military':
                            loadTabData('military');
                            break;
                        case 'tab-buildings':
                            loadTabData('buildings');
                            break;
                        case 'tab-technology':
                            loadTabData('technology');
                            break;
                        case 'tab-projects':
                            loadTabData('projects');
                            break;
                        case 'tab-decrees':
                            loadTabData('decrees');
                            break;
                        case 'tab-system':
                            loadTabData('system');
                            break;
                    }
                }
            });
        }
        
        // æ›´æ–°å¿«é€ŸçŠ¶æ€ - ç§»é™¤ç§»æ°‘ç‡å’Œç»æµæŒ‡æ ‡
        function updateQuickStats() {
            const container = document.getElementById('quick-stats');
            if (!container) return;
            
            const basic = territoryData.åŸºæœ¬ä¿¡æ¯ || {};
            const population = territoryData.äººå£ || {};
            const finance = territoryData.ç»æµ?.è´¢æ”¿ || {};
            const residents = territoryData.çŠ¶æ€?.å±…æ°‘çŠ¶æ€ || {};
            const threat = territoryData.çŠ¶æ€?.å¨èƒçŠ¶æ€ || {};
            
            // å®‰å…¨è·å–æ•°æ®ï¼Œé˜²æ­¢NaN
            const totalPopulation = safeNumber(population.æ€»äººå£, 1250);
            const treasury = safeNumber(finance.åº“å­˜é‡‘å¸, 2500);
            const netIncome = safeNumber(finance.æœˆå‡€æ”¶å…¥, 409);
            const threatLevel = safeString(threat.å¨èƒç­‰çº§, 'è­¦æˆ’');
            const morale = safeNumber(residents.æ°‘å¿ƒæŒ‡æ•°, 70);
            const area = safeNumber(basic.é¢ç§¯, 85);
            
            const stats = [
                { 
                    label: 'æ€»äººå£', 
                    value: formatNumber(totalPopulation), 
                    unit: 'äºº',
                    color: '#2C1810'
                },
                { 
                    label: 'å›½åº“èµ„é‡‘', 
                    value: formatCurrency(treasury),
                    color: '#ffc107'
                },
                { 
                    label: 'æœˆåº¦å‡€æ”¶å…¥', 
                    value: formatCurrency(netIncome, true),
                    color: netIncome >= 0 ? '#28a745' : '#dc3545'
                },
                { 
                    label: 'å¨èƒç­‰çº§', 
                    value: threatLevel,
                    color: getThreatColor(threatLevel)
                },
                { 
                    label: 'æ°‘å¿ƒæŒ‡æ•°', 
                    value: formatNumber(morale),
                    unit: '/100',
                    color: getMoraleColor(morale)
                },
                { 
                    label: 'é¢†åœ°é¢ç§¯', 
                    value: formatNumber(area),
                    unit: 'å¹³æ–¹é‡Œ',
                    color: '#2C1810'
                }
            ];
            
            let html = '';
            stats.forEach(stat => {
                const colorStyle = stat.color ? `style="color: ${stat.color};"` : '';
                html += `
                    <div class="stat-card">
                        <div class="stat-value" ${colorStyle}>${stat.value}${stat.unit || ''}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // å®‰å…¨è·å–æ•°å­—
        function safeNumber(value, defaultValue = 0) {
            if (value === undefined || value === null || isNaN(value)) {
                return defaultValue;
            }
            return Number(value);
        }
        
        // å®‰å…¨è·å–å­—ç¬¦ä¸²
        function safeString(value, defaultValue = '') {
            if (value === undefined || value === null) {
                return defaultValue;
            }
            return String(value);
        }
        
        // æ›´æ–°åŸºç¡€ä¿¡æ¯
        function updateBasicInfo() {
            const container = document.getElementById('basic-info');
            if (!container) return;
            
            const basic = territoryData.åŸºæœ¬ä¿¡æ¯ || {};
            const system = territoryData.System || {};
            
            const rows = [
                ['é¢†åœ°åç§°', safeString(basic.åç§°, 'åŒ—å¢ƒè¾¹å¢ƒé¢†')],
                ['é¢†åœ°é¢ç§¯', `${safeNumber(basic.é¢ç§¯, 85)} å¹³æ–¹é‡Œ`],
                ['åœ°å½¢ç‰¹å¾', safeString(basic.åœ°å½¢, 'ä¸˜é™µä¸æ£®æ—')],
                ['å‘å±•é˜¶æ®µ', safeString(basic.å‘å±•é˜¶æ®µ, 'åˆå»º')],
                ['æ¸¸æˆæ—¶é—´', safeString(system.å½“å‰æ¸¸æˆæ—¶é—´, 'ç¬¬1å¹´ 1æœˆ')],
                ['å½“å‰å­£èŠ‚', safeString(system.å½“å‰å­£èŠ‚, 'æ˜¥å­£')]
            ];
            
            let html = '';
            rows.forEach(row => {
                html += `
                    <tr>
                        <td style="width: 100px;">${row[0]}</td>
                        <td>${row[1]}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°ç»æµæ¦‚å†µ
        function updateEconomyOverview() {
            const container = document.getElementById('economy-overview');
            if (!container) return;
            
            const finance = territoryData.ç»æµ?.è´¢æ”¿ || {};
            const taxes = territoryData.ç»æµ?.å…¬å…±ç¨ç‡ || {};
            
            const income = safeNumber(finance.æœˆæ€»æ”¶å…¥, 544);
            const expense = safeNumber(finance.æœˆæ€»æ”¯å‡º, 135);
            const net = safeNumber(finance.æœˆå‡€æ”¶å…¥, 409);
            const balanceStatus = safeString(finance.æ”¶æ”¯çŠ¶æ€, 'ğŸ“ˆç›ˆä½™');
            
            const incomeColor = income >= expense ? '#28a745' : '#dc3545';
            const netColor = net >= 0 ? '#28a745' : '#dc3545';
            
            let html = `
                <table class="data-table">
                    <tr>
                        <td style="width: 100px;">æœˆæ€»æ”¶å…¥</td>
                        <td style="color: ${incomeColor}; font-weight: bold;">${formatCurrency(income)}</td>
                    </tr>
                    <tr>
                        <td>æœˆæ€»æ”¯å‡º</td>
                        <td style="color: #dc3545;">${formatCurrency(expense)}</td>
                    </tr>
                    <tr>
                        <td>æœˆå‡€æ”¶å…¥</td>
                        <td style="color: ${netColor}; font-weight: bold;">${formatCurrency(net, true)}</td>
                    </tr>
                    <tr>
                        <td>æ”¶æ”¯çŠ¶æ€</td>
                        <td>${balanceStatus}</td>
                    </tr>
                    <tr>
                        <td>ç¨ç‡ä½“ç³»</td>
                        <td>
                            å†œä¸š: ${(safeNumber(taxes.å†œä¸šç¨, 0.10) * 100).toFixed(1)}% | 
                            å•†ä¸š: ${(safeNumber(taxes.å•†ä¸šç¨, 0.15) * 100).toFixed(1)}% | 
                            å·¥ä¸š: ${(safeNumber(taxes.å·¥ä¸šç¨, 0.12) * 100).toFixed(1)}%
                        </td>
                    </tr>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°äººå£æ¦‚å†µ - ç§»é™¤ç§»æ°‘ç‡
        function updatePopulationOverview() {
            const container = document.getElementById('population-overview');
            if (!container) return;
            
            const population = territoryData.äººå£ || {};
            const total = safeNumber(population.æ€»äººå£, 1250);
            const races = population.ç§æ—æ„æˆ || {};
            
            // è®¡ç®—ç§æ—åˆ†å¸ƒ
            let raceHtml = '<div style="margin-top: 10px;">';
            Object.entries(races).forEach(([name, data]) => {
                // ç¡®ä¿dataæ˜¯å¯¹è±¡
                if (typeof data === 'object' && data !== null) {
                    const count = safeNumber(data.æ•°é‡, 0);
                    const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const status = safeString(data.åœ°ä½, '');
                    
                    raceHtml += `
                        <div style="margin-bottom: 5px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <span>${name}</span>
                                <span>${count}äºº (${percentage}%)</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div style="font-size: 11px; color: #4A3728;">åœ°ä½: ${status}</div>
                        </div>
                    `;
                }
            });
            raceHtml += '</div>';
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">æ€»äººå£: ${formatNumber(total)} äºº</div>
                    <div style="font-size: 12px; color: #4A3728;">
                        å¢é•¿ç‡: ${(safeNumber(population.äººå£å¢é•¿ç‡, 0.008) * 100).toFixed(2)}%
                    </div>
                </div>
                ${raceHtml}
            `;
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°å¨èƒæ¦‚å†µ
        function updateThreatOverview() {
            const container = document.getElementById('threat-overview');
            if (!container) return;
            
            const threat = territoryData.çŠ¶æ€?.å¨èƒçŠ¶æ€ || {};
            const residents = territoryData.çŠ¶æ€?.å±…æ°‘çŠ¶æ€ || {};
            
            const threatLevel = safeString(threat.å¨èƒç­‰çº§, 'è­¦æˆ’');
            const threatColor = getThreatColor(threatLevel);
            const morale = safeNumber(residents.æ°‘å¿ƒæŒ‡æ•°, 70);
            const moraleColor = getMoraleColor(morale);
            
            // æ–°å¢å±…æ°‘çŠ¶æ€æ‰©å±•
            const epidemicRisk = safeNumber(residents.æµè¡Œç—…é£é™©, 0.1);
            const crimeRate = safeNumber(residents.çŠ¯ç½ªç‡, 0.05);
            
            let html = `
                <table class="data-table">
                    <tr>
                        <td style="width: 100px;">å¨èƒç­‰çº§</td>
                        <td style="color: ${threatColor}; font-weight: bold;">${threatLevel}</td>
                    </tr>
                    <tr>
                        <td>ä¸»è¦å¨èƒ</td>
                        <td>${safeString(threat.ä¸»è¦é­”ç‰©, 'å“¥å¸ƒæ—å›¢ä¼™')}</td>
                    </tr>
                    <tr>
                        <td>é­”ç‰©æ•°é‡</td>
                        <td>${safeString(threat.é­”ç‰©æ•°é‡, 'çº¦30-50')}</td>
                    </tr>
                    <tr>
                        <td>ä¸Šæ¬¡è¢­å‡»</td>
                        <td>${safeString(threat.ä¸Šæ¬¡è¢­å‡», 'ä¸€ä¸ªæœˆå‰')}</td>
                    </tr>
                    <tr>
                        <td>å¨èƒæ–¹å‘</td>
                        <td>${safeString(threat.å¨èƒæ–¹å‘, 'åŒ—é¢æ£®æ—')}</td>
                    </tr>
                    <tr>
                        <td>é¢„ä¼°ä¸‹æ¬¡è¢­å‡»</td>
                        <td>${safeString(threat.é¢„è®¡ä¸‹æ¬¡è¢­å‡», '1-3ä¸ªæœˆå†…')}</td>
                    </tr>
                    <tr>
                        <td>ç”Ÿæ´»æ°´å¹³</td>
                        <td>${safeString(residents.ç”Ÿæ´»æ°´å¹³, 'æ¸©é¥±')}</td>
                    </tr>
                    <tr>
                        <td>æ²»å®‰çŠ¶å†µ</td>
                        <td>${safeNumber(residents.æ²»å®‰çŠ¶å†µ, 65)}/100</td>
                    </tr>
                    <tr>
                        <td>æµè¡Œç—…é£é™©</td>
                        <td>${(epidemicRisk * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>çŠ¯ç½ªç‡</td>
                        <td>${(crimeRate * 100).toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>æ°‘å¿ƒæŒ‡æ•°</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${moraleColor}; font-weight: bold;">${morale}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${morale}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°èµ„æºé¢„è­¦
        function updateResourceWarnings() {
            const container = document.getElementById('resource-warnings');
            if (!container) return;
            
            const warehouse = territoryData.ä»“åº“ || {};
            let warnings = [];
            
            Object.values(warehouse).forEach(item => {
                const current = safeNumber(item.å½“å‰å‚¨é‡, 0);
                const safe = safeNumber(item.å®‰å…¨å‚¨é‡, 0);
                if (current < safe) {
                    warnings.push({
                        name: safeString(item.åç§°, 'æœªçŸ¥'),
                        current: current,
                        safe: safe,
                        unit: safeString(item.å•ä½, '')
                    });
                }
            });
            
            if (warnings.length > 0) {
                let html = '<div class="alert alert-warning">';
                html += '<strong>âš ï¸ ç‰©èµ„é¢„è­¦</strong><br>';
                warnings.forEach(warning => {
                    html += `${warning.name}: ${warning.current}${warning.unit} (å®‰å…¨çº¿: ${warning.safe}${warning.unit})<br>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '';
            }
        }
        
        // åˆ‡æ¢ç« èŠ‚æ˜¾ç¤º/éšè— - æ¢å¤åŠŸèƒ½
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.section-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
            
            adjustIframeHeight();
        }
        
        // åˆ‡æ¢é€‰é¡¹å¡ - æ¢å¤åŠŸèƒ½
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰é€‰é¡¹å¡
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é€‰é¡¹å¡
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            
            // è®¾ç½®æ´»åŠ¨çŠ¶æ€
            const targetBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
                btn.textContent.trim().toLowerCase().includes(tabName)
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // æ ¹æ®éœ€è¦åŠ è½½é€‰é¡¹å¡æ•°æ® - å¼ºåˆ¶åˆ·æ–°
            loadTabData(tabName);
            
            adjustIframeHeight();
        }
        
        // åŠ è½½é€‰é¡¹å¡æ•°æ®
        function loadTabData(tabName) {
            if (!territoryData) return;
            
            console.log(`åŠ è½½é€‰é¡¹å¡æ•°æ®: ${tabName}`);
            
            switch(tabName) {
                case 'overview':
                    // æ¦‚è§ˆé€‰é¡¹å¡å·²ç»åœ¨updateUIä¸­æ›´æ–°
                    break;
                case 'population':
                    // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
                    const popTables = ['population-details', 'age-structure', 'race-details', 'occupation-details', 'satisfaction-dimensions'];
                    popTables.forEach(tableId => {
                        const table = document.getElementById(tableId);
                        if (table) table.innerHTML = '';
                    });
                    loadPopulationDetails();
                    break;
                case 'economy':
                    // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹
                    const economyTables = ['finance-details', 'finance-composition', 'tax-details', 'price-index'];
                    economyTables.forEach(tableId => {
                        const table = document.getElementById(tableId);
                        if (table) table.innerHTML = '';
                    });
                    loadEconomyDetails();
                    break;
                case 'resources':
                    // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹
                    const resourceTables = ['warehouse-details', 'natural-resources', 'environment-details'];
                    resourceTables.forEach(tableId => {
                        const table = document.getElementById(tableId);
                        if (table) table.innerHTML = '';
                    });
                    loadResourcesDetails();
                    break;
                case 'military':
                    // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹
                    const militaryTables = ['military-details', 'equipment-details', 'defense-details'];
                    militaryTables.forEach(tableId => {
                        const table = document.getElementById(tableId);
                        if (table) table.innerHTML = '';
                    });
                    loadMilitaryDetails();
                    break;
                case 'buildings':
                    // æ¸…ç©ºç°æœ‰å†…å®¹
                    const buildingsContainers = ['buildings-list'];
                    buildingsContainers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) container.innerHTML = '';
                    });
                    loadBuildingsDetails();
                    break;
                case 'technology':
                    // æ¸…ç©ºç°æœ‰å†…å®¹
                    const techContainers = ['technology-list'];
                    techContainers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) container.innerHTML = '';
                    });
                    loadTechnologyDetails();
                    break;
                case 'projects':
                    // æ¸…ç©ºç°æœ‰å†…å®¹
                    const projectContainers = ['projects-list'];
                    projectContainers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) container.innerHTML = '';
                    });
                    loadProjectsDetails();
                    break;
                case 'decrees':
                    // æ¸…ç©ºç°æœ‰å†…å®¹
                    const decreeContainers = ['decrees-list'];
                    decreeContainers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) container.innerHTML = '';
                    });
                    loadDecreesDetails();
                    break;
                case 'system':
                    // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹
                    const systemTables = ['system-details', 'lord-details'];
                    systemTables.forEach(tableId => {
                        const table = document.getElementById(tableId);
                        if (table) table.innerHTML = '';
                    });
                    loadSystemDetails();
                    break;
            }
        }
        
        // åŠ è½½äººå£è¯¦æƒ…
        function loadPopulationDetails() {
            const container = document.getElementById('population-details');
            if (!container) return;
            
            const population = territoryData.äººå£ || {};
            const total = safeNumber(population.æ€»äººå£, 1250);
            const growth = safeNumber(population.äººå£å¢é•¿ç‡, 0.008);
            
            let html = `
                <tr>
                    <th>æŒ‡æ ‡</th>
                    <th>æ•°å€¼</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td>æ€»äººå£</td>
                    <td>${formatNumber(total)} äºº</td>
                    <td></td>
                </tr>
                <tr>
                    <td>äººå£å¢é•¿ç‡</td>
                    <td>${(growth * 100).toFixed(2)}%</td>
                    <td>æ¯æœˆè‡ªç„¶å¢é•¿ç‡</td>
                </tr>
            `;
            
            container.innerHTML = html;
            
            // åŠ è½½å¹´é¾„ç»“æ„
            loadAgeStructure();
            // åŠ è½½ç§æ—è¯¦æƒ…
            loadRaceDetails();
            // åŠ è½½èŒä¸šè¯¦æƒ…
            loadOccupationDetails();
            // åŠ è½½æ»¡æ„åº¦ç»´åº¦
            loadSatisfactionDimensions();
        }
        
        // åŠ è½½å¹´é¾„ç»“æ„
        function loadAgeStructure() {
            const container = document.getElementById('age-structure');
            if (!container) return;
            
            const ageStructure = territoryData.äººå£?.å¹´é¾„ç»“æ„ || {};
            const total = safeNumber(territoryData.äººå£?.æ€»äººå£, 1250);
            
            let html = `
                <tr>
                    <th>å¹´é¾„æ®µ</th>
                    <th>äººæ•°</th>
                    <th>å æ¯”</th>
                    <th>è¯´æ˜</th>
                </tr>
            `;
            
            const ageGroups = [
                { key: 'å„¿ç«¥_0-14', name: 'å„¿ç«¥ (0-14å²)', desc: 'æœªæˆå¹´äººå£' },
                { key: 'é’å¹´_15-35', name: 'é’å¹´ (15-35å²)', desc: 'ä¸»è¦åŠ³åŠ¨åŠ›' },
                { key: 'ä¸­å¹´_36-60', name: 'ä¸­å¹´ (36-60å²)', desc: 'ç»éªŒä¸°å¯Œçš„åŠ³åŠ¨åŠ›' },
                { key: 'è€å¹´_60', name: 'è€å¹´ (60å²ä»¥ä¸Š)', desc: 'è€å¹´äººå£' }
            ];
            
            ageGroups.forEach(group => {
                const count = safeNumber(ageStructure[group.key], 0);
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                
                html += `
                    <tr>
                        <td>${group.name}</td>
                        <td>${formatNumber(count)}äºº</td>
                        <td>${percentage}%</td>
                        <td>${group.desc}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // åŠ è½½ç§æ—è¯¦æƒ…
        function loadRaceDetails() {
            const container = document.getElementById('race-details');
            if (!container) return;
            
            const races = territoryData.äººå£?.ç§æ—æ„æˆ || {};
            const total = safeNumber(territoryData.äººå£?.æ€»äººå£, 1250);
            
            let html = `
                <tr>
                    <th>ç§æ—</th>
                    <th>æ•°é‡</th>
                    <th>å æ¯”</th>
                    <th>åœ°ä½</th>
                    <th>ç‰¹æ®Šèƒ½åŠ›</th>
                </tr>
            `;
            
            Object.entries(races).forEach(([name, data]) => {
                if (typeof data === 'object' && data !== null) {
                    const count = safeNumber(data.æ•°é‡, 0);
                    const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const status = safeString(data.åœ°ä½, '');
                    const ability = safeString(data.ç‰¹æ®Šèƒ½åŠ›, '');
                    
                    let statusClass = 'tag';
                    switch(status) {
                        case 'ä¸»å¯¼': statusClass += ' tag-success'; break;
                        case 'å¹³ç­‰': statusClass += ' tag-warning'; break;
                        case 'å¥´éš¶': statusClass += ' tag-danger'; break;
                        case 'å—é™åˆ¶': statusClass += ' tag-warning'; break;
                        default: statusClass += ' tag-warning';
                    }
                    
                    html += `
                        <tr>
                            <td>${name}</td>
                            <td>${formatNumber(count)}äºº</td>
                            <td>${percentage}%</td>
                            <td><span class="${statusClass}">${status}</span></td>
                            <td style="font-size: 11px;">${ability}</td>
                        </tr>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        // åŠ è½½èŒä¸šè¯¦æƒ…
        function loadOccupationDetails() {
            const container = document.getElementById('occupation-details');
            if (!container) return;
            
            const jobs = territoryData.äººå£?.èŒä¸šåˆ†å¸ƒ || {};
            const total = safeNumber(territoryData.äººå£?.æ€»äººå£, 1250);
            
            let html = `
                <tr>
                    <th>èŒä¸š</th>
                    <th>äººæ•°</th>
                    <th>å æ¯”</th>
                    <th>æœˆè´¡çŒ®</th>
                    <th>æ»¡æ„åº¦</th>
                </tr>
            `;
            
            Object.entries(jobs).forEach(([name, data]) => {
                if (typeof data === 'object' && data !== null) {
                    const count = safeNumber(data.äººæ•°, 0);
                    const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const contribution = safeNumber(data.æœˆè´¡çŒ®, 0);
                    const satisfaction = safeNumber(data.æ»¡æ„åº¦, 0);
                    
                    const contributionColor = contribution >= 0 ? '#28a745' : '#dc3545';
                    const satisfactionColor = getMoraleColor(satisfaction);
                    
                    html += `
                        <tr>
                            <td>${name}</td>
                            <td>${formatNumber(count)}äºº</td>
                            <td>${percentage}%</td>
                            <td style="color: ${contributionColor}; font-weight: bold;">
                                ${contribution >= 0 ? '+' : ''}${contribution}é‡‘å¸
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: ${satisfactionColor};">${satisfaction}/100</span>
                                    <div class="progress" style="flex: 1;">
                                        <div class="progress-bar" style="width: ${satisfaction}%"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        // åŠ è½½æ»¡æ„åº¦ç»´åº¦
        function loadSatisfactionDimensions() {
            const container = document.getElementById('satisfaction-dimensions');
            if (!container) return;
            
            const satisfaction = territoryData.äººå£?.æ»¡æ„åº¦ç»´åº¦ || {};
            
            let html = `
                <tr>
                    <th>æ»¡æ„åº¦ç»´åº¦</th>
                    <th>æ•°å€¼</th>
                    <th>çŠ¶æ€</th>
                </tr>
            `;
            
            const dimensions = [
                { key: 'é£Ÿç‰©æ»¡æ„åº¦', name: 'é£Ÿç‰©' },
                { key: 'ä½æˆ¿æ»¡æ„åº¦', name: 'ä½æˆ¿' },
                { key: 'å®‰å…¨æ»¡æ„åº¦', name: 'å®‰å…¨' },
                { key: 'å¨±ä¹æ»¡æ„åº¦', name: 'å¨±ä¹' },
                { key: 'ç¨æ”¶æ»¡æ„åº¦', name: 'ç¨æ”¶' },
                { key: 'å·¥ä½œæ»¡æ„åº¦', name: 'å·¥ä½œ' },
                { key: 'æ•™è‚²æ»¡æ„åº¦', name: 'æ•™è‚²' },
                { key: 'åŒ»ç–—æ»¡æ„åº¦', name: 'åŒ»ç–—' }
            ];
            
            dimensions.forEach(dim => {
                const value = safeNumber(satisfaction[dim.key], 0);
                const color = getMoraleColor(value);
                
                html += `
                    <tr>
                        <td>${dim.name}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${color};">${value}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${value}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>${value > 70 ? 'è‰¯å¥½' : value > 40 ? 'ä¸€èˆ¬' : 'è¾ƒå·®'}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // åŠ è½½ç»æµè¯¦æƒ…
        function loadEconomyDetails() {
            // è´¢æ”¿çŠ¶å†µ
            const financeContainer = document.getElementById('finance-details');
            if (financeContainer) {
                const finance = territoryData.ç»æµ?.è´¢æ”¿ || {};
                
                const income = safeNumber(finance.æœˆæ€»æ”¶å…¥, 544);
                const expense = safeNumber(finance.æœˆæ€»æ”¯å‡º, 135);
                const net = safeNumber(finance.æœˆå‡€æ”¶å…¥, 409);
                const treasury = safeNumber(finance.åº“å­˜é‡‘å¸, 2500);
                const balanceStatus = safeString(finance.æ”¶æ”¯çŠ¶æ€, 'ğŸ“ˆç›ˆä½™');
                
                const netColor = net >= 0 ? '#28a745' : '#dc3545';
                const balanceColor = balanceStatus.includes('ç›ˆä½™') ? '#28a745' : 
                                    balanceStatus.includes('äºæŸ') ? '#dc3545' : '#ffc107';
                
                let html = `
                    <tr>
                        <td>å›½åº“èµ„é‡‘</td>
                        <td style="font-weight: bold; color: #ffc107;">${formatCurrency(treasury)}</td>
                    </tr>
                    <tr>
                        <td>æœˆæ€»æ”¶å…¥</td>
                        <td style="color: #28a745;">${formatCurrency(income)}</td>
                    </tr>
                    <tr>
                        <td>æœˆæ€»æ”¯å‡º</td>
                        <td style="color: #dc3545;">${formatCurrency(expense)}</td>
                    </tr>
                    <tr>
                        <td>æœˆå‡€æ”¶å…¥</td>
                        <td style="color: ${netColor}; font-weight: bold;">${formatCurrency(net, true)}</td>
                    </tr>
                    <tr>
                        <td>æ”¶æ”¯çŠ¶æ€</td>
                        <td style="color: ${balanceColor};">${balanceStatus}</td>
                    </tr>
                `;
                
                financeContainer.innerHTML = html;
            }
            
            // è´¢æ”¿è¯¦ç»†æ„æˆ
            const compositionContainer = document.getElementById('finance-composition');
            if (compositionContainer) {
                const finance = territoryData.ç»æµ?.è´¢æ”¿ || {};
                
                const lordIncome = safeNumber(finance.é¢†ä¸»èµ„äº§_æœˆæ”¶å…¥, 400);
                const lordExpense = safeNumber(finance.é¢†ä¸»èµ„äº§_æœˆæ”¯å‡º, 135);
                const privateIncome = safeNumber(finance.ç§æœ‰èµ„äº§_åº”ç¨æ”¶å…¥, 960);
                const privateTaxRate = safeNumber(finance.ç§æœ‰èµ„äº§ç¨ç‡, 0.15);
                const privateTax = safeNumber(finance.ç§æœ‰èµ„äº§_ç¨æ”¶, 144);
                const special = safeNumber(finance.ç‰¹æ®Šæ”¶æ”¯, 0);
                
                let html = `
                    <tr>
                        <th>è´¢æ”¿é¡¹ç›®</th>
                        <th>æ•°å€¼</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td>é¢†ä¸»èµ„äº§æœˆæ”¶å…¥</td>
                        <td style="color: #28a745;">${formatCurrency(lordIncome)}</td>
                        <td>é¢†ä¸»æ‰€æœ‰èµ„äº§çš„æ”¶å…¥</td>
                    </tr>
                    <tr>
                        <td>é¢†ä¸»èµ„äº§æœˆæ”¯å‡º</td>
                        <td style="color: #dc3545;">${formatCurrency(lordExpense)}</td>
                        <td>é¢†ä¸»èµ„äº§çš„ç»´æŠ¤è´¹ç”¨</td>
                    </tr>
                    <tr>
                        <td>ç§æœ‰èµ„äº§åº”ç¨æ”¶å…¥</td>
                        <td>${formatCurrency(privateIncome)}</td>
                        <td>ç§æœ‰èµ„äº§äº§ç”Ÿçš„åº”ç¨æ”¶å…¥</td>
                    </tr>
                    <tr>
                        <td>ç§æœ‰èµ„äº§ç¨ç‡</td>
                        <td>${(privateTaxRate * 100).toFixed(1)}%</td>
                        <td>å¯¹ç§æœ‰èµ„äº§å¾æ”¶çš„ç¨ç‡</td>
                    </tr>
                    <tr>
                        <td>ç§æœ‰èµ„äº§ç¨æ”¶</td>
                        <td style="color: #28a745;">${formatCurrency(privateTax)}</td>
                        <td>ä»ç§æœ‰èµ„äº§å¾æ”¶çš„ç¨æ”¶</td>
                    </tr>
                    <tr>
                        <td>ç‰¹æ®Šæ”¶æ”¯</td>
                        <td style="${special >= 0 ? 'color: #28a745' : 'color: #dc3545'}">${formatCurrency(special, true)}</td>
                        <td>æ¥è‡ªæ³•ä»¤ã€äº‹ä»¶ç­‰çš„ç‰¹æ®Šæ”¶æ”¯</td>
                    </tr>
                `;
                
                compositionContainer.innerHTML = html;
            }
            
            // ç¨æ”¶è¯¦æƒ…
            const taxContainer = document.getElementById('tax-details');
            if (taxContainer) {
                const taxes = territoryData.ç»æµ?.å…¬å…±ç¨ç‡ || {};
                
                let html = '';
                Object.entries(taxes).forEach(([name, value]) => {
                    const rate = safeNumber(value, 0);
                    html += `
                        <tr>
                            <td>${name}</td>
                            <td>${(rate * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
                
                taxContainer.innerHTML = html;
            }
            
            // ç‰©ä»·æŒ‡æ•°
            const priceContainer = document.getElementById('price-index');
            if (priceContainer) {
                const prices = territoryData.ç»æµ?.ç‰©ä»·æŒ‡æ•° || {};
                
                let html = '';
                Object.entries(prices).forEach(([name, value]) => {
                    const price = safeNumber(value, 0);
                    html += `
                        <tr>
                            <td>${name}</td>
                            <td>${formatCurrency(price)}</td>
                        </tr>
                    `;
                });
                
                priceContainer.innerHTML = html;
            }
        }

        // åŠ è½½èµ„æºè¯¦æƒ…
        function loadResourcesDetails() {
            // ä»“åº“ç‰©èµ„
            const warehouseContainer = document.getElementById('warehouse-details');
            if (warehouseContainer) {
                const warehouse = territoryData.ä»“åº“ || {};
                
                let html = `
                    <tr>
                        <th>èµ„æº</th>
                        <th>å½“å‰å‚¨é‡</th>
                        <th>å®‰å…¨å‚¨é‡</th>
                        <th>çŠ¶æ€</th>
                        <th>å•ä½</th>
                    </tr>
                `;
                
                Object.entries(warehouse).forEach(([key, item]) => {
                    if (typeof item === 'object' && item !== null) {
                        const current = safeNumber(item.å½“å‰å‚¨é‡, 0);
                        const safe = safeNumber(item.å®‰å…¨å‚¨é‡, 0);
                        const unit = safeString(item.å•ä½, '');
                        const name = safeString(item.åç§°, 'æœªçŸ¥');
                        const status = current >= safe ? 'å……è¶³' : 'ä¸è¶³';
                        const statusColor = current >= safe ? '#28a745' : '#dc3545';
                        
                        html += `
                            <tr>
                                <td>${name}</td>
                                <td>${formatNumber(current)}</td>
                                <td>${formatNumber(safe)}</td>
                                <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                                <td>${unit}</td>
                            </tr>
                        `;
                    }
                });
                
                warehouseContainer.innerHTML = html;
            }
            
            // è‡ªç„¶èµ„æº - åˆ é™¤å½“å‰å‚¨é‡ã€æ¯æœˆå†ç”Ÿã€å¥åº·åº¦
            const naturalContainer = document.getElementById('natural-resources');
            if (naturalContainer) {
                const resources = territoryData.èµ„æºåŠ¨æ€ || {};
                
                let html = `
                    <tr>
                        <th>èµ„æºç±»å‹</th>
                        <th>æ¯æœˆå¼€é‡‡</th>
                        <th>å¼€é‡‡éš¾åº¦</th>
                        <th>çŸ¿çŸ³å“è´¨</th>
                        <th>é¢„ä¼°æ¯ç«­æ—¶é—´</th>
                    </tr>
                `;
                
                Object.entries(resources).forEach(([name, data]) => {
                    if (typeof data === 'object' && data !== null) {
                        const extraction = safeNumber(data.æ¯æœˆå¼€é‡‡é‡, 0);
                        const difficulty = safeNumber(data.å¼€é‡‡éš¾åº¦, 0) * 100;
                        const quality = safeNumber(data.çŸ¿çŸ³å“è´¨, 0) * 100;
                        const depletion = safeNumber(data.é¢„ä¼°æ¯ç«­æ—¶é—´, 0);
                        
                        const difficultyColor = difficulty < 30 ? '#28a745' : difficulty < 60 ? '#ffc107' : '#dc3545';
                        const qualityColor = quality > 70 ? '#28a745' : quality > 40 ? '#ffc107' : '#dc3545';
                        
                        html += `
                            <tr>
                                <td>${name}</td>
                                <td>${formatNumber(extraction)}</td>
                                <td style="color: ${difficultyColor};">${difficulty.toFixed(0)}%</td>
                                <td style="color: ${qualityColor};">${quality.toFixed(0)}%</td>
                                <td>${depletion}ä¸ªæœˆ</td>
                            </tr>
                        `;
                    }
                });
                
                naturalContainer.innerHTML = html;
            }
            
            // ç¯å¢ƒçŠ¶å†µ
            const environmentContainer = document.getElementById('environment-details');
            if (environmentContainer) {
                const environment = territoryData.ç¯å¢ƒ || {};
                const seasonEffects = environment.å­£èŠ‚å½±å“ || {};
                
                let html = `
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th>æ•°å€¼</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td>å¤©æ°”çŠ¶å†µ</td>
                        <td>${safeString(environment.å¤©æ°”çŠ¶å†µ, 'æ™´æœ—')}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>æ¸©åº¦</td>
                        <td>${safeNumber(environment.æ¸©åº¦, 15)}Â°C</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>é™æ°´</td>
                        <td>${safeString(environment.é™æ°´, 'é€‚ä¸­')}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>è‡ªç„¶ç¾å®³é£é™©</td>
                        <td>${(safeNumber(environment.è‡ªç„¶ç¾å®³é£é™©, 0.1) * 100).toFixed(1)}%</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>å†œä¸šäº§å‡ºä¿®æ­£</td>
                        <td>${safeNumber(seasonEffects.å†œä¸šäº§å‡ºä¿®æ­£, 1.2).toFixed(2)}</td>
                        <td>å­£èŠ‚å¯¹å†œä¸šçš„å½±å“</td>
                    </tr>
                    <tr>
                        <td>å•†ä¸šæ´»åŠ¨ä¿®æ­£</td>
                        <td>${safeNumber(seasonEffects.å•†ä¸šæ´»åŠ¨ä¿®æ­£, 1.0).toFixed(2)}</td>
                        <td>å­£èŠ‚å¯¹å•†ä¸šçš„å½±å“</td>
                    </tr>
                    <tr>
                        <td>å†›äº‹è¡ŒåŠ¨ä¿®æ­£</td>
                        <td>${safeNumber(seasonEffects.å†›äº‹è¡ŒåŠ¨ä¿®æ­£, 0.9).toFixed(2)}</td>
                        <td>å­£èŠ‚å¯¹å†›äº‹çš„å½±å“</td>
                    </tr>
                    <tr>
                        <td>èµ„æºé‡‡é›†ä¿®æ­£</td>
                        <td>${safeNumber(seasonEffects.èµ„æºé‡‡é›†ä¿®æ­£, 1.1).toFixed(2)}</td>
                        <td>å­£èŠ‚å¯¹é‡‡é›†çš„å½±å“</td>
                    </tr>
                `;
                
                environmentContainer.innerHTML = html;
            }
        }

        // åŠ è½½å†›äº‹è¯¦æƒ…
        function loadMilitaryDetails() {
            // å…µåŠ›çŠ¶å†µ
            const militaryContainer = document.getElementById('military-details');
            if (militaryContainer) {
                const military = territoryData.å†›äº‹ || {};
                const troops = military.å…µåŠ› || {};
                const ratings = military.æˆ˜åŠ›è¯„çº§ || {};
                
                let html = `
                    <tr>
                        <th>éƒ¨é˜Ÿç±»å‹</th>
                        <th>æ•°é‡</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                    <tr>
                        <td>å¸¸å¤‡å†›</td>
                        <td>${safeNumber(troops.å¸¸å¤‡å†›, 80)}äºº</td>
                        <td>å¸¸è§„é˜²å¾¡åŠ›é‡</td>
                    </tr>
                    <tr>
                        <td>æ°‘å…µ</td>
                        <td>${safeNumber(troops.æ°‘å…µ, 200)}äºº</td>
                        <td>åå¤‡åŠ›é‡</td>
                    </tr>
                    <tr>
                        <td>ç²¾é”éƒ¨é˜Ÿ</td>
                        <td>${safeNumber(troops.ç²¾é”éƒ¨é˜Ÿ, 0)}äºº</td>
                        <td>æ ¸å¿ƒæˆ˜åŠ›</td>
                    </tr>
                    <tr>
                        <td colspan="3" style="background: #f8f9fa; font-weight: bold;">æˆ˜åŠ›è¯„çº§</td>
                    </tr>
                    <tr>
                        <td>æ€»è¯„çº§</td>
                        <td style="font-weight: bold; color: #8B6914;">${safeString(ratings.æ€»è¯„çº§, 'D')}</td>
                        <td>ç»¼åˆæˆ˜åŠ›è¯„ä»·</td>
                    </tr>
                    <tr>
                        <td>é¢†ä¸»æˆ˜åŠ›</td>
                        <td style="font-weight: bold;">${safeString(ratings.é¢†ä¸»æˆ˜åŠ›, 'B')}</td>
                        <td>é¢†ä¸»ä¸ªäººæˆ˜åŠ›</td>
                    </tr>
                    <tr>
                        <td>å†›é˜Ÿæˆ˜åŠ›</td>
                        <td style="font-weight: bold;">${safeString(ratings.å†›é˜Ÿæˆ˜åŠ›, 'E')}</td>
                        <td>å†›é˜Ÿæ•´ä½“æˆ˜åŠ›</td>
                    </tr>
                    <tr>
                        <td>é˜²å¾¡è¯„çº§</td>
                        <td style="font-weight: bold;">${safeString(ratings.é˜²å¾¡è¯„çº§, 'D+')}</td>
                        <td>é˜²å¾¡è®¾æ–½è¯„çº§</td>
                    </tr>
                `;
                
                militaryContainer.innerHTML = html;
            }
            
            // è£…å¤‡çŠ¶æ€
            const equipmentContainer = document.getElementById('equipment-details');
            if (equipmentContainer) {
                const equipment = territoryData.å†›äº‹?.è£…å¤‡çŠ¶æ€ || {};
                
                const equipmentRate = safeNumber(equipment.è£…å¤‡å®Œæ•´ç‡, 0.65) * 100;
                const trainingLevel = safeNumber(equipment.è®­ç»ƒæ°´å¹³, 0.5) * 100;
                const morale = safeNumber(equipment.å£«æ°”, 70);
                
                const equipmentColor = equipmentRate > 70 ? '#28a745' : equipmentRate > 40 ? '#ffc107' : '#dc3545';
                const trainingColor = trainingLevel > 70 ? '#28a745' : trainingLevel > 40 ? '#ffc107' : '#dc3545';
                const moraleColor = getMoraleColor(morale);
                
                let html = `
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th>æ•°å€¼</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                    <tr>
                        <td>è£…å¤‡å®Œæ•´ç‡</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${equipmentColor};">${equipmentRate.toFixed(0)}%</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${equipmentRate}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>${equipmentRate > 70 ? 'è‰¯å¥½' : equipmentRate > 40 ? 'ä¸€èˆ¬' : 'è¾ƒå·®'}</td>
                    </tr>
                    <tr>
                        <td>è®­ç»ƒæ°´å¹³</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${trainingColor};">${trainingLevel.toFixed(0)}%</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${trainingLevel}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>${trainingLevel > 70 ? 'ç²¾é”' : trainingLevel > 40 ? 'åˆæ ¼' : 'æ–°å…µ'}</td>
                    </tr>
                    <tr>
                        <td>å†›é˜Ÿå£«æ°”</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${moraleColor};">${morale}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${morale}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>${morale > 70 ? 'é«˜æ˜‚' : morale > 40 ? 'ä¸€èˆ¬' : 'ä½è½'}</td>
                    </tr>
                `;
                
                equipmentContainer.innerHTML = html;
            }
            
            // é˜²å¾¡è®¾æ–½
            const defenseContainer = document.getElementById('defense-details');
            if (defenseContainer) {
                const defense = territoryData.å†›äº‹?.é˜²å¾¡è®¾æ–½ || {};
                
                const wallIntegrity = safeNumber(defense.åŸå¢™å®Œæ•´åº¦, 0.7) * 100;
                const towers = safeNumber(defense.ç­æœ›å¡”æ•°é‡, 2);
                const gates = safeString(defense.åŸé—¨çŠ¶æ€, 'å®Œå¥½');
                const moat = safeString(defense.æŠ¤åŸæ²³, 'æ— ');
                
                const wallColor = wallIntegrity > 80 ? '#28a745' : wallIntegrity > 50 ? '#ffc107' : '#dc3545';
                const gateColor = gates.includes('å®Œå¥½') ? '#28a745' : gates.includes('å—æŸ') ? '#ffc107' : '#dc3545';
                
                let html = `
                    <tr>
                        <th>è®¾æ–½</th>
                        <th>çŠ¶æ€</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td>åŸå¢™å®Œæ•´åº¦</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${wallColor};">${wallIntegrity.toFixed(0)}%</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${wallIntegrity}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>${wallIntegrity > 80 ? 'åšå›º' : wallIntegrity > 50 ? 'ä¸€èˆ¬' : 'éœ€è¦ç»´ä¿®'}</td>
                    </tr>
                    <tr>
                        <td>ç­æœ›å¡”æ•°é‡</td>
                        <td>${towers}åº§</td>
                        <td>${towers > 3 ? 'å……è¶³' : towers > 1 ? 'åŸºæœ¬' : 'ä¸è¶³'}</td>
                    </tr>
                    <tr>
                        <td>åŸé—¨çŠ¶æ€</td>
                        <td style="color: ${gateColor}; font-weight: bold;">${gates}</td>
                        <td>${gates.includes('å®Œå¥½') ? 'é˜²å¾¡æ­£å¸¸' : 'éœ€è¦å…³æ³¨'}</td>
                    </tr>
                    <tr>
                        <td>æŠ¤åŸæ²³</td>
                        <td>${moat}</td>
                        <td>${moat === 'æ— ' ? 'éœ€è€ƒè™‘å»ºè®¾' : 'æä¾›é¢å¤–é˜²å¾¡'}</td>
                    </tr>
                `;
                
                defenseContainer.innerHTML = html;
            }
        }

        // åŠ è½½å»ºç­‘è¯¦æƒ…
        function loadBuildingsDetails() {
            const container = document.getElementById('buildings-list');
            if (!container) return;
            
            const buildings = territoryData.å»ºç­‘ || {};
            
            let html = '';
            
            Object.entries(buildings).forEach(([key, building]) => {
                if (typeof building === 'object' && building !== null) {
                    const name = safeString(building.åç§°, 'æœªçŸ¥å»ºç­‘');
                    const type = safeString(building.ç±»å‹, 'æœªçŸ¥');
                    const property = safeString(building.äº§æƒ, 'æœªçŸ¥');
                    const level = safeNumber(building.ç­‰çº§, 1);
                    const status = safeString(building.çŠ¶æ€, 'æœªçŸ¥');
                    
                    const jobs = building.å²—ä½ || {};
                    const currentJobs = safeNumber(jobs.å½“å‰äººæ•°, 0);
                    const maxJobs = safeNumber(jobs.æœ€å¤§äººæ•°, 0);
                    const salary = safeNumber(jobs.æœˆè–ª, 0);
                    
                    const finance = building.è´¢åŠ¡ || {};
                    const income = safeNumber(finance.è®¡ç®—_æœˆæ”¶å…¥, 0);
                    const expense = safeNumber(finance.è®¡ç®—_æœˆæ”¯å‡º, 0);
                    const profit = safeNumber(finance.è®¡ç®—_å‡€æ”¶ç›Š, 0);
                    
                    const production = building.ç”Ÿäº§é…æ–¹ || {};
                    const inputs = production.æŠ•å…¥èµ„æº || {};
                    const outputs = production.äº§å‡ºèµ„æº || {};
                    const efficiency = safeNumber(production.ç”Ÿäº§æ•ˆç‡, 0) * 100;
                    
                    const upgrade = building.å‡çº§è·¯å¾„ || {};
                    const nextLevel = safeNumber(upgrade.ä¸‹ä¸€ç­‰çº§, 0);
                    const upgradeCost = safeNumber(upgrade.æ‰€éœ€é‡‘å¸, 0);
                    const upgradeMaterials = upgrade.æ‰€éœ€ææ–™ || {};
                    const upgradeTime = safeNumber(upgrade.æ‰€éœ€æ—¶é—´, 0);
                    const upgradeEffects = upgrade.å‡çº§æ•ˆæœ || {};
                    
                    const specialEffect = safeString(building.ç‰¹æ®Šæ•ˆæœ, 'æ— ');
                    
                    const propertyColor = property === 'lord' ? '#28a745' : property === 'private' ? '#ffc107' : '#6c757d';
                    const statusColor = status.includes('æ­£å¸¸') ? '#28a745' : status.includes('åœæ­¢') ? '#dc3545' : '#ffc107';
                    const profitColor = profit >= 0 ? '#28a745' : '#dc3545';
                    
                    const jobRate = maxJobs > 0 ? (currentJobs / maxJobs * 100).toFixed(0) : 0;
                    const jobColor = jobRate > 80 ? '#28a745' : jobRate > 40 ? '#ffc107' : '#dc3545';
                    
                    // ç”Ÿäº§é…æ–¹HTML
                    let productionHtml = '';
                    if (Object.keys(inputs).length > 0 || Object.keys(outputs).length > 0) {
                        productionHtml += '<div class="building-details">';
                        productionHtml += '<h4>ç”Ÿäº§é…æ–¹</h4>';
                        
                        if (Object.keys(inputs).length > 0) {
                            productionHtml += '<div style="font-size: 11px; margin-bottom: 5px;"><strong>æŠ•å…¥èµ„æº:</strong></div>';
                            Object.entries(inputs).forEach(([res, amount]) => {
                                productionHtml += `<div style="font-size: 11px; margin-left: 10px;">${res}: ${amount}/äºº/æœˆ</div>`;
                            });
                        }
                        
                        if (Object.keys(outputs).length > 0) {
                            productionHtml += '<div style="font-size: 11px; margin-bottom: 5px;"><strong>äº§å‡ºèµ„æº:</strong></div>';
                            Object.entries(outputs).forEach(([res, amount]) => {
                                productionHtml += `<div style="font-size: 11px; margin-left: 10px;">${res}: ${amount}/äºº/æœˆ</div>`;
                            });
                        }
                        
                        productionHtml += `<div style="font-size: 11px; margin-top: 5px;">ç”Ÿäº§æ•ˆç‡: ${efficiency.toFixed(0)}%</div>`;
                        productionHtml += '</div>';
                    }
                    
                    // å‡çº§è·¯å¾„HTML
                    let upgradeHtml = '';
                    if (nextLevel > 0) {
                        upgradeHtml += '<div class="building-details">';
                        upgradeHtml += `<h4>å‡çº§è·¯å¾„ (åˆ°ç­‰çº§ ${nextLevel})</h4>`;
                        upgradeHtml += `<div style="font-size: 11px;">æ‰€éœ€é‡‘å¸: ${formatCurrency(upgradeCost)}</div>`;
                        upgradeHtml += `<div style="font-size: 11px;">æ‰€éœ€æ—¶é—´: ${upgradeTime}å¤©</div>`;
                        
                        if (Object.keys(upgradeMaterials).length > 0) {
                            upgradeHtml += '<div style="font-size: 11px; margin-bottom: 5px;"><strong>æ‰€éœ€ææ–™:</strong></div>';
                            Object.entries(upgradeMaterials).forEach(([mat, amount]) => {
                                upgradeHtml += `<div style="font-size: 11px; margin-left: 10px;">${mat}: ${amount}</div>`;
                            });
                        }
                        
                        if (upgradeEffects.åŸºç¡€æ”¶å…¥å¢åŠ  || upgradeEffects.æœ€å¤§å²—ä½å¢åŠ  || upgradeEffects.ç”Ÿäº§æ•ˆç‡æå‡) {
                            upgradeHtml += '<div style="font-size: 11px; margin-top: 5px;"><strong>å‡çº§æ•ˆæœ:</strong></div>';
                            if (upgradeEffects.åŸºç¡€æ”¶å…¥å¢åŠ ) {
                                upgradeHtml += `<div style="font-size: 11px; margin-left: 10px;">åŸºç¡€æ”¶å…¥å¢åŠ : ${formatCurrency(upgradeEffects.åŸºç¡€æ”¶å…¥å¢åŠ )}</div>`;
                            }
                            if (upgradeEffects.æœ€å¤§å²—ä½å¢åŠ ) {
                                upgradeHtml += `<div style="font-size: 11px; margin-left: 10px;">æœ€å¤§å²—ä½å¢åŠ : ${upgradeEffects.æœ€å¤§å²—ä½å¢åŠ }äºº</div>`;
                            }
                            if (upgradeEffects.ç”Ÿäº§æ•ˆç‡æå‡) {
                                upgradeHtml += `<div style="font-size: 11px; margin-left: 10px;">ç”Ÿäº§æ•ˆç‡æå‡: ${(upgradeEffects.ç”Ÿäº§æ•ˆç‡æå‡ * 100).toFixed(0)}%</div>`;
                            }
                            if (upgradeEffects.æ–°åŠŸèƒ½è§£é”) {
                                upgradeHtml += `<div style="font-size: 11px; margin-left: 10px;">æ–°åŠŸèƒ½: ${upgradeEffects.æ–°åŠŸèƒ½è§£é”}</div>`;
                            }
                        }
                        
                        upgradeHtml += '</div>';
                    }
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #8B6914; border-radius: 5px; background: rgba(255, 255, 255, 0.8);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <span style="font-weight: bold; font-size: 14px;">${name}</span>
                                    <span style="font-size: 12px; margin-left: 8px;">
                                        <span class="tag" style="background: ${propertyColor}; color: white; padding: 2px 6px; border-radius: 10px;">
                                            ${property === 'lord' ? 'é¢†ä¸»æ‰€æœ‰' : 'ç§äººæ‰€æœ‰'}
                                        </span>
                                        <span class="tag" style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">
                                            ${status}
                                        </span>
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: #4A3728;">
                                    ç­‰çº§: ${level} | ç±»å‹: ${type}
                                </div>
                            </div>
                            
                            <table style="width: 100%; font-size: 12px;">
                                <tr>
                                    <td style="width: 33%; padding: 5px;">
                                        <div style="font-weight: bold; margin-bottom: 3px;">å²—ä½æƒ…å†µ</div>
                                        <div>
                                            å°±ä¸š: ${currentJobs}/${maxJobs}äºº
                                            <div class="progress" style="margin-top: 2px;">
                                                <div class="progress-bar" style="width: ${jobRate}%; background: ${jobColor};"></div>
                                            </div>
                                            <div style="font-size: 11px; color: #6c757d;">å¹³å‡æœˆè–ª: ${salary}é‡‘å¸</div>
                                        </div>
                                    </td>
                                    <td style="width: 33%; padding: 5px; border-left: 1px solid #eee;">
                                        <div style="font-weight: bold; margin-bottom: 3px;">è´¢åŠ¡çŠ¶å†µ</div>
                                        <div>
                                            <div>æ”¶å…¥: <span style="color: #28a745;">${formatCurrency(income)}</span></div>
                                            <div>æ”¯å‡º: <span style="color: #dc3545;">${formatCurrency(expense)}</span></div>
                                            <div>å‡€åˆ©: <span style="color: ${profitColor}; font-weight: bold;">${formatCurrency(profit, true)}</span></div>
                                        </div>
                                    </td>
                                    <td style="width: 34%; padding: 5px; border-left: 1px solid #eee;">
                                        <div style="font-weight: bold; margin-bottom: 3px;">è¿è¥çŠ¶æ€</div>
                                        <div style="font-size: 11px;">
                                            <div>é›‡ä½£ç‡: ${jobRate}%</div>
                                            <div>ç›ˆåˆ©èƒ½åŠ›: ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'}</div>
                                            <div>äººå‡äº§å€¼: ${currentJobs > 0 ? formatCurrency(income / currentJobs) : 'N/A'}</div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                            
                            ${productionHtml}
                            ${upgradeHtml}
                            
                            <div style="font-size: 11px; margin-top: 10px; color: #4A3728; font-style: italic;">
                                <strong>ç‰¹æ®Šæ•ˆæœ:</strong> ${specialEffect}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— å»ºç­‘æ•°æ®</div>';
            }
            
            container.innerHTML = html;
        }

        // åŠ è½½ç§‘æŠ€è¯¦æƒ…
        function loadTechnologyDetails() {
            const container = document.getElementById('technology-list');
            if (!container) return;
            
            const techs = territoryData.ç§‘æŠ€ || {};
            
            let html = '';
            
            Object.entries(techs).forEach(([key, tech]) => {
                if (typeof tech === 'object' && tech !== null) {
                    const name = safeString(tech.åç§°, 'æœªçŸ¥ç§‘æŠ€');
                    const category = safeString(tech.ç±»åˆ«, 'æœªçŸ¥');
                    const status = safeString(tech.ç ”å‘çŠ¶æ€, 'æœªç ”å‘');
                    const progress = safeNumber(tech.å½“å‰è¿›åº¦, 0);
                    const description = safeString(tech.æ•ˆæœæè¿°, '');
                    
                    const cost = tech.ç ”å‘æˆæœ¬ || {};
                    const costGold = safeNumber(cost.é‡‘å¸, 0);
                    const costTime = safeNumber(cost.æ—¶é—´, 0);
                    const costPersonnel = safeNumber(cost.äººå‘˜, 0);
                    
                    const effects = tech.å…·ä½“æ•ˆæœ || {};
                    const economicEffects = effects.ç»æµæ•ˆæœ || {};
                    const militaryEffects = effects.å†›äº‹æ•ˆæœ || {};
                    const socialEffects = effects.ç¤¾ä¼šæ•ˆæœ || {};
                    
                    let statusColor, statusText;
                    switch(status) {
                        case 'å·²ç ”å‘':
                            statusColor = '#28a745';
                            statusText = 'å·²å®Œæˆ';
                            break;
                        case 'ç ”å‘ä¸­':
                            statusColor = '#ffc107';
                            statusText = 'è¿›è¡Œä¸­';
                            break;
                        default:
                            statusColor = '#6c757d';
                            statusText = 'æœªå¼€å§‹';
                    }
                    
                    html += `
                        <div class="tech-card">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <span style="font-weight: bold; font-size: 13px;">${name}</span>
                                    <span style="font-size: 11px; margin-left: 8px; color: #4A3728;">
                                        ç±»åˆ«: ${category}
                                    </span>
                                </div>
                                <span class="tag" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    ${statusText}
                                </span>
                            </div>
                            
                            <div style="margin-top: 5px;">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px;">
                                    <span>ç ”å‘è¿›åº¦</span>
                                    <span>${progress}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${progress}%; background: ${statusColor};"></div>
                                </div>
                            </div>
                            
                            <div style="font-size: 11px; margin-top: 10px; color: #4A3728;">
                                <strong>æ•ˆæœæè¿°:</strong> ${description}
                            </div>
                            
                            <div style="font-size: 11px; margin-top: 10px;">
                                <strong>ç ”å‘æˆæœ¬:</strong> ${formatCurrency(costGold)} | ${costTime}å¤© | ${costPersonnel}äºº
                            </div>
                            
                            <div class="building-details" style="margin-top: 10px;">
                                <h4>å…·ä½“æ•ˆæœ</h4>
                                ${economicEffects.æ”¶å…¥åŠ æˆ || economicEffects.æ•ˆç‡æå‡ || economicEffects.æˆæœ¬é™ä½ ? `
                                <div style="font-size: 11px; margin-bottom: 5px;"><strong>ç»æµæ•ˆæœ:</strong></div>
                                <div style="font-size: 11px; margin-left: 10px;">
                                    ${economicEffects.æ”¶å…¥åŠ æˆ ? `æ”¶å…¥åŠ æˆ: ${(economicEffects.æ”¶å…¥åŠ æˆ * 100).toFixed(0)}%<br>` : ''}
                                    ${economicEffects.æ•ˆç‡æå‡ ? `æ•ˆç‡æå‡: ${(economicEffects.æ•ˆç‡æå‡ * 100).toFixed(0)}%<br>` : ''}
                                    ${economicEffects.æˆæœ¬é™ä½ ? `æˆæœ¬é™ä½: ${(economicEffects.æˆæœ¬é™ä½ * 100).toFixed(0)}%` : ''}
                                </div>
                                ` : ''}
                                
                                ${militaryEffects.æˆ˜åŠ›æå‡ || militaryEffects.è®­ç»ƒæ•ˆç‡ || militaryEffects.è£…å¤‡è´¨é‡ ? `
                                <div style="font-size: 11px; margin-top: 5px;"><strong>å†›äº‹æ•ˆæœ:</strong></div>
                                <div style="font-size: 11px; margin-left: 10px;">
                                    ${militaryEffects.æˆ˜åŠ›æå‡ ? `æˆ˜åŠ›æå‡: ${(militaryEffects.æˆ˜åŠ›æå‡ * 100).toFixed(0)}%<br>` : ''}
                                    ${militaryEffects.è®­ç»ƒæ•ˆç‡ ? `è®­ç»ƒæ•ˆç‡: ${(militaryEffects.è®­ç»ƒæ•ˆç‡ * 100).toFixed(0)}%<br>` : ''}
                                    ${militaryEffects.è£…å¤‡è´¨é‡ ? `è£…å¤‡è´¨é‡: ${(militaryEffects.è£…å¤‡è´¨é‡ * 100).toFixed(0)}%` : ''}
                                </div>
                                ` : ''}
                                
                                ${socialEffects.æ°‘å¿ƒå½±å“ || socialEffects.æ²»å®‰å½±å“ || socialEffects.äººå£å½±å“ ? `
                                <div style="font-size: 11px; margin-top: 5px;"><strong>ç¤¾ä¼šæ•ˆæœ:</strong></div>
                                <div style="font-size: 11px; margin-left: 10px;">
                                    ${socialEffects.æ°‘å¿ƒå½±å“ ? `æ°‘å¿ƒå½±å“: ${socialEffects.æ°‘å¿ƒå½±å“}<br>` : ''}
                                    ${socialEffects.æ²»å®‰å½±å“ ? `æ²»å®‰å½±å“: ${socialEffects.æ²»å®‰å½±å“}<br>` : ''}
                                    ${socialEffects.äººå£å½±å“ ? `äººå£å½±å“: ${(socialEffects.äººå£å½±å“ * 100).toFixed(2)}%` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— ç§‘æŠ€æ•°æ®</div>';
            }
            
            container.innerHTML = html;
        }

        // åŠ è½½é¡¹ç›®è¯¦æƒ…
        function loadProjectsDetails() {
            const container = document.getElementById('projects-list');
            if (!container) return;
            
            const projects = territoryData.é¡¹ç›® || {};
            
            const projectName = safeString(projects.å½“å‰å»ºè®¾é¡¹ç›®, 'æ— ');
            const progress = safeNumber(projects.é¡¹ç›®è¿›åº¦, 0);
            const resources = projects.é¡¹ç›®æ‰€éœ€èµ„æº || {};
            
            let html = '';
            
            if (projectName !== 'æ— ') {
                html += `
                    <div class="project-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <span style="font-weight: bold; font-size: 13px;">${projectName}</span>
                            </div>
                            <span class="tag" style="background: #ffc107; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                è¿›è¡Œä¸­
                            </span>
                        </div>
                        
                        <div style="margin-top: 5px;">
                            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px;">
                                <span>é¡¹ç›®è¿›åº¦</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${progress}%; background: #ffc107;"></div>
                            </div>
                        </div>
                        
                        <div class="building-details" style="margin-top: 10px;">
                            <h4>æ‰€éœ€èµ„æº</h4>
                            <div style="font-size: 11px;">
                                ${resources.é‡‘å¸ ? `<div>é‡‘å¸: ${formatCurrency(resources.é‡‘å¸)}</div>` : ''}
                                ${resources.æœ¨æ ? `<div>æœ¨æ: ${resources.æœ¨æ}æ–¹</div>` : ''}
                                ${resources.çŸ³æ ? `<div>çŸ³æ: ${resources.çŸ³æ}æ–¹</div>` : ''}
                                ${resources.é“çŸ¿ ? `<div>é“çŸ¿: ${resources.é“çŸ¿}æ–¤</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html = '<div style="text-align: center; padding: 20px; color: #6c757d;">å½“å‰æ— å»ºè®¾é¡¹ç›®</div>';
            }
            
            container.innerHTML = html;
        }

        // åŠ è½½æ³•ä»¤è¯¦æƒ…
        function loadDecreesDetails() {
            const container = document.getElementById('decrees-list');
            if (!container) return;
            
            const decrees = territoryData.æ³•ä»¤ || {};
            
            let html = '';
            
            Object.entries(decrees).forEach(([key, decree]) => {
                if (typeof decree === 'object' && decree !== null) {
                    const name = safeString(decree.åç§°, 'æœªçŸ¥æ³•ä»¤');
                    const status = safeBoolean(decree.ç”Ÿæ•ˆçŠ¶æ€, false);
                    const effectiveTime = safeString(decree.ç”Ÿæ•ˆæ—¶é—´, '');
                    const expiration = safeString(decree.å¤±æ•ˆæ¡ä»¶, '');
                    
                    const economicEffects = decree.ç»æµæ•ˆæœ || {};
                    const socialEffects = decree.ç¤¾ä¼šæ•ˆæœ || {};
                    
                    const statusColor = status ? '#28a745' : '#dc3545';
                    const statusText = status ? 'ç”Ÿæ•ˆä¸­' : 'å·²å¤±æ•ˆ';
                    
                    html += `
                        <div class="decree-card">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <span style="font-weight: bold; font-size: 13px;">${name}</span>
                                </div>
                                <span class="tag" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    ${statusText}
                                </span>
                            </div>
                            
                            <div style="font-size: 11px; color: #4A3728; margin-bottom: 5px;">
                                <strong>ç”Ÿæ•ˆæ—¶é—´:</strong> ${effectiveTime}
                            </div>
                            
                            <div style="font-size: 11px; color: #4A3728; margin-bottom: 10px;">
                                <strong>å¤±æ•ˆæ¡ä»¶:</strong> ${expiration}
                            </div>
                            
                            <div class="building-details">
                                <h4>æ³•ä»¤æ•ˆæœ</h4>
                                ${economicEffects.ç¨ç‡ä¿®æ­£ || economicEffects.ä¸“é¡¹ç¨ç‡ || economicEffects.å›ºå®šæ”¶å…¥ || economicEffects.å›ºå®šæ”¯å‡º || economicEffects.æ•ˆç‡åŠ æˆ ? `
                                <div style="font-size: 11px; margin-bottom: 5px;"><strong>ç»æµæ•ˆæœ:</strong></div>
                                <div style="font-size: 11px; margin-left: 10px;">
                                    ${economicEffects.ç¨ç‡ä¿®æ­£ ? `ç¨ç‡ä¿®æ­£: ${economicEffects.ç¨ç‡ä¿®æ­£ > 0 ? '+' : ''}${(economicEffects.ç¨ç‡ä¿®æ­£ * 100).toFixed(1)}%<br>` : ''}
                                    ${economicEffects.ä¸“é¡¹ç¨ç‡ ? `ä¸“é¡¹ç¨ç‡: ${(economicEffects.ä¸“é¡¹ç¨ç‡ * 100).toFixed(1)}%<br>` : ''}
                                    ${economicEffects.å›ºå®šæ”¶å…¥ ? `å›ºå®šæ”¶å…¥: ${formatCurrency(economicEffects.å›ºå®šæ”¶å…¥)}<br>` : ''}
                                    ${economicEffects.å›ºå®šæ”¯å‡º ? `å›ºå®šæ”¯å‡º: ${formatCurrency(economicEffects.å›ºå®šæ”¯å‡º)}<br>` : ''}
                                    ${economicEffects.æ•ˆç‡åŠ æˆ ? `æ•ˆç‡åŠ æˆ: ${(economicEffects.æ•ˆç‡åŠ æˆ * 100).toFixed(1)}%` : ''}
                                </div>
                                ` : 'æ— ç»æµæ•ˆæœ'}
                                
                                ${socialEffects.æ°‘å¿ƒå½±å“ || socialEffects.æ²»å®‰å½±å“ || socialEffects.äººå£å½±å“ ? `
                                <div style="font-size: 11px; margin-top: 5px;"><strong>ç¤¾ä¼šæ•ˆæœ:</strong></div>
                                <div style="font-size: 11px; margin-left: 10px;">
                                    ${socialEffects.æ°‘å¿ƒå½±å“ ? `æ°‘å¿ƒå½±å“: ${socialEffects.æ°‘å¿ƒå½±å“ > 0 ? '+' : ''}${socialEffects.æ°‘å¿ƒå½±å“}<br>` : ''}
                                    ${socialEffects.æ²»å®‰å½±å“ ? `æ²»å®‰å½±å“: ${socialEffects.æ²»å®‰å½±å“ > 0 ? '+' : ''}${socialEffects.æ²»å®‰å½±å“}<br>` : ''}
                                    ${socialEffects.äººå£å½±å“ ? `äººå£å½±å“: ${socialEffects.äººå£å½±å“ > 0 ? '+' : ''}${(socialEffects.äººå£å½±å“ * 100).toFixed(2)}%` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<div style="text-align: center; padding: 20px; color: #6c757d;">æš‚æ— æ³•ä»¤æ•°æ®</div>';
            }
            
            container.innerHTML = html;
        }

        // åŠ è½½ç³»ç»Ÿè¯¦æƒ…
        function loadSystemDetails() {
            // ç³»ç»Ÿè®¾ç½®
            const systemContainer = document.getElementById('system-details');
            if (systemContainer) {
                const system = territoryData.System || {};
                
                let html = `
                    <tr>
                        <th>è®¾ç½®é¡¹</th>
                        <th>å€¼</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td>å½“å‰æ¸¸æˆæ—¶é—´</td>
                        <td>${safeString(system.å½“å‰æ¸¸æˆæ—¶é—´, 'ç¬¬1å¹´ 1æœˆ')}</td>
                        <td>æ¸¸æˆå†…æ—¶é—´</td>
                    </tr>
                    <tr>
                        <td>å½“å‰å­£èŠ‚</td>
                        <td>${safeString(system.å½“å‰å­£èŠ‚, 'æ˜¥å­£')}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>ä¸Šæ¬¡ç»“ç®—æ—¶é—´</td>
                        <td>${safeString(system.ä¸Šæ¬¡ç»“ç®—æ—¶é—´, 'ç¬¬1å¹´ 1æœˆ')}</td>
                        <td>æœ€åä¸€æ¬¡æœˆåº¦ç»“ç®—</td>
                    </tr>
                    <tr>
                        <td>è‡ªåŠ¨ç»“ç®—å¼€å…³</td>
                        <td>${system.è‡ªåŠ¨ç»“ç®—å¼€å…³ ? 'å¼€å¯' : 'å…³é—­'}</td>
                        <td>è‡ªåŠ¨æ‰§è¡Œæœˆåº¦ç»“ç®—</td>
                    </tr>
                    <tr>
                        <td>æ•°æ®æ›´æ–°</td>
                        <td>${lastUpdate ? lastUpdate.toLocaleString() : 'ä»æœª'}</td>
                        <td>æœ€åä¸€æ¬¡æ•°æ®æ›´æ–°</td>
                    </tr>
                    <tr>
                        <td>è‡ªåŠ¨åˆ·æ–°</td>
                        <td>${autoRefreshEnabled ? 'å¼€å¯' : 'å…³é—­'}</td>
                        <td>è‡ªåŠ¨åˆ·æ–°æ•°æ®</td>
                    </tr>
                `;
                
                systemContainer.innerHTML = html;
            }
            
            // é¢†ä¸»ä¿¡æ¯
            const lordContainer = document.getElementById('lord-details');
            if (lordContainer) {
                const character = territoryData.Character?.é¢†ä¸» || {};
                
                const lordName = safeString(character.å§“å, 'è‰¾ä¸¹');
                const title = safeString(character.ç§°å·, 'è¾¹å¢ƒå®ˆæŠ¤è€…');
                const health = safeString(character.å¥åº·çŠ¶æ€, 'è‰¯å¥½');
                const combat = safeString(character.ä¸ªäººæˆ˜åŠ›, 'B');
                const management = safeNumber(character.ç®¡ç†èƒ½åŠ›, 65);
                const military = safeNumber(character.å†›äº‹èƒ½åŠ›, 70);
                const diplomacy = safeNumber(character.å¤–äº¤èƒ½åŠ›, 55);
                const knowledge = safeNumber(character.çŸ¥è¯†æ°´å¹³, 60);
                
                let html = `
                    <tr>
                        <th>å±æ€§</th>
                        <th>æ•°å€¼</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td>å§“å</td>
                        <td style="font-weight: bold;">${lordName}</td>
                        <td>${title}</td>
                    </tr>
                    <tr>
                        <td>å¥åº·çŠ¶æ€</td>
                        <td>${health}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>ä¸ªäººæˆ˜åŠ›</td>
                        <td style="font-weight: bold; color: #8B6914;">${combat}</td>
                        <td>ä¸ªäººæˆ˜æ–—èƒ½åŠ›è¯„çº§</td>
                    </tr>
                    <tr>
                        <td>ç®¡ç†èƒ½åŠ›</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${management}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${management}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>é¢†åœ°ç®¡ç†èƒ½åŠ›</td>
                    </tr>
                    <tr>
                        <td>å†›äº‹èƒ½åŠ›</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${military}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${military}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>å†›äº‹æŒ‡æŒ¥èƒ½åŠ›</td>
                    </tr>
                    <tr>
                        <td>å¤–äº¤èƒ½åŠ›</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${diplomacy}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${diplomacy}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>å¤–äº¤è°ˆåˆ¤èƒ½åŠ›</td>
                    </tr>
                    <tr>
                        <td>çŸ¥è¯†æ°´å¹³</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${knowledge}/100</span>
                                <div class="progress" style="flex: 1;">
                                    <div class="progress-bar" style="width: ${knowledge}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>æ–‡åŒ–çŸ¥è¯†æ°´å¹³</td>
                    </tr>
                `;
                
                lordContainer.innerHTML = html;
            }
        }
        
        // åˆ·æ–°æ•°æ® - ä¿®å¤ç‰ˆ
        async function refreshData() {
            try {
                showLoading(true);
                console.log('å¼€å§‹å¼ºåˆ¶åˆ·æ–°æ•°æ®...');
                
                // æ¸…é™¤ç°æœ‰æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°è·å–
                territoryData = null;
                localStorage.removeItem('territoryData');
                
                await fetchFromMVU();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();
                
                console.log('æ•°æ®åˆ·æ–°å®Œæˆ');
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                alert('åˆ·æ–°æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // æœˆåº¦ç»“ç®—
        async function monthlySettlement() {
            if (confirm('ç¡®å®šè¦æ‰§è¡Œæœˆåº¦ç»“ç®—å—ï¼Ÿè¿™å°†æ›´æ–°æ‰€æœ‰ç»æµæ•°æ®ã€‚')) {
                try {
                    showLoading(true);
                    
                    // æ£€æŸ¥MVUå‡½æ•°æ˜¯å¦å­˜åœ¨
                    if (typeof executeMvuCode === 'function') {
                        await executeMvuCode('Territory.monthlySettlement()');
                        console.log('æœˆåº¦ç»“ç®—æ‰§è¡ŒæˆåŠŸ');
                    } else if (typeof window.executeMvuCode === 'function') {
                        await window.executeMvuCode('Territory.monthlySettlement()');
                        console.log('æœˆåº¦ç»“ç®—æ‰§è¡ŒæˆåŠŸï¼ˆé€šè¿‡windowï¼‰');
                    } else {
                        console.log('æ¨¡æ‹Ÿæ‰§è¡Œæœˆåº¦ç»“ç®—');
                        // æ¨¡æ‹Ÿæ•°æ®å˜åŒ–
                        if (territoryData) {
                            // æ›´æ–°å›½åº“
                            const netIncome = safeNumber(territoryData.ç»æµ?.è´¢æ”¿?.æœˆå‡€æ”¶å…¥, 0);
                            territoryData.ç»æµ.è´¢æ”¿.åº“å­˜é‡‘å¸ = safeNumber(territoryData.ç»æµ.è´¢æ”¿.åº“å­˜é‡‘å¸, 0) + netIncome;
                            
                            // æ›´æ–°äººå£
                            const growthRate = safeNumber(territoryData.äººå£?.äººå£å¢é•¿ç‡, 0);
                            territoryData.äººå£.æ€»äººå£ = Math.floor(safeNumber(territoryData.äººå£.æ€»äººå£, 0) * (1 + growthRate));
                            
                            // æ›´æ–°æ¸¸æˆæ—¶é—´
                            const system = territoryData.System || {};
                            const timeMatch = (system.å½“å‰æ¸¸æˆæ—¶é—´ || 'ç¬¬1å¹´ 1æœˆ').match(/ç¬¬(\d+)å¹´ (\d+)æœˆ/);
                            if (timeMatch) {
                                let year = parseInt(timeMatch[1]);
                                let month = parseInt(timeMatch[2]) + 1;
                                if (month > 12) {
                                    month = 1;
                                    year++;
                                }
                                system.å½“å‰æ¸¸æˆæ—¶é—´ = `ç¬¬${year}å¹´ ${month}æœˆ`;
                                
                                // æ›´æ–°å­£èŠ‚
                                const seasons = ['æ˜¥å­£', 'å¤å­£', 'ç§‹å­£', 'å†¬å­£'];
                                const seasonIndex = Math.floor((month - 1) / 3) % 4;
                                system.å½“å‰å­£èŠ‚ = seasons[seasonIndex];
                            }
                            
                            lastUpdate = new Date();
                            document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
                            
                            // ä¿å­˜æ›´æ–°åçš„æ•°æ®
                            localStorage.setItem('territoryData', JSON.stringify(territoryData));
                            updateUI();
                        }
                    }
                    
                    alert('æœˆåº¦ç»“ç®—å®Œæˆï¼');
                } catch (error) {
                    console.error('æœˆåº¦ç»“ç®—å¤±è´¥:', error);
                    alert('æœˆåº¦ç»“ç®—å¤±è´¥: ' + error.message);
                } finally {
                    showLoading(false);
                }
            }
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('auto-refresh-btn');
            
            if (autoRefreshEnabled) {
                btn.innerHTML = 'â¸ï¸ æš‚åœåˆ·æ–°';
                btn.style.background = '#28a745';
                autoRefreshInterval = setInterval(refreshData, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
                console.log('è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨');
            } else {
                btn.innerHTML = 'â–¶ï¸ è‡ªåŠ¨åˆ·æ–°';
                btn.style.background = '#8B6914';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!territoryData) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const dataStr = JSON.stringify(territoryData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `é¢†åœ°æ•°æ®_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶');
        }
        
        // æ¸…é™¤æœ¬åœ°æ•°æ®
        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ•°æ®å—ï¼Ÿè¿™ä¸ä¼šå½±å“MVUç³»ç»Ÿä¸­çš„æ•°æ®ã€‚')) {
                localStorage.removeItem('territoryData');
                territoryData = null;
                alert('æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°è·å–æ•°æ®');
            }
        }
        
        // æ˜¾ç¤ºè°ƒè¯•é¢æ¿
        function showDebugPanel() {
            debugMode = !debugMode;
            const debugSection = document.getElementById('debug-section');
            const debugInfo = document.getElementById('debug-info');
            
            if (debugMode) {
                debugSection.style.display = 'block';
                
                let debugHtml = '<div class="debug-panel">';
                
                // æ˜¾ç¤ºå½“å‰æ•°æ®çŠ¶æ€
                debugHtml += '<div class="debug-item"><span class="debug-key">æ•°æ®çŠ¶æ€:</span> <span class="debug-value">' + (territoryData ? 'å·²åŠ è½½' : 'æœªåŠ è½½') + '</span></div>';
                
                if (territoryData) {
                    // æ˜¾ç¤ºå…³é”®æ•°æ®
                    debugHtml += '<div class="debug-item"><span class="debug-key">äººå£:</span> <span class="debug-value">' + (territoryData.äººå£?.æ€»äººå£ || 'N/A') + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">å›½åº“:</span> <span class="debug-value">' + (territoryData.ç»æµ?.è´¢æ”¿?.åº“å­˜é‡‘å¸ || 'N/A') + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">äººç±»æ•°é‡:</span> <span class="debug-value">' + (territoryData.äººå£?.ç§æ—æ„æˆ?.äººç±»?.æ•°é‡ || 'N/A') + '</span></div>';
                    debugHtml += '<div class="debug-item"><span class="debug-key">æœ€åæ›´æ–°:</span> <span class="debug-value">' + (lastUpdate ? lastUpdate.toLocaleTimeString() : 'N/A') + '</span></div>';
                    
                    // æ˜¾ç¤ºæ•°æ®æ¥æº
                    debugHtml += '<div class="debug-item"><span class="debug-key">æ•°æ®æº:</span> <span class="debug-value">' + (localStorage.getItem('territoryData') ? 'localStorage + MVU' : 'MVU') + '</span></div>';
                }
                
                // æ˜¾ç¤ºAPIå¯ç”¨æ€§
                debugHtml += '<div class="debug-item"><span class="debug-key">getVariables:</span> <span class="debug-value">' + (typeof getVariables) + '</span></div>';
                debugHtml += '<div class="debug-item"><span class="debug-key">window.getVariables:</span> <span class="debug-value">' + (typeof window.getVariables) + '</span></div>';
                debugHtml += '<div class="debug-item"><span class="debug-key">getCurrentMessageId:</span> <span class="debug-value">' + (typeof getCurrentMessageId) + '</span></div>';
                debugHtml += '<div class="debug-item"><span class="debug-key">lodash (_):</span> <span class="debug-value">' + (typeof _) + '</span></div>';
                
                debugHtml += '</div>';
                
                debugInfo.innerHTML = debugHtml;
            } else {
                debugSection.style.display = 'none';
            }
            
            adjustIframeHeight();
        }
        
        // è°ƒæ•´iframeé«˜åº¦
        function adjustIframeHeight() {
            setTimeout(() => {
                const height = document.documentElement.scrollHeight;
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({
                        type: 'resize_iframe',
                        height: height + 'px'
                    }, '*');
                }
            }, 100);
        }
        
        // å·¥å…·å‡½æ•°
        function formatNumber(num) {
            const number = safeNumber(num, 0);
            return number.toLocaleString();
        }
        
        function formatCurrency(amount, showSign = false) {
            const num = safeNumber(amount, 0);
            let formatted = num.toLocaleString() + ' é‡‘å¸';
            if (showSign) {
                formatted = (num >= 0 ? '+' : '') + formatted;
            }
            return formatted;
        }
        
        function getThreatColor(threat) {
            if (!threat) return '#6c757d';
            switch(threat) {
                case 'å®‰å…¨': return '#28a745';
                case 'è­¦æˆ’': return '#ffc107';
                case 'å±é™©': return '#dc3545';
                case 'æå±é™©': return '#721c24';
                default: return '#6c757d';
            }
        }
        
        function getMoraleColor(morale) {
            const num = safeNumber(morale, 0);
            if (num > 70) return '#28a745';
            if (num > 40) return '#ffc107';
            return '#dc3545';
        }
        
        function safeBoolean(value, defaultValue = false) {
            if (value === undefined || value === null) {
                return defaultValue;
            }
            return Boolean(value);
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('é¢†åœ°çŠ¶æ€é¢æ¿åˆå§‹åŒ–...');
            
            // åŠ è½½æ•°æ®
            fetchFromMVU();
            
            // è°ƒæ•´iframeé«˜åº¦
            setTimeout(adjustIframeHeight, 200);
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', adjustIframeHeight);
            
            console.log('é¢†åœ°çŠ¶æ€é¢æ¿å·²å°±ç»ª');
        });
    </script>
</body>
</html>
