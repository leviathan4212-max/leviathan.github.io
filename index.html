<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>é¢†åœ°çŠ¶æ€</title>
    <style>
        /* é‡ç½®SillyTavernå¯èƒ½å½±å“æˆ‘ä»¬çš„æ ·å¼ */
        .territory-panel * {
            box-sizing: border-box !important;
            margin: 0 !important;
            padding: 0 !important;
            font-family: inherit !important;
            line-height: normal !important;
        }
        
        .territory-panel {
            width: 100% !important;
            max-width: none !important;
            min-height: 500px !important;
            height: auto !important;
            overflow: visible !important;
            margin: 10px auto 20px auto !important;
            padding: 15px !important;
            background: #F5E6C8 !important;
            border: 3px solid #8B6914 !important;
            border-radius: 10px !important;
            position: relative !important;
            display: block !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif !important;
        }
        
        /* ç¡®ä¿é¢æ¿å±•å¼€æ—¶é«˜åº¦è‡ªé€‚åº” */
        .territory-panel[open] {
            min-height: 800px !important;
            height: auto !important;
        }
        
        .panel-header {
            width: 100% !important;
            padding: 12px 15px !important;
            background: linear-gradient(to right, #3D2820, #2C1810) !important;
            color: #C9A227 !important;
            font-weight: bold !important;
            font-size: 1.1em !important;
            text-align: center !important;
            border-bottom: 2px solid #8B7314 !important;
            cursor: pointer !important;
            user-select: none !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        
        .panel-title {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
        }
        
        .panel-icon {
            font-size: 1.2em !important;
        }
        
        .territory-name {
            color: #E8C547 !important;
            font-weight: 700 !important;
        }
        
        .toggle-arrow {
            transition: transform 0.3s !important;
            font-size: 0.9em !important;
        }
        
        .panel-body {
            width: 100% !important;
            padding: 15px 10px !important;
            display: block !important;
            min-height: 400px !important;
            height: auto !important;
            overflow: visible !important;
        }
        
        /* æŠ˜å åŒºå—æ ·å¼ */
        .collapse-section {
            margin-bottom: 12px !important;
            border: 2px solid #8B6914 !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            background: rgba(255, 255, 255, 0.9) !important;
        }
        
        .section-header {
            padding: 10px 12px !important;
            background: linear-gradient(135deg, #E8D4A8, #D4C4A0) !important;
            color: #4A3728 !important;
            font-weight: 600 !important;
            font-size: 0.95em !important;
            cursor: pointer !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            border-bottom: 1px solid transparent !important;
        }
        
        .section-title {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        
        .section-icon {
            font-size: 1.1em !important;
        }
        
        .section-arrow {
            font-size: 0.8em !important;
            transition: transform 0.3s !important;
        }
        
        .section-content {
            padding: 12px !important;
            background: rgba(255, 255, 255, 0.7) !important;
            max-height: none !important;
            height: auto !important;
            overflow: visible !important;
            display: none !important;
        }
        
        .section-content.expanded {
            display: block !important;
            animation: fadeIn 0.3s !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* æ•°æ®è¡Œæ ·å¼ */
        .data-row {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 6px 0 !important;
            border-bottom: 1px dashed rgba(139, 105, 20, 0.3) !important;
            min-height: 24px !important;
        }
        
        .data-row:last-child {
            border-bottom: none !important;
        }
        
        .data-label {
            font-weight: 600 !important;
            color: #4A3728 !important;
            font-size: 0.9em !important;
            min-width: 120px !important;
            flex-shrink: 0 !important;
        }
        
        .data-value {
            color: #2C1810 !important;
            font-weight: 500 !important;
            text-align: right !important;
            word-break: break-word !important;
            flex: 1 !important;
            margin-left: 10px !important;
        }
        
        .value-positive { color: #3A6B35 !important; font-weight: 700 !important; }
        .value-negative { color: #8B3A3A !important; font-weight: 700 !important; }
        .value-gold { color: #8B7314 !important; font-weight: 700 !important; }
        .value-blue { color: #3A4A6B !important; }
        .value-purple { color: #5A3A6B !important; }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-2 {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 10px !important;
            margin: 10px 0 !important;
        }
        
        .grid-3 {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 8px !important;
            margin: 10px 0 !important;
        }
        
        .grid-item {
            background: rgba(255, 255, 255, 0.8) !important;
            border: 1px solid rgba(139, 105, 20, 0.3) !important;
            border-radius: 6px !important;
            padding: 8px !important;
            text-align: center !important;
        }
        
        /* ç§æ—å¡ç‰‡ */
        .race-card {
            background: linear-gradient(135deg, rgba(232, 212, 168, 0.3), rgba(212, 196, 160, 0.2)) !important;
            border: 1px solid #8B6914 !important;
            border-radius: 6px !important;
            padding: 8px !important;
            margin-bottom: 8px !important;
        }
        
        .race-name {
            font-weight: 700 !important;
            color: #2C1810 !important;
            font-size: 0.95em !important;
        }
        
        .race-details {
            display: flex !important;
            justify-content: space-between !important;
            margin-top: 4px !important;
            font-size: 0.85em !important;
        }
        
        .race-count {
            color: #8B7314 !important;
            font-weight: 600 !important;
        }
        
        .race-status {
            color: #4A3728 !important;
            font-style: italic !important;
        }
        
        /* ç§‘æŠ€å¡ç‰‡ */
        .tech-card {
            background: rgba(90, 58, 107, 0.1) !important;
            border: 1px solid #5A3A6B !important;
            border-radius: 6px !important;
            padding: 8px !important;
            margin-bottom: 8px !important;
        }
        
        .tech-name {
            font-weight: 700 !important;
            color: #5A3A6B !important;
            font-size: 0.9em !important;
        }
        
        .tech-progress {
            margin: 5px 0 !important;
            background: #ddd !important;
            border-radius: 3px !important;
            height: 6px !important;
            overflow: hidden !important;
        }
        
        .tech-progress-bar {
            height: 100% !important;
            background: linear-gradient(90deg, #8A2BE2, #5A3A6B) !important;
            transition: width 0.5s !important;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .territory-panel {
                padding: 10px !important;
                min-height: 400px !important;
            }
            
            .territory-panel[open] {
                min-height: 600px !important;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr !important;
            }
            
            .data-row {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .data-value {
                text-align: left !important;
                margin-left: 0 !important;
                margin-top: 2px !important;
            }
        }
        
        /* å¼ºåˆ¶æ˜¾ç¤ºé‡è¦å†…å®¹ */
        .important-alert {
            background: linear-gradient(135deg, rgba(139, 58, 58, 0.2), rgba(255, 0, 0, 0.1)) !important;
            border: 2px solid #8B3A3A !important;
            border-radius: 8px !important;
            padding: 10px !important;
            margin: 10px 0 !important;
            font-weight: 700 !important;
            color: #8B3A3A !important;
            text-align: center !important;
            animation: pulse 2s infinite !important;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div class="territory-panel" id="territoryPanel">
        <div class="panel-header" onclick="togglePanel()">
            <div class="panel-title">
                <span class="panel-icon">ğŸ°</span>
                <span>é¢†åœ°çŠ¶æ€é¢æ¿</span>
                <span class="territory-name" id="territoryName">åŠ è½½ä¸­...</span>
            </div>
            <span class="toggle-arrow" id="panelArrow">â–¼</span>
        </div>
        
        <div class="panel-body" id="panelBody">
            <!-- çŠ¶æ€ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            <div id="statusContent">
                æ­£åœ¨åŠ è½½é¢†åœ°æ•°æ®...
            </div>
        </div>
    </div>

    <script>
        // ç­‰å¾…SillyTavernç¯å¢ƒå®Œå…¨åŠ è½½
        setTimeout(() => {
            initializeTerritoryPanel();
            // å¼ºåˆ¶è®¾ç½®é¢æ¿é«˜åº¦
            adjustPanelHeight();
        }, 1000);
        
        // ç›‘å¬å†…å®¹å˜åŒ–
        const observer = new MutationObserver(() => {
            setTimeout(adjustPanelHeight, 100);
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        function togglePanel() {
            const panel = document.getElementById('territoryPanel');
            const arrow = document.getElementById('panelArrow');
            const body = document.getElementById('panelBody');
            
            if (panel.getAttribute('open') === 'true') {
                panel.removeAttribute('open');
                arrow.textContent = 'â–¼';
                body.style.display = 'none';
                panel.style.minHeight = '60px';
            } else {
                panel.setAttribute('open', 'true');
                arrow.textContent = 'â–²';
                body.style.display = 'block';
                adjustPanelHeight();
            }
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.querySelector(`[data-section="${sectionId}"] .section-arrow`);
            
            if (section.classList.contains('expanded')) {
                section.classList.remove('expanded');
                arrow.textContent = 'â–¶';
            } else {
                section.classList.add('expanded');
                arrow.textContent = 'â–¼';
                // ç¡®ä¿å†…å®¹é«˜åº¦æ­£ç¡®
                setTimeout(adjustPanelHeight, 10);
            }
        }
        
        function initializeTerritoryPanel() {
            // æŸ¥æ‰¾æœ€æ–°çš„é¢†åœ°çŠ¶æ€æ¶ˆæ¯
            const messages = document.querySelectorAll('.mes_text, .message, [class*="message"]');
            let latestStatus = null;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                const text = messages[i].textContent || messages[i].innerText;
                if (text.includes('<territory_status>')) {
                    latestStatus = text;
                    break;
                }
            }
            
            if (latestStatus) {
                parseTerritoryStatus(latestStatus);
            } else {
                document.getElementById('statusContent').innerHTML = 
                    '<div class="important-alert">æœªæ‰¾åˆ°é¢†åœ°çŠ¶æ€æ•°æ®</div>';
            }
            
            adjustPanelHeight();
        }
        
        function parseTerritoryStatus(statusText) {
            try {
                // æå–çŠ¶æ€é¢æ¿å†…å®¹
                const start = statusText.indexOf('<territory_status>');
                const end = statusText.indexOf('</territory_status>');
                
                if (start === -1 || end === -1) {
                    throw new Error('æ— æ•ˆçš„çŠ¶æ€æ ¼å¼');
                }
                
                const content = statusText.substring(start + 18, end).trim();
                const lines = content.split('\n').filter(line => line.trim());
                
                // åˆ†ç»„è§£æ
                let currentSection = '';
                let sections = {};
                
                for (const line of lines) {
                    if (line.startsWith('===')) {
                        currentSection = line.replace(/=/g, '').trim();
                        sections[currentSection] = [];
                    } else if (line.startsWith('[') && line.includes('|')) {
                        if (currentSection) {
                            const match = line.match(/\[([^\]]+)\|([^\]]*)\]/);
                            if (match) {
                                sections[currentSection].push({
                                    label: match[1].trim(),
                                    value: match[2].trim()
                                });
                            }
                        }
                    }
                }
                
                // ç”ŸæˆHTML
                generateStatusHTML(sections);
                
            } catch (error) {
                console.error('è§£æé¢†åœ°çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('statusContent').innerHTML = 
                    `<div class="important-alert">è§£æé”™è¯¯: ${error.message}</div>`;
            }
        }
        
        function generateStatusHTML(sections) {
            let html = '';
            const sectionOrder = [
                'é¢†åœ°åŸºç¡€ä¿¡æ¯',
                'äººå£ä¸ç§æ—æ„æˆ', 
                'ç»æµä¸è´¢æ”¿',
                'ä»“åº“ç‰©èµ„å‚¨å¤‡',
                'èµ„æºä¸ç¯å¢ƒ',
                'å†›äº‹ä¸é˜²å¾¡',
                'å±…æ°‘ä¸ç¤¾ä¼šçŠ¶æ€',
                'å¨èƒä¸å®‰å…¨',
                'ç§‘æŠ€ç ”å‘è¿›å±•',
                'å»ºç­‘è®¾æ–½',
                'ç”Ÿäº§ä¸ä¾›åº”é“¾',
                'æ³•ä»¤ä¸æ”¿ç­–',
                'é¢†ä¸»ä¿¡æ¯'
            ];
            
            sectionOrder.forEach(sectionName => {
                if (sections[sectionName]) {
                    const sectionId = sectionName.replace(/\s+/g, '-');
                    const icon = getSectionIcon(sectionName);
                    
                    html += `
                        <div class="collapse-section">
                            <div class="section-header" onclick="toggleSection('${sectionId}')" data-section="${sectionId}">
                                <div class="section-title">
                                    <span class="section-icon">${icon}</span>
                                    <span>${sectionName}</span>
                                </div>
                                <span class="section-arrow">â–¶</span>
                            </div>
                            <div class="section-content" id="${sectionId}">
                                ${generateSectionContent(sectionName, sections[sectionName])}
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('statusContent').innerHTML = html;
            
            // æ›´æ–°é¢†åœ°åç§°
            if (sections['é¢†åœ°åŸºç¡€ä¿¡æ¯']) {
                const nameInfo = sections['é¢†åœ°åŸºç¡€ä¿¡æ¯'].find(item => item.label.includes('åç§°'));
                if (nameInfo) {
                    document.getElementById('territoryName').textContent = nameInfo.value;
                }
            }
            
            // è‡ªåŠ¨å±•å¼€é‡è¦éƒ¨åˆ†
            setTimeout(() => {
                ['é¢†åœ°åŸºç¡€ä¿¡æ¯', 'ç»æµä¸è´¢æ”¿', 'å†›äº‹ä¸é˜²å¾¡'].forEach(sectionName => {
                    const sectionId = sectionName.replace(/\s+/g, '-');
                    toggleSection(sectionId);
                });
            }, 100);
        }
        
        function generateSectionContent(sectionName, items) {
            let content = '';
            
            if (sectionName === 'äººå£ä¸ç§æ—æ„æˆ') {
                // ç‰¹æ®Šå¤„ç†ç§æ—æ˜¾ç¤º
                const raceItem = items.find(item => item.label.includes('ç§æ—æ„æˆ'));
                if (raceItem) {
                    content += '<div style="margin-bottom: 15px;">';
                    const races = raceItem.value.split('|').filter(r => r.trim());
                    races.forEach(race => {
                        const [name, details] = race.split(':');
                        if (name && details) {
                            content += `
                                <div class="race-card">
                                    <div class="race-name">${name}</div>
                                    <div class="race-details">
                                        <span class="race-count">${details}</span>
                                        <span class="race-status">${getRaceStatus(details)}</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    content += '</div>';
                }
                
                // å…¶ä»–äººå£ä¿¡æ¯
                items.filter(item => !item.label.includes('ç§æ—æ„æˆ')).forEach(item => {
                    content += `
                        <div class="data-row">
                            <span class="data-label">${item.label}</span>
                            <span class="data-value ${getValueClass(item.value)}">${item.value}</span>
                        </div>
                    `;
                });
                
            } else if (sectionName === 'ç§‘æŠ€ç ”å‘è¿›å±•') {
                // ç‰¹æ®Šå¤„ç†ç§‘æŠ€æ˜¾ç¤º
                items.forEach(item => {
                    if (item.label.includes('ç ”å‘ä¸­')) {
                        const techs = item.value.split('|').filter(t => t.trim());
                        techs.forEach(tech => {
                            const match = tech.match(/(.+?)\((\d+)%\)/);
                            if (match) {
                                content += `
                                    <div class="tech-card">
                                        <div class="tech-name">${match[1].trim()}</div>
                                        <div class="tech-progress">
                                            <div class="tech-progress-bar" style="width: ${match[2]}%"></div>
                                        </div>
                                        <div style="text-align: right; font-size: 0.8em; color: #5A3A6B;">
                                            è¿›åº¦: ${match[2]}%
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        content += `
                            <div class="data-row">
                                <span class="data-label">${item.label}</span>
                                <span class="data-value ${getValueClass(item.value)}">${item.value}</span>
                            </div>
                        `;
                    }
                });
                
            } else {
                // é»˜è®¤æ˜¾ç¤ºæ–¹å¼
                items.forEach(item => {
                    content += `
                        <div class="data-row">
                            <span class="data-label">${item.label}</span>
                            <span class="data-value ${getValueClass(item.value)}">${item.value}</span>
                        </div>
                    `;
                });
            }
            
            return content;
        }
        
        function getSectionIcon(sectionName) {
            const icons = {
                'é¢†åœ°åŸºç¡€ä¿¡æ¯': 'ğŸ°',
                'äººå£ä¸ç§æ—æ„æˆ': 'ğŸ‘¥',
                'ç»æµä¸è´¢æ”¿': 'ğŸ’°',
                'ä»“åº“ç‰©èµ„å‚¨å¤‡': 'ğŸª',
                'èµ„æºä¸ç¯å¢ƒ': 'ğŸŒ³',
                'å†›äº‹ä¸é˜²å¾¡': 'âš”ï¸',
                'å±…æ°‘ä¸ç¤¾ä¼šçŠ¶æ€': 'ğŸ ',
                'å¨èƒä¸å®‰å…¨': 'âš ï¸',
                'ç§‘æŠ€ç ”å‘è¿›å±•': 'ğŸ”¬',
                'å»ºç­‘è®¾æ–½': 'ğŸ›ï¸',
                'ç”Ÿäº§ä¸ä¾›åº”é“¾': 'âš™ï¸',
                'æ³•ä»¤ä¸æ”¿ç­–': 'ğŸ“œ',
                'é¢†ä¸»ä¿¡æ¯': 'ğŸ‘‘'
            };
            return icons[sectionName] || 'ğŸ“‹';
        }
        
        function getValueClass(value) {
            if (!value) return '';
            
            if (value.includes('ğŸ“ˆ') || value.includes('ç›ˆä½™') || value.includes('å……è¶³') || 
                value.includes('è‰¯å¥½') || value.includes('å®‰å…¨')) {
                return 'value-positive';
            }
            
            if (value.includes('ğŸ“‰') || value.includes('äºæŸ') || value.includes('ä¸è¶³') ||
                value.includes('å±é™©') || value.includes('æå±')) {
                return 'value-negative';
            }
            
            if (value.includes('é‡‘å¸') || value.includes('é‡‘') || /\d+é‡‘/.test(value)) {
                return 'value-gold';
            }
            
            if (value.includes('ç ”å‘') || value.includes('ç§‘æŠ€')) {
                return 'value-purple';
            }
            
            return '';
        }
        
        function getRaceStatus(details) {
            if (details.includes('ä¸»å¯¼')) return 'ç»Ÿæ²»é˜¶å±‚';
            if (details.includes('å¹³ç­‰')) return 'å…¬æ°‘';
            if (details.includes('å—é™åˆ¶')) return 'é™åˆ¶å±…ä½';
            if (details.includes('å¥´éš¶')) return 'å¥´å½¹çŠ¶æ€';
            return '';
        }
        
        function adjustPanelHeight() {
            const panel = document.getElementById('territoryPanel');
            const body = document.getElementById('panelBody');
            const content = document.getElementById('statusContent');
            
            if (!panel || !body || !content) return;
            
            // è®¡ç®—å†…å®¹é«˜åº¦
            const contentHeight = content.scrollHeight;
            
            if (panel.getAttribute('open') === 'true') {
                // å±•å¼€çŠ¶æ€ï¼šå†…å®¹é«˜åº¦ + å¤´éƒ¨é«˜åº¦ + å†…è¾¹è·
                const totalHeight = contentHeight + 100;
                panel.style.height = Math.min(totalHeight, window.innerHeight * 0.8) + 'px';
                body.style.maxHeight = (totalHeight - 60) + 'px';
                body.style.overflowY = 'auto';
            } else {
                // æŠ˜å çŠ¶æ€ï¼šä»…å¤´éƒ¨é«˜åº¦
                panel.style.height = '60px';
                panel.style.minHeight = '60px';
            }
            
            // å¼ºåˆ¶é‡ç»˜
            panel.style.display = 'none';
            panel.offsetHeight;
            panel.style.display = 'block';
        }
        
        // åˆå§‹åŒ–å’Œå®šæœŸè°ƒæ•´
        window.addEventListener('load', () => {
            setTimeout(initializeTerritoryPanel, 500);
            setTimeout(adjustPanelHeight, 1000);
        });
        
        // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡é«˜åº¦
        setInterval(adjustPanelHeight, 5000);
        
        // å¯¼å‡ºå‡½æ•°ä¾›SillyTavernè°ƒç”¨
        window.updateTerritoryStatus = function(statusText) {
            parseTerritoryStatus(statusText);
            adjustPanelHeight();
        };
    </script>
</body>
</html>
