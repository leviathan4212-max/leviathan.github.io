// ä»MVUè·å–æ•°æ® - ç®€åŒ–ç‰ˆ
async function fetchFromMVU() {
    try {
        showLoading(true);
        console.log('å¼€å§‹ä»MVUè·å–æ•°æ®...');
        
        let mvuData = null;
        
        // æ–¹æ³•1ï¼šä½¿ç”¨getVariablesï¼ˆå‚è€ƒå¯ç”¨çš„è§’è‰²å¡å‰ç«¯ï¼‰
        if (typeof getVariables === 'function') {
            console.log('ä½¿ç”¨ getVariables()');
            try {
                mvuData = getVariables({
                    type: 'message',
                    message_id: getCurrentMessageId?.() || 'current'
                });
                console.log('getVariables è¿”å›:', mvuData);
            } catch (e) {
                console.error('getVariables é”™è¯¯:', e);
            }
        }
        
        // æ–¹æ³•2ï¼šå°è¯•window.getVariables
        if (!mvuData && typeof window.getVariables === 'function') {
            console.log('ä½¿ç”¨ window.getVariables()');
            try {
                mvuData = await window.getVariables({
                    type: 'message',
                    message_id: window.getCurrentMessageId?.() || 'current'
                });
            } catch (e) {
                console.error('window.getVariables é”™è¯¯:', e);
            }
        }
        
        // ä»stat_dataä¸­æå–Territoryæ•°æ®
        if (mvuData) {
            console.log('åŸå§‹MVUæ•°æ®é”®:', Object.keys(mvuData));
            
            // å…³é”®ï¼šæ£€æŸ¥stat_dataæ˜¯å¦å­˜åœ¨
            if (mvuData.stat_data) {
                console.log('æ‰¾åˆ° stat_data');
                
                // æ£€æŸ¥Territoryæ˜¯å¦å­˜åœ¨
                if (mvuData.stat_data.Territory) {
                    console.log('æ‰¾åˆ° Territory æ•°æ®');
                    territoryData = convertMVUData(mvuData.stat_data.Territory);
                } else {
                    console.warn('stat_data ä¸­æ²¡æœ‰ Territory æ•°æ®');
                    // å°è¯•ä½¿ç”¨stat_dataæœ¬èº«
                    territoryData = convertMVUData(mvuData.stat_data);
                }
            } else if (mvuData.Territory) {
                // å¦‚æœæ²¡æœ‰stat_dataï¼Œç›´æ¥å°è¯•Territory
                console.log('ç›´æ¥æ‰¾åˆ° Territory æ•°æ®');
                territoryData = convertMVUData(mvuData.Territory);
            } else {
                console.warn('MVUæ•°æ®ä¸­æ²¡æœ‰æ‰¾åˆ°é¢†åœ°æ•°æ®');
                territoryData = getDefaultData();
            }
        } else {
            console.log('æ— æ³•ä»MVUè·å–æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜æˆ–é»˜è®¤æ•°æ®');
            const storedData = localStorage.getItem('territoryData');
            if (storedData) {
                territoryData = JSON.parse(storedData);
                console.log('ä½¿ç”¨localStorageç¼“å­˜æ•°æ®');
            } else {
                territoryData = getDefaultData();
                console.log('ä½¿ç”¨é»˜è®¤æ•°æ®');
            }
        }
        
        // éªŒè¯æ•°æ®
        if (!territoryData || !territoryData.äººå£) {
            console.warn('é¢†åœ°æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
            territoryData = getDefaultData();
        }
        
        console.log('æœ€ç»ˆé¢†åœ°æ•°æ®:', territoryData);
        console.log('äººå£:', territoryData.äººå£?.æ€»äººå£);
        console.log('ç»æµ:', territoryData.ç»æµ?.è´¢æ”¿?.åº“å­˜é‡‘å¸);
        
        lastUpdate = new Date();
        document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
        
        updateUI();
        localStorage.setItem('territoryData', JSON.stringify(territoryData));
        
    } catch (error) {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
        territoryData = getDefaultData();
        updateUI();
    } finally {
        showLoading(false);
        adjustIframeHeight();
    }
}

// è½¬æ¢MVUæ•°æ®æ ¼å¼ï¼ˆä»æ•°ç»„æ ¼å¼è½¬æ¢ä¸ºç®€å•å€¼ï¼‰
function convertMVUData(data) {
    if (!data) return {};
    
    const result = {};
    
    for (const [key, value] of Object.entries(data)) {
        // è·³è¿‡$metaå±æ€§
        if (key === '$meta') continue;
        
        if (Array.isArray(value)) {
            // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
            result[key] = value[0];
        } else if (typeof value === 'object' && value !== null) {
            // å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€’å½’å¤„ç†
            if (value.$meta && value.$meta.extensible === true) {
                // å¯¹äºå¯æ‰©å±•å¯¹è±¡ï¼Œè·³è¿‡æ¨¡æ¿
                continue;
            }
            result[key] = convertMVUData(value);
        } else {
            // å…¶ä»–æƒ…å†µç›´æ¥èµ‹å€¼
            result[key] = value;
        }
    }
    
    return result;
}

// è·å–é»˜è®¤æ•°æ®ï¼ˆä½¿ç”¨ç®€å•å€¼ï¼Œè€Œä¸æ˜¯æ•°ç»„ï¼‰
function getDefaultData() {
    return {
        åŸºæœ¬ä¿¡æ¯: {
            åç§°: "åŒ—å¢ƒè¾¹å¢ƒé¢†",
            é¢ç§¯: 85,
            åœ°å½¢: "ä¸˜é™µä¸æ£®æ—",
            å‘å±•é˜¶æ®µ: "åˆå»º"
        },
        äººå£: {
            æ€»äººå£: 1250,
            ç§æ—æ„æˆ: {
                äººç±»: { æ•°é‡: 900, åœ°ä½: "ä¸»å¯¼", ç‰¹æ®Šèƒ½åŠ›: "é€‚åº”æ€§å¼ºï¼Œå­¦ä¹ èƒ½åŠ›å¿«" },
                çŸ®äºº: { æ•°é‡: 150, åœ°ä½: "å¹³ç­‰", ç‰¹æ®Šèƒ½åŠ›: "åœ°ä¸‹è§†è§‰ï¼Œé”»é€ ä¸çŸ³å·¥ä¸“ç²¾" },
                åŠç²¾çµ: { æ•°é‡: 100, åœ°ä½: "å¹³ç­‰", ç‰¹æ®Šèƒ½åŠ›: "è‡ªç„¶äº²å’Œï¼Œå¼“ç®­ä¸è¿½è¸ªä¸“ç²¾" },
                å“¥å¸ƒæ—: { æ•°é‡: 50, åœ°ä½: "å¥´éš¶", ç‰¹æ®Šèƒ½åŠ›: "å¤œè§†ï¼Œæ•æ·ï¼Œå°å‹å·¥ç¨‹" }
            },
            èŒä¸šåˆ†å¸ƒ: {
                å†œæ°‘: { äººæ•°: 700, æœˆè´¡çŒ®: 15, å¹³å‡è–ªèµ„: 2, æ»¡æ„åº¦: 65 },
                å·¥åŒ : { äººæ•°: 120, æœˆè´¡çŒ®: 25, å¹³å‡è–ªèµ„: 5, æ»¡æ„åº¦: 70 },
                å•†äºº: { äººæ•°: 60, æœˆè´¡çŒ®: 30, å¹³å‡è–ªèµ„: 8, æ»¡æ„åº¦: 75 },
                å®˜å‘˜: { äººæ•°: 15, æœˆè´¡çŒ®: -10, å¹³å‡è–ªèµ„: 10, æ»¡æ„åº¦: 80 },
                å£«å…µ: { äººæ•°: 80, æœˆè´¡çŒ®: -20, å¹³å‡è–ªèµ„: 6, æ»¡æ„åº¦: 70 },
                å­¦è€…: { äººæ•°: 10, æœˆè´¡çŒ®: 5, å¹³å‡è–ªèµ„: 7, æ»¡æ„åº¦: 85 },
                æ— ä¸š: { äººæ•°: 265, æœˆè´¡çŒ®: 0, å¹³å‡è–ªèµ„: 0, æ»¡æ„åº¦: 40 }
            },
            äººå£å¢é•¿ç‡: 0.008,
            ç§»æ°‘ç‡: 0.002
        },
        ç»æµ: {
            è´¢æ”¿: {
                åº“å­˜é‡‘å¸: 2500,
                æœˆæ€»æ”¶å…¥: 1850,
                æœˆæ€»æ”¯å‡º: 1670,
                æœˆå‡€æ”¶å…¥: 180,
                æ”¶æ”¯çŠ¶æ€: "ğŸ“ˆç›ˆä½™"
            },
            å…¬å…±ç¨ç‡: {
                å†œä¸šç¨: 0.10,
                å•†ä¸šç¨: 0.15,
                å·¥ä¸šç¨: 0.12,
                ä¸ªäººæ‰€å¾—ç¨: 0.05
            },
            ç‰©ä»·æŒ‡æ•°: {
                ç²®é£Ÿå•ä»·: 0.4,
                æœ¨æå•ä»·: 1.8,
                çŸ³æå•ä»·: 2.5,
                é“çŸ¿å•ä»·: 3.0,
                æ­¦å™¨å•ä»·: 15,
                å·¥å…·å•ä»·: 8
            },
            ç»æµæŒ‡æ ‡: {
                GDP: 25000,
                äººå‡GDP: 20,
                é€šè´§è†¨èƒ€ç‡: 0.02,
                å¤±ä¸šç‡: 0.212,
                è´¸æ˜“é¡ºå·®: 300
            }
        },
        ä»“åº“: {
            res_food_grain: {
                åç§°: "ç²®é£Ÿ",
                å½“å‰å‚¨é‡: 6500,
                å®‰å…¨å‚¨é‡: 3750,
                å•ä½: "æ‹…",
                å¸‚åœºä»·æ ¼: 0.4
            },
            res_material_wood: {
                åç§°: "æœ¨æ",
                å½“å‰å‚¨é‡: 900,
                å®‰å…¨å‚¨é‡: 300,
                å•ä½: "æ–¹",
                å¸‚åœºä»·æ ¼: 1.8
            },
            res_material_stone: {
                åç§°: "çŸ³æ",
                å½“å‰å‚¨é‡: 500,
                å®‰å…¨å‚¨é‡: 200,
                å•ä½: "æ–¹",
                å¸‚åœºä»·æ ¼: 2.5
            },
            res_material_iron: {
                åç§°: "é“çŸ¿",
                å½“å‰å‚¨é‡: 300,
                å®‰å…¨å‚¨é‡: 100,
                å•ä½: "æ–¤",
                å¸‚åœºä»·æ ¼: 3.0
            }
        },
        èµ„æºåŠ¨æ€: {
            æ£®æ—: {
                å½“å‰å‚¨é‡: 12000,
                æ¯æœˆå†ç”Ÿé‡: 100,
                æ¯æœˆå¼€é‡‡é‡: 150,
                ç”Ÿæ€å¥åº·åº¦: 0.8,
                å¯æŒç»­å¼€é‡‡é‡: 80
            },
            é“çŸ¿è„‰: {
                å½“å‰å‚¨é‡: 5000,
                æ¯æœˆå¼€é‡‡é‡: 50,
                å¼€é‡‡éš¾åº¦: 0.6,
                çŸ¿çŸ³å“è´¨: 0.7,
                é¢„ä¼°æ¯ç«­æ—¶é—´: 100
            },
            çŸ³çŸ¿: {
                å½“å‰å‚¨é‡: 8000,
                æ¯æœˆå¼€é‡‡é‡: 40,
                å¼€é‡‡éš¾åº¦: 0.5,
                çŸ¿çŸ³å“è´¨: 0.8,
                é¢„ä¼°æ¯ç«­æ—¶é—´: 200
            }
        },
        å†›äº‹: {
            å…µåŠ›: {
                å¸¸å¤‡å†›: 80,
                æ°‘å…µ: 200,
                ç²¾é”éƒ¨é˜Ÿ: 0
            },
            æˆ˜åŠ›è¯„çº§: {
                æ€»è¯„çº§: "D",
                é¢†ä¸»æˆ˜åŠ›: "B",
                å†›é˜Ÿæˆ˜åŠ›: "E",
                é˜²å¾¡è¯„çº§: "D+"
            },
            è£…å¤‡çŠ¶æ€: {
                è£…å¤‡å®Œæ•´ç‡: 0.65,
                è®­ç»ƒæ°´å¹³: 0.5,
                å£«æ°”: 70
            },
            é˜²å¾¡è®¾æ–½: {
                åŸå¢™å®Œæ•´åº¦: 0.7,
                ç­æœ›å¡”æ•°é‡: 2,
                åŸé—¨çŠ¶æ€: "å®Œå¥½",
                æŠ¤åŸæ²³: "æ— "
            }
        },
        çŠ¶æ€: {
            å±…æ°‘çŠ¶æ€: {
                ç”Ÿæ´»æ°´å¹³: "æ¸©é¥±",
                æ²»å®‰çŠ¶å†µ: 65,
                æ°‘å¿ƒæŒ‡æ•°: 70,
                å½“å‰äº‹ä»¶: "æš‚æ— "
            },
            å¨èƒçŠ¶æ€: {
                å¨èƒç­‰çº§: "è­¦æˆ’",
                ä¸»è¦é­”ç‰©: "å“¥å¸ƒæ—å›¢ä¼™",
                é¢„è®¡ä¸‹æ¬¡è¢­å‡»: "1-3ä¸ªæœˆå†…"
            }
        },
        ç¯å¢ƒ: {
            å­£èŠ‚å½±å“: {
                å†œä¸šäº§å‡ºä¿®æ­£: 1.2,
                å•†ä¸šæ´»åŠ¨ä¿®æ­£: 1.0,
                èµ„æºé‡‡é›†ä¿®æ­£: 1.1
            },
            å¤©æ°”çŠ¶å†µ: "æ™´æœ—",
            è‡ªç„¶ç¾å®³é£é™©: 0.1,
            æ¸©åº¦: 15,
            é™æ°´: "é€‚ä¸­"
        },
        å»ºç­‘: {
            building_blacksmith: {
                åç§°: "é“åŒ é“º",
                ç±»å‹: "ç”Ÿäº§",
                äº§æƒ: "private",
                ç­‰çº§: 1,
                çŠ¶æ€: "æ­£å¸¸è¿è¥",
                å²—ä½: {
                    å½“å‰äººæ•°: 4,
                    æœ€å¤§äººæ•°: 8,
                    æœˆè–ª: 4
                },
                è´¢åŠ¡: {
                    è®¡ç®—_æœˆæ”¶å…¥: 120,
                    è®¡ç®—_æœˆæ”¯å‡º: 46,
                    è®¡ç®—_å‡€æ”¶ç›Š: 74
                }
            },
            building_market: {
                åç§°: "ä¸­å¿ƒå¸‚åœº",
                ç±»å‹: "å•†ä¸š",
                äº§æƒ: "lord",
                ç­‰çº§: 2,
                çŠ¶æ€: "æ­£å¸¸è¿è¥",
                å²—ä½: {
                    å½“å‰äººæ•°: 25,
                    æœ€å¤§äººæ•°: 40,
                    æœˆè–ª: 3
                },
                è´¢åŠ¡: {
                    è®¡ç®—_æœˆæ”¶å…¥: 400,
                    è®¡ç®—_æœˆæ”¯å‡º: 135,
                    è®¡ç®—_å‡€æ”¶ç›Š: 265
                }
            }
        },
        ç§‘æŠ€: {
            tech_basic_agriculture: {
                åç§°: "åŸºç¡€å†œä¸šæŠ€æœ¯",
                ç ”å‘çŠ¶æ€: "å·²ç ”å‘",
                å½“å‰è¿›åº¦: 100
            },
            tech_iron_smelting: {
                åç§°: "é“å™¨å†¶ç‚¼æŠ€æœ¯",
                ç ”å‘çŠ¶æ€: "ç ”å‘ä¸­",
                å½“å‰è¿›åº¦: 45
            },
            tech_basic_military_tactics: {
                åç§°: "åŸºç¡€å†›äº‹æˆ˜æœ¯",
                ç ”å‘çŠ¶æ€: "æœªç ”å‘",
                å½“å‰è¿›åº¦: 0
            }
        },
        System: {
            å½“å‰æ¸¸æˆæ—¶é—´: "ç¬¬1å¹´ 1æœˆ",
            å½“å‰å­£èŠ‚: "æ˜¥å­£",
            ä¸Šæ¬¡ç»“ç®—æ—¶é—´: "ç¬¬1å¹´ 1æœˆ",
            è‡ªåŠ¨ç»“ç®—å¼€å…³: false
        },
        Character: {
            é¢†ä¸»: {
                å§“å: "è‰¾ä¸¹",
                ç§°å·: "è¾¹å¢ƒå®ˆæŠ¤è€…",
                ä¸ªäººæˆ˜åŠ›: "B",
                ç®¡ç†èƒ½åŠ›: 65,
                å†›äº‹èƒ½åŠ›: 70,
                å¤–äº¤èƒ½åŠ›: 55,
                çŸ¥è¯†æ°´å¹³: 60
            }
        }
    };
}

// ä¿®å¤formatNumberå‡½æ•°ï¼Œé˜²æ­¢NaN
function formatNumber(num) {
    if (num === undefined || num === null || isNaN(num)) {
        return '0';
    }
    return Number(num).toLocaleString();
}
